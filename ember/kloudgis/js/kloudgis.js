/*
 Copyright (c) 2010-2011, XYZ Civitas
 Kloudgis.
 http://kloudgis.com
*/
Handlebars.registerHelper("loc",function(a,b){var c=a.loc();if(b.hash.id){var d=b.hash.tagName||"span";return new Handlebars.SafeString("<"+d+' id="'+b.hash.id+'">'+c+"</"+d+">")}if(b.hash.class){var d=b.hash.tagName||"span";return new Handlebars.SafeString("<"+d+' class="'+b.hash.class+'">'+c+"</"+d+">")}if(b.hash.tagName){var d=b.hash.tagName;return new Handlebars.SafeString("<"+d+">"+c+"</"+d+">")}return c}),Handlebars.registerHelper("highlight",function(a){var b=SC.getPath(this,a);return new Handlebars.SafeString('<span class="highlight">'+b+"</span>")}),$.extend({getQueryString:function(a){function b(){var a={},b,c=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f=window.location.search.substring(1);while(b=d.exec(f))a[e(b[1])]=e(b[2]);return a}return this.queryStringParams||(this.queryStringParams=b()),this.queryStringParams[a]}}),jQuery.extend(jQuery.browser,{isIphone:navigator.userAgent.toLowerCase().indexOf("iphone")>0}),KG=Ember.Application.create({lang:"fr",activeSandboxKey:null,serverHost:"/",debugMode:YES,enableLogger:function(){if(!this._oldLogger)return;window.console.log=this._oldLogger},_oldLogger:null,disableLogger:function(){this._oldLogger=window.console.log,window.console.log=function(){}}}),KG.get("debugMode")||KG.disableLogger(),$(document).ready(function(){KG.statechart.initStatechart()}),KG.HomeState=SC.State.extend({initialSubstate:"listSandboxState",enterState:function(){console.log("home!");var a=YES,b=window.location.hash;if(b&&b.length>0){var c=b.split(";");if(c.length>0){var d=c[0];if(d&&d.charAt(1)==="s"&&d.charAt(2)==="b"){var e=d.substring(4);e&&e.length>0&&(KG.set("activeSandboxKey",e),this.gotoState("sandboxState"),a=NO)}}}a&&KG.core_home.loadSandboxList()},exitState:function(){},listSandboxState:SC.State.extend({initialSubstate:"selectSandboxState",enterState:function(){KG.homePanelController.setListSandboxActive()},createSandboxAction:function(){this.gotoState("createSandboxState")},selectSandboxState:SC.State.extend({enterState:function(){},exitState:function(){},openSandboxAction:function(a){KG.set("activeSandboxKey",a),this.gotoState("sandboxState")},toggleDeleteSandboxModeAction:function(){this.gotoState("deleteSandboxState")}}),deleteSandboxState:SC.State.extend({enterState:function(){KG.homePanelController.set("deleteMode",YES)},exitState:function(){KG.homePanelController.set("deleteMode",NO),KG.deleteController.set("content",[])},toggleDeleteSandboxModeAction:function(){this.gotoState("selectSandboxState")},deleteSandboxAction:function(){console.log("delete selected sandboxes");var a=KG.deleteController.get("content");a.forEach(function(a){a.destroy()}),KG.store.commitRecords(),this.gotoState("selectSandboxState")},checkSandboxAction:function(a){console.log("add to delete sandbox"),a&&(KG.deleteController.indexOf(a)>-1?KG.deleteController.removeObject(a):KG.deleteController.pushObject(a))}})}),createSandboxState:SC.State.extend({enterState:function(){console.log("Enter create sandbox state!"),KG.homePanelController.set("createSandboxInProgress",NO),KG.core_home.get("map").addToDocument(null,null,null,"add-sandbox-map"),KG.homePanelController.set("errorMessage",""),KG.homePanelController.setAddSandboxActive()},exitState:function(){KG.homePanelController.set("errorMessage",""),$("#add-sandbox-panel input").blur(),KG.addSandboxController.set("name","")},commitCreateAction:function(){var a=KG.getPath("addSandboxController.name");if(!Ember.none(a)&&a.length>0){var b=SC.Query.local(KG.Sandbox,{conditions:"name='%@'".fmt(a)}),c=KG.store.find(b);if(c.get("length")>0)console.log("sb name already in use"),KG.homePanelController.set("errorMessage","_nameAlreadyTaken".loc());else{KG.homePanelController.set("createSandboxInProgress",YES);var d=KG.core_home.get("map").getCenter(),e=KG.store.createRecord(KG.Sandbox,{name:a,lon:d.get("lon"),lat:d.get("lat"),zoom:KG.core_home.get("map").getZoom()});KG.store.commitRecords(),e.onReady(null,function(){KG.statechart.sendAction("sandboxCreateSuccess"),KG.homePanelController.set("createSandboxInProgress",NO)}),e.onError(null,function(){e.destroy(),KG.statechart.sendAction("sandboxCreateError"),KG.homePanelController.set("createSandboxInProgress",NO)})}}else console.log("empty sb name")},sandboxCreateSuccess:function(){this.gotoState("selectSandboxState")},sandboxCreateError:function(){console.log("error while commit")},httpError:function(a){a==400?KG.homePanelController.set("errorMessage","_requestError".loc()):KG.homePanelController.set("errorMessage","_serverError".loc())},cancelCreateAction:function(){var a=KG.addSandboxController.get("content");a&&a.destroy(),this.gotoState("selectSandboxState")}})}),KG.SandboxState=SC.State.extend({initialSubstate:"tryAuthenticateState",exitState:function(){window.location.hash=""},tryAuthenticateState:SC.State.extend({enterState:function(){setTimeout(function(){KG.core_sandbox.authenticate()},1)},authenticationSucceeded:function(){this.gotoState("tryMembershipState")},authenficationFailed:function(){this.gotoState("loggedOutState")}}),tryMembershipState:SC.State.extend({enterState:function(){KG.core_sandbox.addMap(),KG.core_sandbox.membershipCheck(),KG.core_sandbox.fetchSandboxMeta()},membershipSucceeded:function(){this.gotoState("runningState")},membershipFailed:function(){this.gotoState("homeState")}}),mapLoginSucceeded:function(){KG.core_layer.loadLayers(),KG.core_bookmark.loadBookmarks()},runningState:SC.State.extend({substatesAreConcurrent:YES,_featuretypes:null,_attrtypes:null,enterState:function(){KG.core_notification.listen(),this._featuretypes=KG.store.find(KG.FEATURETYPE_QUERY),this._attrtypes=KG.store.find(KG.ATTRTYPE_QUERY),KG.core_sandbox.setCenter(KG.core_leaflet.getCenter(),KG.core_leaflet.getZoom()),KG.core_inspector.createView(),KG.core_search.createView(),KG.core_palette.createView()},exitState:function(){this._featuretypes.destroy(),this._attrtypes.destroy(),KG.core_sandbox.cleanUp()},inspectorPaletteState:SC.State.extend({initialSubstate:"allHiddenState",selectFeatureInspectorAction:function(a){a&&a.get("isSelectable")&&a.get("isInspectorSelectable")&&(this.gotoState("inspectorVisibleState"),KG.core_inspector.selectFeature(a))},showPaletteAction:function(){this.gotoState("paletteVisibleState")},allHiddenState:SC.State.extend({}),inspectorVisibleState:SC.State.extend({enterState:function(){KG.inspectorController.set("active",YES),KG.featureCommentsController.set("commentsPanelVisible",YES)},exitState:function(){KG.inspectorController.set("active",NO),KG.core_inspector.commitModifications(),KG.core_inspector.removeHighlight(),KG.featureCommentsController.set("commentsPanelVisible",NO),KG.featureCommentsController.set("showing",NO),setTimeout(function(){KG.inspectorController.set("feature",null),KG.inspectorController.set("content",null)},500)},selectFeatureInspectorAction:function(a){a&&a.get("isSelectable")&&a.get("isInspectorSelectable")&&(KG.featureCommentsController.set("showing",NO),KG.core_inspector.selectFeature(a))},closeInspectorAction:function(){this.gotoState("allHiddenState")},cancelInspectorAction:function(){KG.core_inspector.rollbackModifications(),this.gotoState("allHiddenState")},showFeatureCommentsAction:function(){KG.featureCommentsController.get("showing")?KG.featureCommentsController.set("showing",NO):(KG.featureCommentsController.get("length")===0&&KG.core_inspector.fetchComments(),KG.featureCommentsController.set("showing",YES),setTimeout(function(){KG.core_sandbox.autosize("#feature-new-comment-area",{minHeight:0,extraSpace:45});if(KG.featureCommentsController.getPath("content.length")===0)var a=$("#feature-new-comment-area").focus()},1))},addFeatureCommentAction:function(){var a=KG.featureNewCommentController.get("content");SC.none(a)||(a=a.replace("\n",""),a.length>0&&KG.core_inspector.addComment(a)),KG.featureNewCommentController.set("content","")},featureCommentsReadyEvent:function(){setTimeout(function(){console.log("scroll to bottom");var a=$("#feature-comments-container");a[0]&&a.scrollTop(a[0].scrollHeight)},1)},toggleDeleteFeatureCommentButtonAction:function(a){KG.featureDeleteCommentController.get("content")===a?KG.featureDeleteCommentController.set("content",null):KG.featureDeleteCommentController.set("content",a)},deleteFeatureCommentButtonAction:function(a){KG.featureDeleteCommentController.get("content")==a&&(KG.core_inspector.deleteComment(a),KG.featureDeleteCommentController.set("content",null))},deleteFeatureInspectorAction:function(){KG.core_inspector.deleteFeature(),this.gotoState("allHiddenState")}}),paletteVisibleState:SC.State.extend({enterState:function(){KG.paletteController.set("active",YES);if(Ember.none(KG.paletteController.get("content"))){var a=SC.Query.local(KG.Featuretype,{conditions:"geometry_type != null"});KG.paletteController.set("content",KG.store.find(a))}},exitState:function(){KG.paletteController.set("active",NO),KG.paletteController.set("isDirty",NO),KG.core_palette.clearCreateFeature()},paletteMarkerDragEnded:function(a){this.gotoState("inspectorVisibleState"),KG.core_inspector.createFeature(a.paletteItem,a.lon,a.lat)},selectPaletteItemAction:function(a){KG.core_palette.createFeature(a)},closePaletteAction:function(){this.gotoState("allHiddenState")},cancelPaletteAction:function(){KG.core_palette.clearCreateFeature()},showPaletteAction:function(){this.gotoState("allHiddenState")}})}),interactionPopupState:SC.State.extend({initialSubstate:"noPopupState",toggleNotificationPopupAction:function(){this.gotoState("notificationPopupState")},toggleBookmarkPopupAction:function(){this.gotoState("bookmarkPopupState")},toggleUserOptionsPopupAction:function(){this.gotoState("userOptionsState")},noPopupState:SC.State.extend({}),userOptionsState:SC.State.extend({enterState:function(){KG.activeUserController.set("activePopup",YES)},exitState:function(){KG.activeUserController.set("activePopup",NO)},backHomeAction:function(){this.gotoState("homeState")},toggleUserOptionsPopupAction:function(){this.gotoState("noPopupState")}}),notificationPopupState:SC.State.extend({enterState:function(){KG.notificationsController.set("activePopup",YES)},exitState:function(){KG.notificationsController.set("activePopup",NO)},sendTextNotificationAction:function(){this.gotoState("sendNotificationState")},toggleNotificationPopupAction:function(){this.gotoState("noPopupState")},clearNotificationAction:function(){KG.notificationsController.set("content",[]),this.gotoState("noPopupState")}}),sendNotificationState:SC.State.extend({view:null,timeout:null,enterState:function(){KG.sendNotificationController.set("showing",YES),this.view=SC.View.create({templateName:"send-text-notification"}),this.view.appendTo("#main-sandbox-view"),KG.core_sandbox.autosize("#send-notification-panel textarea"),this.focusArea()},exitState:function(){KG.sendNotificationController.set("showing",NO),KG.core_sandbox.destroyAutosize("#send-notification-panel textarea"),this.view.destroy(),this.view=null,this.timeout&&(clearTimeout(this.timeout),this.timeout=null),KG.sendNotificationController.set("pendingMessage",null),KG.sendNotificationController.set("feedbackMessage",""),KG.sendNotificationController.set("content","")},focusArea:function(){setTimeout(function(){$("#send-notification-panel textarea").focus()},300)},sendNotificationButtonAction:function(){setTimeout(function(){$("#send-notification-panel textarea").data("AutoResizer").check()},305),this.sendNotificationAction(),this.focusArea()},sendNotificationAction:function(){var a=KG.sendNotificationController.get("content");if(a&&a.length>0){KG.sendNotificationController.set("content",""),this.timeout&&clearTimeout(this.timeout);var b=KG.Message.create({type:"text",user_descriptor:KG.core_sandbox.get("membership").user_descriptor,author:KG.core_auth.get("activeUser").user,content:{text:a},dateMillis:(new Date).getTime()});KG.sendNotificationController.set("pendingNotification",b);var c=KG.core_notification.postMessage(b);c?(KG.sendNotificationController.set("feedbackMessage",""),this.timeout=setTimeout(function(){KG.sendNotificationController.set("pendingNotification",null),KG.sendNotificationController.set("feedbackMessage","_timeoutSendMessage".loc())},1e4)):KG.sendNotificationController.set("feedbackMessage","_failedToSendMessage".loc())}},notificationSent:function(a){var b=KG.sendNotificationController.get("pendingNotification");a&&b&&SC.isEqual(a,b)&&(KG.sendNotificationController.set("pendingNotification",null),KG.sendNotificationController.set("feedbackMessage","_sendMessageSuccessful".loc()),this.timeout&&clearTimeout(this.timeout))},closeSendNotificationAction:function(){this.gotoState("noPopupState")}}),bookmarkPopupState:SC.State.extend({initialSubstate:"normalModeState",enterState:function(){KG.bookmarksController.set("activePopup",YES),KG.core_bookmark.refreshBookmarks()},exitState:function(){KG.bookmarksController.set("activePopup",NO)},toggleBookmarkPopupAction:function(){this.gotoState("noPopupState")},refreshBookmarkAction:function(){KG.core_bookmark.refreshBookmarks()},normalModeState:SC.State.extend({selectBookmarkAction:function(a){KG.core_bookmark.gotoBookmark(a),this.gotoState("noPopupState")},editBookmarkAction:function(){this.gotoState("editModeState")},addBookmarkAction:function(){this.gotoState("addModeState")}}),editModeState:SC.State.extend({enterState:function(){KG.bookmarksController.set("editMode",YES)},exitState:function(){KG.bookmarksController.set("editMode",NO),KG.bookmarksController.set("deleteList",[])},checkBookmarkAction:function(a){var b=KG.bookmarksController.get("deleteList");b.indexOf(a)>-1?b.removeObject(a):b.pushObject(a)},deleteBookmarkAction:function(){KG.core_bookmark.deleteSelectedBookmarks(),this.gotoState("normalModeState")},editBookmarkAction:function(){this.gotoState("normalModeState")},addBookmarkAction:function(){this.gotoState("addModeState")}}),addModeState:SC.State.extend({view:null,enterState:function(){this.view=SC.View.create({templateName:"add-bookmark"}),this.view.appendTo("#main-sandbox-view"),setTimeout(function(){$("#add-bookmark-panel input").focus()},300)},exitState:function(){this.view.destroy(),KG.addBookmarkController.set("content","")},addBookmarkAction:function(){var a=KG.addBookmarkController.get("content"),b=KG.core_leaflet.getCenter(),c=KG.core_leaflet.getZoom();KG.core_bookmark.addBookmark(a,b,c),this.gotoState("normalModeState")},closeAddBookmarkAction:function(){this.gotoState("noPopupState")},editBookmarkAction:function(){this.gotoState("editModeState")}})})}),mapInteractionState:SC.State.extend({initialSubstate:"navigationState",mapMovedAction:function(a,b){KG.core_note.refreshMarkers(),KG.core_sandbox.setCenter(a,b)},mapZoomedAction:function(a,b){KG.core_note.removeAllMarkers(),KG.core_note.refreshMarkers(),KG.core_sandbox.setCenter(a,b)},toogleSearchPopopAction:function(){this.gotoState("searchState")},clickMarkerAction:function(a){this.gotoState("navigationState"),KG.core_note.continueMarkerClicked(a)},httpError:function(a){a===401&&KG.core_sandbox.authenticate()},authenficationFailed:function(){window.location.href="/"},createNoteAction:function(){this.gotoState("locateNoteState")},clickOnMapAction:function(a){this._ignoreMouseClicked||(KG.core_sandbox.set("mousePosition",a),KG.core_info.findFeaturesAt(a))},mousePositionChanged:function(a){KG.core_sandbox.set("mousePosition",a)},featureInfoReady:function(){this.gotoState("popupFeatureInfoState")},clickMarkerAction:function(a){KG.core_note.continueMarkerClicked(a)},noteSelectedAction:function(a,b){KG.core_note.activateNote(a,b),this.gotoState("editNoteState")},multipleNotesSelectedAction:function(a,b){KG.core_note.activateMultipleNotes(a,b),this.gotoState("multipleNotesState")},navigationState:SC.State.extend({_ignoreMouseClicked:YES,enterState:function(){console.log("enter navigation state"),KG.core_note.refreshMarkers();var a=this;setTimeout(function(){a._ignoreMouseClicked=NO},100)},exitState:function(){this._ignoreMouseClicked=YES}}),searchState:SC.State.extend({_highlight:null,_hlMarker:null,enterState:function(){KG.searchController.set("activePopup",YES),$("#search-popup input").focus()},exitState:function(){KG.searchController.set("activePopup",NO),KG.searchController.set("searchValue",""),KG.core_search.hideResults(),KG.core_highlight.clearHighlight(this._highlight),this._highlight=null,KG.core_highlight.clearHighlightMarker(this._hlMarker),this._hlMarker=null},toogleSearchPopopAction:function(){this.gotoState("navigationState")},searchAction:function(){KG.core_search.searchFeatures()},clearSearchAction:function(){KG.core_search.clearSearchFeatures()},selectSearchCategoryAction:function(a){KG.searchResultsController.set("plugin",null),KG.searchResultsController.get("category")===a?KG.searchResultsController.set("category",null):(KG.searchResultsController.set("category",a),KG.core_search.showResults())},selectSearchPluginAction:function(a){KG.searchResultsController.set("category",null),KG.searchResultsController.get("plugin")==a?KG.searchResultsController.set("plugin",null):(KG.searchResultsController.set("plugin",a),KG.core_search.showResults())},createNoteFromFeatureAction:function(a){a&&(KG.core_leaflet.setCenter(a.get("center")),KG.core_note.set("featureTemplate",a),this.gotoState("createNoteState"))},featureZoomAction:function(a){KG.core_highlight.clearHighlightMarker(this._hlMarker),KG.core_highlight.clearHighlight(this._highlight),this._highlight=KG.core_highlight.highlightFeature(a),KG.store.recordTypeFor(a.get("storeKey"))===KG.Note&&(this._hlMarker=KG.core_highlight.addHighlightMarker(a.get("center")),KG.core_note.setHighlightMarker(this._hlMarker)),KG.core_leaflet.setCenter(a.get("center"))},selectFeatureInspectorAction:function(a){KG.core_highlight.clearHighlightMarker(this._hlMarker);if(KG.store.recordTypeFor(a.get("storeKey"))===KG.Note){var b=KG.core_highlight.addHighlightMarker(a.get("center"));KG.core_note.setHighlightMarker(b),KG.core_note.activateNote(a,{marker:b}),this.gotoState("editNoteState")}},showMoreResultsAction:function(){KG.core_search.showMoreResults()}}),popupFeatureInfoState:SC.State.extend({_highlight:null,enterState:function(){console.log("enter popupFeatureInfoState"),KG.core_info.showInfoPopup()},exitState:function(){KG.core_highlight.clearHighlight(this._highlight),this._highlight=null,KG.core_info.hideInfoPopup()},hideInfoPopupAction:function(){this.gotoState("navigationState")},selectFeatureInspectorAction:function(){this.gotoState("navigationState")},featureInfoMouseUpAction:function(a){KG.core_highlight.clearHighlight(this._highlight),this._highlight=KG.core_highlight.highlightFeature(a)},featureInfoMouseEnterAction:function(a){KG.core_highlight.clearHighlight(this._highlight),this._highlight=KG.core_highlight.highlightFeature(a)},featureInfoMouseLeaveAction:function(a){KG.core_highlight.clearHighlight(this._highlight)}}),popupNoteState:SC.State.extend({initialSubstate:"locateNoteState",exitState:function(){KG.core_leaflet.closePopup(),KG.core_note.clearCreateNote();var a=KG.activeNoteController.get("marker");a&&KG.core_leaflet.disableDraggableMarker(a)},mapMovedAction:function(){},mapZoomedAction:function(){},hideMarkerPopupAction:function(){console.log("marker popup closed, go back to navigation..."),this.gotoState("navigationState")},clickOnMapAction:function(a){console.log("click outside the popup"),this.gotoState("navigationState")},locateNoteState:SC.State.extend({enterState:function(){console.log("enter locatenotestate"),this._ignoreCancel=YES;var a=this;setTimeout(function(){a._ignoreCancel=NO},500),KG.core_note.locateNote(),KG.activeNoteController.set("createNoteLabel","_cancelCreateNote".loc())},exitState:function(){KG.activeNoteController.set("createNoteLabel","_createNote".loc())},hideMarkerPopupAction:function(){},markerDragEnded:function(){console.log("note position is now set"),this.gotoState("createNoteState")},createNoteAction:function(){this._ignoreCancel||(console.log("cancel create note!"),KG.core_note.cancelLocateNote(),this.gotoState("navigationState"))}}),createNoteState:SC.State.extend({enterState:function(){console.log("enter createNoteState"),KG.core_note.createNote(),KG.core_sandbox.autosize("#note-description-area")},exitState:function(){console.log("exit createNoteState"),KG.core_note.clearCreateNote(),KG.core_note.rollbackModifications(),KG.activeNoteController.set("content",null),KG.core_sandbox.destroyAutosize("#note-description-area")},confirmNoteAction:function(){var a=KG.activeNoteController.get("content");KG.core_note.commitModifications(function(){KG.core_note.refreshMarkers(YES)}),KG.core_note.confirmCreateNote(),this.gotoState("navigationState")},cancelCreateNoteAction:function(){this.gotoState("navigationState")},markerDragEnded:function(a,b){KG.core_note.updatePosition(a,b)}}),multipleNotesState:SC.State.extend({enterState:function(){console.log("enter multiple notes")},exitState:function(){console.log("exit multiple notes"),KG.core_note.cleanUpMultipleNotesElements(),KG.notesPopupController.set("marker",null),KG.notesPopupController.set("content",[])},noteSelectedAction:function(a,b){KG.core_note.activateNote(a,b),this.gotoState("editNoteState")}}),editNoteState:SC.State.extend({dirtyMarker:NO,enterState:function(){console.log("enter editNoteState"),KG.core_note.beginModifications(),KG.noteNewCommentController.set("content",""),KG.noteCommentsController.set("showing",NO),KG.noteCommentsController.set("commentsPanelVisible",YES),KG.noteCommentsController.set("isLoading",NO),KG.core_sandbox.autosize("#note-description-area")},exitState:function(){console.log("exit editNoteState"),KG.core_note.postEdition(),KG.activeNoteController.set("content",null),KG.noteCommentsController.set("showing",NO),KG.noteCommentsController.set("commentsPanelVisible",NO),KG.noteDeleteCommentController.set("content",null),KG.core_sandbox.destroyAutosize("#note-description-area"),this.dirtyMarker&&(KG.core_note.refreshMarkers(YES),this.dirtyMarker=NO)},showNoteCommentsAction:function(){KG.noteCommentsController.get("showing")?KG.noteCommentsController.set("showing",NO):(KG.noteCommentsController.get("length")===0&&KG.core_note.fetchComments(),KG.noteCommentsController.set("showing",YES),setTimeout(function(){KG.core_sandbox.autosize("#note-new-comment-area",{minHeight:0,extraSpace:20});var a=$("#note-new-comment-area");KG.noteCommentsController.getPath("content.length")===0&&a.focus()},1))},addNoteCommentAction:function(){var a=KG.noteNewCommentController.get("content");SC.none(a)||(a=a.replace("\n",""),a.length>0&&KG.core_note.addCommentToActiveNote(a)),KG.noteNewCommentController.set("content","")},noteCommentsReadyEvent:function(){setTimeout(function(){var a=$("#note-comments-container");a[0]&&a.scrollTop(a[0].scrollHeight)},1)},toggleDeleteNoteCommentButtonAction:function(a){KG.noteDeleteCommentController.get("content")===a?KG.noteDeleteCommentController.set("content",null):KG.noteDeleteCommentController.set("content",a)},deleteNoteCommentButtonAction:function(a){KG.noteDeleteCommentController.get("content")==a&&(KG.core_note.deleteComment(a),KG.noteDeleteCommentController.set("content",null))},confirmNoteAction:function(){var a=KG.activeNoteController.get("content");KG.core_note.commitModifications(function(){KG.core_note.refreshMarkers(YES)}),this.dirtyMarker=NO,this.gotoState("navigationState")},deleteNoteAction:function(){KG.core_note.deleteActiveNote(),KG.core_note.commitModifications(),this.gotoState("navigationState")},zoomNoteAction:function(){KG.core_note.zoomActiveNote(),this.gotoState("navigationState")},markerDragEnded:function(a,b){this.dirtyMarker=YES,KG.core_note.updatePosition(a,b)}})})})})}),Ember.mixin(KG,{statechart:Ember.Statechart.create({trace:NO,rootState:Ember.State.extend({initialSubstate:"tryLoginAutoState",tryLoginAutoState:Ember.State.extend({enterState:function(){KG.core_init.loadLoginCore(),console.log("try auto login state");var a=$.getQueryString("user");Ember.none(a)?setTimeout(function(){KG.core_login.tryLoginAuto()},1):this.gotoState("loggedOutState")},exitState:function(){$("#loading").hide()},authenticationSucceeded:function(a){console.log("auto auth success"),this.gotoState("loggedInState")},authenticationFailed:function(a){console.log("auto auth failed"),this.gotoState("loggedOutState")}}),loggedOutState:Ember.State.extend({enterState:function(){KG.pageController.setLoginActive();var a=$.getQueryString("user");Ember.none(a)||KG.credential.set("user",a),KG.core_init.loadLoginPage()},exitState:function(){},loginAction:function(a){KG.core_login.login()},authenticationSucceeded:function(){KG.credential.set("pwd",null),KG.core_login.focusUserField(),this.gotoState("loggedInState")},authenticationFailed:function(){}}),loggedInState:Ember.State.extend({initialSubstate:"homeState",enterState:function(){console.log("login successful")},logoutAction:function(){KG.core_auth.logout(),this.gotoState("loggedOutState")},homeState:Ember.State.extend({initialSubstate:"tranHomeState",tranHomeState:Ember.State.extend({_timeout:null,enterState:function(){KG.core_init.loadHomePage();var a=this;this._timeout=setTimeout(function(){KG.pageController.setHomeActive(),a.gotoState("openHomeState")},100)},exitState:function(){clearTimeout(this._timeout)}}),openHomeState:Ember.State.plugin("KG.HomeState")}),sandboxState:Ember.State.extend({initialSubstate:"transSandboxState",transSandboxState:Ember.State.extend({_timeout:null,enterState:function(){KG.core_init.loadSandboxPage();var a=this;this._timeout=setTimeout(function(){KG.pageController.setSandboxActive(),a.gotoState("openSandboxState")},100)},exitState:function(){clearTimeout(this._timeout)}}),openSandboxState:Ember.State.plugin("KG.SandboxState")})}),signupAction:function(a){window.location.href="/signup"}})})}),KG.core_init=Ember.Object.create({_loginView:null,_homeView:null,_sandboxView:null,loadLoginCore:function(){require("kloudgis/login/lib/strings"),require("kloudgis/login/lib/core_login")},loadLoginPage:function(){this._loginView||(this._loginView=SC.View.create({templateName:"login-page"}),this._loginView.appendTo("#super-pages"))},loadHomePage:function(){this._homeView||(this._homeView=SC.View.create({templateName:"home-page"}),this._homeView.appendTo("#super-pages"))},loadSandboxPage:function(){this._sandboxView||(this._sandboxView=SC.View.create({templateName:"sandbox-page"}),this._sandboxView.appendTo("#super-pages"))}}),KG.pageController=Ember.Object.create({loginHidden:NO,loginPushedLeft:NO,loginPushedRight:NO,homeHidden:YES,homePushedLeft:NO,homePushedRight:YES,sandboxHidden:YES,sandboxPushedLeft:NO,sandboxPushedRight:YES,_timeout:null,_timeout2:null,setLoginActive:function(){clearTimeout(this._timeout),clearTimeout(this._timeout2);var a=this;this.set("loginHidden",NO),this.set("loginPushedLeft",NO),this.set("loginPushedRight",NO),this._timeout=setTimeout(function(){a.set("homeHidden",YES)},1500),this.set("homePushedLeft",NO),this.set("homePushedRight",YES),this.set("sandboxHidden",YES),this.set("sandboxPushedLeft",NO),this.set("sandboxPushedRight",YES)},setHomeActive:function(){clearTimeout(this._timeout),clearTimeout(this._timeout2);var a=this;this._timeout=setTimeout(function(){a.set("loginHidden",YES)},1500),this.set("loginPushedLeft",YES),this.set("loginPushedRight",NO),this.set("homeHidden",NO),this.set("homePushedLeft",NO),this.set("homePushedRight",NO),this._timeout2=setTimeout(function(){a.set("sandboxHidden",YES)},1500),this.set("sandboxPushedLeft",NO),this.set("sandboxPushedRight",YES)},setSandboxActive:function(){var a=this;clearTimeout(this._timeout),clearTimeout(this._timeout2),this.set("loginHidden",YES),this.set("loginPushedLeft",YES),this.set("loginPushedRight",NO),this._timeout=setTimeout(function(){a.set("homeHidden",YES)},1500),this.set("homePushedLeft",YES),this.set("homePushedRight",NO),this.set("sandboxHidden",NO),this.set("sandboxPushedLeft",NO),this.set("sandboxPushedRight",NO)}}),Ember.TEMPLATES["login-page"]=Handlebars.template(function(b,c,d,e,f){function q(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t<div>\n\t\t<a id="kloud-logo">\n\t\t\t<img src="css/images/kloudgis_black_128.png" alt="Kloudgis"/>\n\t\t</a>\t\t\n\t\t<a id="kloud-brand">Kloudgis</a>\n\t<div class="login-pane">\n\t\t<table>\n\t\t<tr>\n\t\t<td>\n\t\t\t<label id="email-label" for="user-field">'),e=a,f="_email",g=d.loc||a.loc,j={},j.hash={},j.contexts=[],j.contexts.push(e),j.data=b,typeof g===l?e=g.call(a,f,j):g===n?e=m.call(a,"loc",f,j):e=g,b.buffer.push(o(e)+"</label>\n\t\t</td>\n\t\t<td>\n\t\t\t"),e=a,f="KG.TextField",g={},h="user-field",g.id=h,h="KG.credential.user",g.valueBinding=h,h="email",g.type=h,h="_UsernameHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h="on",g.autocomplete=h,h="loginAction",g.nl_sc_action=h,h="true",g.autofocus=h,h=d.view||a.view,j=k.program(2,r,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push('\t\n\t\t\t</td>\n\t\t<tr>\n\t\t<td>\n\t\t\t<label id="pwd-label" for="pwd-field">'),e=a,f="_pwd",g=d.loc||a.loc,j={},j.hash={},j.contexts=[],j.contexts.push(e),j.data=b,typeof g===l?e=g.call(a,f,j):g===n?e=m.call(a,"loc",f,j):e=g,b.buffer.push(o(e)+"</label>\n\t\t\t</td>\n\t\t\t<td>\n\t\t\t"),e=a,f="KG.TextField",g={},h="pwd-field",g.id=h,h="KG.credential.pwd",g.valueBinding=h,h="password",g.type=h,h="_PasswordHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h="on",g.autocomplete=h,h="loginAction",g.nl_sc_action=h,h=d.view||a.view,j=k.program(4,s,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t</td>\n\t\t</div>\n\t\t<tr id="login-button-row">\n\t\t<td>\n\t\t</td>\n\t\t<td>\t\n\t\t\t'),e=a,f="KG.Button",g={},h="loginAction",g.sc_action=h,h="login-button",g.id=h,h=d.view||a.view,j=k.program(6,t,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t</td>\n\t\t</table>\n\t\t"),e=a,f="SC.Checkbox",g={},h="remember-me",g.id=h,h="KG.core_login.rememberMeLabel",g.titleBinding=h,h="KG.core_login.rememberMe",g.valueBinding=h,h=d.view||a.view,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"view",f,j):e=h,b.buffer.push(o(e)+"\n\t\t"),e={},f="error-message",e["class"]=f,f="KG.core_login.errorMessage",e.messageBinding=f,f=d.view||a.view,j=k.program(8,u,b),j.hash=e,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=b,typeof f===l?e=f.call(a,j):e=p.call(a,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t</div>\t\n\t<div id="signup-box">\n\t\t<span id="signup-title">'),e=a,f="_signupTitle",g=d.loc||a.loc,j={},j.hash={},j.contexts=[],j.contexts.push(e),j.data=b,typeof g===l?e=g.call(a,f,j):g===n?e=m.call(a,"loc",f,j):e=g,b.buffer.push(o(e)+"</span>\n\t\t"),e=a,f="KG.Button",g={},h="signupAction",g.sc_action=h,h="signup-button",g.id=h,h=d.view||a.view,j=k.program(10,v,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t</div>\n"),c}function r(a,b){b.buffer.push("\n\t\t\t")}function s(a,b){b.buffer.push("\n\t\t\t")}function t(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t"),e=a,f="_login",g=d.loc||a.loc,j={},j.hash={},j.contexts=[],j.contexts.push(e),j.data=b,typeof g===l?e=g.call(a,f,j):g===n?e=m.call(a,"loc",f,j):e=g,b.buffer.push(o(e)+"\n\t\t\t"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="message",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"_triageMustache",f,j):e=h,b.buffer.push(o(e)+" \n\t\t"),c}function v(a,b){var c="",e,f,g;return b.buffer.push("\t\n\t\t\t"),e=a,f="_signup",g=d.loc||a.loc,j={},j.hash={},j.contexts=[],j.contexts.push(e),j.data=b,typeof g===l?e=g.call(a,f,j):g===n?e=m.call(a,"loc",f,j):e=g,b.buffer.push(o(e)+"\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k=this,l="function",m=d.helperMissing,n=void 0,o=this.escapeExpression,p=d.blockHelperMissing;return h={},i="main-login-view",h.id=i,i="main-panel",h["class"]=i,i="KG.pageController.loginHidden KG.pageController.loginPushedLeft KG.pageController.loginPushedRight",h.classBinding=i,i=d.view||c.view,j=k.program(1,q,f),j.hash=h,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=f,typeof i===l?h=i.call(c,j):h=p.call(c,i,j),(h||h===0)&&f.buffer.push(h),f.buffer.push("\t\n"),g}),Ember.TEMPLATES["home-page"]=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t<div id="home-header">\n\t\t'),e=a,f="KG.Button",g={},h="logout-button",g.id=h,h="logoutAction",g.sc_action=h,h=d.view||a.view,i=j.program(2,q,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t"),e={},f="welcome-usr-label",e.id=f,f=d.view||a.view,i=j.program(4,r,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t"),e={},f="home-error-message error-message",e["class"]=f,f=d.view||a.view,i=j.program(6,s,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t</div>\n\t<div id="super-home-panel">\n\t\t'),e=a,f="KG.SandboxListView",g={},h="sandbox-list-panel",g.id=h,h="sandbox-list",g.templateName=h,h=d.view||a.view,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"view",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),e=a,f="KG.AddSandboxView",g={},h="add-sandbox-panel",g.id=h,h="add-sandbox",g.templateName=h,h=d.view||a.view,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"view",f,i):e=h,b.buffer.push(n(e)+"\n\t</div>\n"),c}function q(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t"),e=a,f="_logout",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t"),c}function r(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.core_home.connectedUserLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\t\n\t\t"),c}function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.homePanelController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="main-home-view",g.id=h,h="main-panel",g["class"]=h,h="KG.pageController.homeHidden KG.pageController.homePushedLeft KG.pageController.homePushedRight",g.classBinding=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["sandbox-page"]=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f;return b.buffer.push("\n\t"),e={},f="page-header",e.templateName=f,f=d.view||a.view,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"view",i):e=f,b.buffer.push(n(e)+"\n\t"),e={},f="position-label",e.id=f,f="span",e.tagName=f,f=d.view||a.view,i=j.program(2,q,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t<div id="map">\t\n\t</div>\n'),c}function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t<span>"),e=a,f="KG.core_sandbox.latitudeLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</span>\n\t\t<span>"),e=a,f="KG.core_sandbox.longitudeLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</span>\n\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="main-sandbox-view",g.id=h,h="main-panel",g["class"]=h,h="KG.pageController.sandboxHidden KG.pageController.sandboxPushedLeft KG.pageController.sandboxPushedRight",g.classBinding=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")});var get=SC.get;KG.Button=SC.Button.extend({attributeBindings:["type","disabled","title"],triggerAction:function(){this._super();var a=get(this,"sc_action");a&&KG.statechart&&(KG.statechart.sendAction(a,this.get("content")||this.getPath("itemView.content")),this.postAction&&this.postAction())},manualMouseDown:NO,_mouseDownListener:null,_element:null,didInsertElement:function(){if(this.get("manualMouseDown")){this._element=this.get("element");var a=this;this._mouseDownListener=function(b){return a.mouseDown(b)},this._clickListener=function(b){return a.click(b)},this._element.addEventListener("mousedown",this._mouseDownListener,!1),this._element.addEventListener("click",this._clickListener,!1)}},destroy:function(){if(get(this,"isDestroyed"))return;this.get("manualMouseDown")&&this._element&&(this._element.removeEventListener("mousedown",this._mouseDownListener,!1),this._element.removeEventListener("click",this._clickListener,!1),this._element=null),this._super()}}),KG.LoadingImageView=SC.View.extend({classNames:"loading-image".w(),loadingImage:"css/images/loading.gif"}),KG.NumericTextField=Ember.TextField.extend({attributeBindings:["type","placeholder","value","autofocus","min","max","step"]}),KG.otherKey="|?|",KG.SelectInputView=Ember.View.extend({value:null,keyName:"key",didInsertElement:function(){var a=this;this.valueChanged()},valueChanged:function(){var a=this.get("content"),b=this.get("value"),c=NO;a&&(c=a.findProperty(this.get("keyName"),b)),c?this.set("valueSelect",c.key):(this.set("valueSelect",KG.otherKey),this.set("valueInput",b))}.observes("value"),valueSelect:null,valueSelectChanged:function(){var a=this.get("valueSelect");if(a===KG.otherKey)this.set("inputClass","visible-element");else{var b=this.get("value");a!==b&&this.set("value",a),this.set("inputClass","not-visible-element")}}.observes("valueSelect"),valueInput:"",valueInputChanged:function(){var a=this.get("valueInput"),b=this.get("value");a!==b&&this.set("value",a)}.observes("valueInput"),inputClass:"not-visible-element"}),KG.SelectView=SC.View.extend({value:null,valueChanged:function(){this.$("select").val(this.get("value"))}.observes("value"),didInsertElement:function(){var a=this;this.valueChanged(),this.$("select").change(function(){var b=a.$("select option:selected").val();a.set("value",b)})}}),KG.SwitchView=KG.Button.extend({classNames:["switch"],tagName:"div",value:null,on:function(a,b){return b!==undefined&&this.setPath("value",b),this.getPath("value")}.property("value"),triggerAction:function(){this.set("on",!this.get("on"))}}),KG.TextArea=SC.TextArea.extend({attributeBindings:["placeholder","disabled"],placeholder:function(){return SC.none(this.get("placeholder_not_loc"))?null:this.get("placeholder_not_loc").loc()}.property("placeholder_not_loc")}),KG.TextField=SC.TextField.extend({attributeBindings:["type","placeholder","value","autofocus","spellcheck","autocorrect","autocapitalize","autocomplete","disabled","size","results"],nl_sc_action:null,placeholder_not_loc:null,placeholder:function(){return SC.none(this.get("placeholder_not_loc"))?null:this.get("placeholder_not_loc").loc()}.property("placeholder_not_loc"),insertNewline:function(){SC.none(this.get("nl_sc_action"))||KG.statechart.sendAction(this.get("nl_sc_action"),this)},didInsertElement:function(){if(!SC.none(this.get("autofocus"))&&$.browser.mozilla){var a=this;setTimeout(function(){console.log("fallback focus"),a.$().focus()},1)}}}),Ember.TEMPLATES["switch"]=Handlebars.template(function(b,c,d,e,f){function o(a,b){b.buffer.push('\n\t<span class="thumb"></span>\n')}d=d||Ember.Handlebars.helpers;var g,h,i,j,k,l=this,m="function",n=d.blockHelperMissing;g=c,h="KG.SwitchView",i={},j="on",i.classBinding=j,j="content",i.valueBinding=j,j="disabled",i.disabledBinding=j,j=d.view||c.view,k=l.program(1,o,f),k.hash=i,k.contexts=[],k.contexts.push(g),k.fn=k,k.inverse=l.noop,k.data=f,typeof j===m?g=j.call(c,h,k):g=n.call(c,j,h,k),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES.select=Handlebars.template(function(b,c,d,e,f){function r(a,b){var c="",e,f,g;return b.buffer.push("\n\t<select "),e={},f="disabled",e.disabled=f,f=d.bindAttr||a.bindAttr,k={},k.hash=e,k.contexts=[],k.data=b,typeof f===m?e=f.call(a,k):f===o?e=n.call(a,"bindAttr",k):e=f,b.buffer.push(p(e)+">\n\t\t"),e=a,f="content",g=d.each,k=l.program(2,s,b),k.hash={},k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,e=g.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t</select>\n"),c}function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t<option "),e={},f="key",e.value=f,f=d.bindAttr||a.bindAttr,k={},k.hash=e,k.contexts=[],k.data=b,typeof f===m?e=f.call(a,k):f===o?e=n.call(a,"bindAttr",k):e=f,b.buffer.push(p(e)+" >"),e=a,f="label",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"_triageMustache",f,k):e=h,b.buffer.push(p(e)+"</option>\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j,k,l=this,m="function",n=d.helperMissing,o=void 0,p=this.escapeExpression,q=d.blockHelperMissing;g=c,h="KG.SelectView",i={},j="content",i.contentBinding=j,j="value",i.valueBinding=j,j="disabled",i.disabledBinding=j,j=d.view||c.view,k=l.program(1,r,f),k.hash=i,k.contexts=[],k.contexts.push(g),k.fn=k,k.inverse=l.noop,k.data=f,typeof j===m?g=j.call(c,h,k):g=q.call(c,j,h,k),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["select-input"]=Handlebars.template(function(b,c,d,e,f){function r(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e={},f="select",e.templateName=f,f="content",e.contentBinding=f,f="valueSelect",e.valueBinding=f,f="disabled",e.disabledBinding=f,f=d.view||a.view,k={},k.hash=e,k.contexts=[],k.data=b,typeof f===m?e=f.call(a,k):f===o?e=n.call(a,"view",k):e=f,b.buffer.push(p(e)+"\n\t"),e=a,f="Ember.TextField",g={},h="valueInput",g.valueBinding=h,h="inputClass",g.classNameBindings=h,h="disabled",g.disabledBinding=h,h=d.view||a.view,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"view",f,k):e=h,b.buffer.push(p(e)+"\n"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j,k,l=this,m="function",n=d.helperMissing,o=void 0,p=this.escapeExpression,q=d.blockHelperMissing;g=c,h="KG.SelectInputView",i={},j="content",i.contentBinding=j,j="value",i.valueBinding=j,j="disabled",i.disabledBinding=j,j=d.view||c.view,k=l.program(1,r,f),k.hash=i,k.contexts=[],k.contexts.push(g),k.fn=k,k.inverse=l.noop,k.data=f,typeof j===m?g=j.call(c,h,k):g=q.call(c,j,h,k),g||g===0?f.buffer.push(g):f.buffer.push("")}),SC.mixin(KG,{AUTHENTICATION_TOKEN_LOCAL_STORE_KEY:"KG.AuthenticationToken",REMEMBER_ME_LOCAL_STORE_KEY:"KG.RememberMe",AUTHENTICATION_HEADER_NAME:"X-Kloudgis-Authentication"}),KG.core_auth=SC.Object.create({authenticationToken:null,activeUser:null,load:function(a,b,c){console.log("auth load started.");var d=localStorage.getItem(KG.AUTHENTICATION_TOKEN_LOCAL_STORE_KEY),e=localStorage.getItem(KG.REMEMBER_ME_LOCAL_STORE_KEY);if(SC.none(d)||c&&e!="true")return this.logout(),b.call(a,"_failed"),NO;var f={user:null,pwd:d};return $.ajax({type:"POST",url:KG.get("serverHost")+"api_auth/public/login",data:JSON.stringify(f),dataType:"json",contentType:"application/json; charset=utf-8",context:this,error:function(c,d,e){SC.Logger.error("Load error: HTTP error status code: "+c.status),b.call(a,"_error")},success:function(c,d,e){console.log("auth load success.");var f=c.token,g=c.user;this.saveLogin(f,undefined,g),b.call(a,"_success")},async:YES}),YES},login:function(a,b,c,d,e,f){SC.none(c)&&(c=NO);var g={user:a,pwd:b},h=KG.get("serverHost")+"api_auth/public/login",i={rememberMe:c,callbackTarget:d,callbackFunction:e,callbackParams:f};$.ajax({type:"POST",url:h,data:JSON.stringify(g),dataType:"json",contentType:"application/json; charset=utf-8",context:i,error:this.endLoginError,success:this.endLogin,async:YES});return},endLoginError:function(a,b,c){var d=null;return SC.Logger.error("HTTP error status code: "+a.status),a.status===401?d={message:"_unauthorized"}:a.status===503||a.status===404?d={message:"_serverDown"}:a.status===403||a.status>500?d={message:"_serverError"}:d={message:"_unexpectedError"},SC.none(this.callbackFunction)||this.callbackFunction.call(this.callbackTarget,this.callbackParams,d),YES},endLogin:function(a,b,c){var d=null;try{var e,f;SC.none(a)||(e=a.token,f=a.user);if(SC.none(e))throw{message:"_nullTokenError"};KG.core_auth.saveLogin(e,this.rememberMe,f)}catch(g){d=g,SC.Logger.error("endLogin: "+g.message)}return SC.none(this.callbackFunction)||this.callbackFunction.call(this.callbackTarget,this.callbackParams,d),YES},saveLogin:function(a,b,c){this.set("authenticationToken",a),this.set("activeUser",c),SC.none(a)?(localStorage.setItem(KG.AUTHENTICATION_TOKEN_LOCAL_STORE_KEY,""),localStorage.setItem(KG.REMEMBER_ME_LOCAL_STORE_KEY,NO)):(localStorage.setItem(KG.AUTHENTICATION_TOKEN_LOCAL_STORE_KEY,a),b!==undefined&&localStorage.setItem(KG.REMEMBER_ME_LOCAL_STORE_KEY,b))},logout:function(){console.log("Logging out");var a=KG.get("serverHost")+"api_auth/public/logout";$.ajax({type:"POST",url:a,async:YES}),a=KG.get("serverHost")+"api_sandbox/public/logout",$.ajax({type:"POST",url:a,async:YES}),a=KG.get("serverHost")+"api_data/public/logout",$.ajax({type:"POST",url:a,async:YES}),a=KG.get("serverHost")+"api_map/public/logout",$.ajax({type:"POST",url:a,async:YES}),localStorage.removeItem(KG.AUTHENTICATION_TOKEN_LOCAL_STORE_KEY),this.set("authenticationToken",null),this.set("activeUser",null);return},createAjaxRequestHeaders:function(){var a={};return a[KG.AUTHENTICATION_HEADER_NAME]=this.get("authenticationToken"),a}});var fr={_loginTitle:"Se connecter à Kloudgis",_email:"Courriel:",_pwd:"Mot de passe:",_login:"Connecter",_signupTitle:"Pas encore membre ?",_signup:"Créer un compte",_rememberMe:"Rester connecter",_serverError:"Erreur du serveur.",_serverDown:"Le serveur n'est pas disponible.",_unexpectedError:"Erreur interne.",_unauthorized:"Le courriel ou le mot de passe est incorrect.",_UsernameHint:"Votre courriel",_PasswordHint:"Mot de passe",_UsernameRequired:"Le courriel est obligatoire.",_PasswordRequired:"Le mot de passe est obligatoire."},en={_loginTitle:"Login to Kloudgis",_email:"Email:",_pwd:"Password:",_login:"Sign in",_signupTitle:"Not yet member ?",_signup:"Create an account",_rememberMe:"Stay signed in",_serverError:"Server error.",_serverDown:"The server is offline.",_unexpectedError:"Internal error.",_unauthorized:"The email or password you entered is incorrect.",_UsernameHint:"Your Email",_PasswordHint:"Mot de passe",_UsernameRequired:"The email is required.",_PasswordRequired:"The password is required."};KG.lang==="fr"?jQuery.extend(Ember.STRINGS,fr):jQuery.extend(Ember.STRINGS,en),KG.core_login=SC.Object.create({isBusy:NO,errorMessage:"",rememberMe:NO,rememberMeLabel:"_rememberMe".loc(),focusUserField:function(){$("#user-field").focus()},focusPwdField:function(){$("#pwd-field").focus()},login:function(){try{console.log("Login attempt");var a=KG.credential.get("user");if(a==null||a=="")throw this.focusUserField(),Error("_UsernameRequired".loc());var b=KG.credential.get("pwd");if(b==null||b=="")throw this.focusPwdField(),Error("_PasswordRequired".loc());this.set("isBusy",YES);var c=SHA256(b);return KG.core_auth.login(a,c,this.get("rememberMe"),this,this.endLogin,{}),YES}catch(d){return this.set("errorMessage",d.message.loc()),this.set("isBusy",NO),KG.statechart.sendAction("authenticationFailed",this),NO}},endLogin:function(a,b){try{if(!SC.none(b))throw b;this.set("isBusy",NO),KG.statechart.sendAction("authenticationSucceeded",this)}catch(c){var d=c.message||"?";return this.set("errorMessage",d.loc()),this.focusUserField(),KG.statechart.sendAction("authenticationFailed",this),this.set("isBusy",NO),YES}return this.set("errorMessage",""),YES},tryLoginAuto:function(){KG.core_auth.load(this,this.tryLoginAutoCallback,YES)},tryLoginAutoCallback:function(a){console.log("auto cb with: "+a),a==="_success"?KG.statechart.sendAction("authenticationSucceeded",this):KG.statechart.sendAction("authenticationFailed",this)}}),KG.credential=SC.Object.create({user:undefined,pwd:undefined}),$(document).ready(function(){KG.statechart.initStatechart()}),KG.core_date=SC.Object.create({formatDate:function(a){return this._formatDate(a,NO)},formatDateSimple:function(a){return this._formatDate(a,YES)},_formatDate:function(a,b){if(a){var c=new Date(a),d=c.getDate(),e=c.getMonth()+1,f=c.getFullYear(),g=new Date,h=g.getDate(),i=g.getMonth()+1,j=g.getFullYear(),k=c.getHours();k<10&&(k="0"+k);var l=c.getMinutes();return l<10&&(l="0"+l),h===d&&i===e&&j==f?"%@:%@".fmt(k,l):(e<10&&(e="0"+e),d<10&&(d="0"+d),b?"%@-%@-%@".fmt(f,e,d):"%@-%@-%@ %@:%@".fmt(f,e,d,k,l))}}}),KG.Store=SC.DataSource.extend({fetch:function(a,b){var c;if(b===KG.LAYER_QUERY)c=KG.get("serverHost")+"api_data/protected/layers?sandbox=%@".fmt(KG.get("activeSandboxKey"));else if(b===KG.BOOKMARK_QUERY)c=KG.get("serverHost")+"api_data/protected/bookmarks?sandbox=%@".fmt(KG.get("activeSandboxKey"));else if(b===KG.FEATURETYPE_QUERY)c=KG.get("serverHost")+"api_data/protected/featuretypes?sandbox=%@".fmt(KG.get("activeSandboxKey"));else if(b===KG.ATTRTYPE_QUERY)c=KG.get("serverHost")+"api_data/protected/attrtypes?sandbox=%@".fmt(KG.get("activeSandboxKey"));else if(b===KG.SEARCH_QUERY)c=KG.get("serverHost")+"api_data/protected/features/count_search?search_string=%@&sandbox=%@".fmt(b.search,KG.get("activeSandboxKey"));else if(b===KG.INFO_QUERY)c=KG.get("serverHost")+"api_data/protected/features/features_at?sandbox=%@&lat=%@&lon=%@&one_pixel=%@&limit=%@&layers=%@".fmt(KG.get("activeSandboxKey"),b.lat,b.lon,b.one_pixel,b.limit_query,b.layers);else if(b===KG.NOTE_MARKER_QUERY){var d=b.fat_bounds;c=KG.get("serverHost")+"api_data/protected/notes/clusters?sw_lon=%@&ne_lat=%@&ne_lon=%@&sw_lat=%@&distance=%@&sandbox=%@".fmt(d.getPath("sw.lon"),d.getPath("sw.lat"),d.getPath("ne.lon"),d.getPath("ne.lat"),b.distance,KG.get("activeSandboxKey"))}else b===KG.SEARCH_RESULT_NOTE_QUERY||b===KG.SEARCH_RESULT_FEATURE_QUERY?c=KG.get("serverHost")+"api_data/protected/features/search?category=%@&search_string=%@&sandbox=%@&start=%@".fmt(b.category,b.search,KG.get("activeSandboxKey"),b.start||0):b===KG.SANDBOX_QUERY&&(c=KG.get("serverHost")+"api_sandbox/protected/sandboxes");var e=b.get("version");return SC.none(c)?NO:($.ajax({type:"GET",url:c,dataType:"json",contentType:"application/json; charset=utf-8",context:this,headers:KG.core_auth.createAjaxRequestHeaders(),async:YES,error:function(c,d,e){SC.Logger.error("Load error: HTTP error status code: "+c.status),a.dataSourceDidErrorQuery(b,e),KG.statechart&&KG.statechart.sendAction("httpError",c.status)},success:function(c,d,f){console.log("fetch success");var g=c?c.records:null,h;SC.none(g)||(h=a.loadRecords(b.get("recordType"),g)),b.get("isLocal")?a.dataSourceDidFetchQuery(b):a.loadQueryResults(b,h),!SC.none(c)&&b.blockRequestCb&&c.blockData&&b.blockRequestCb.call(b.blockRequestTarget,c.blockData,e)}}),YES)},retrieveRecord:function(a,b){var c=a.recordTypeFor(b),d=a.idFor(b),e;if(!SC.none(d)){c===KG.Feature?e=KG.get("serverHost")+"api_data/protected/features/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.Note?e=KG.get("serverHost")+"api_data/protected/notes/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.NoteComment?e=KG.get("serverHost")+"api_data/protected/note_comments/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.FeatureComment?e=KG.get("serverHost")+"api_data/protected/feature_comments/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.Featuretype?e=KG.get("serverHost")+"api_data/protected/featuretypes/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.Attrtype?e=KG.get("serverHost")+"api_data/protected/attrtypes/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")):c===KG.Bookmark&&(e=KG.get("serverHost")+"api_data/protected/bookmarks/%@?sandbox=%@".fmt(d,KG.get("activeSandboxKey")));if(e)return this.ajaxSupport(a,b,"GET",e),YES}return NO},createRecord:function(a,b){var c=a.recordTypeFor(b),d;return c===KG.Feature?d=KG.get("serverHost")+"api_data/protected/features?sandbox=%@".fmt(KG.get("activeSandboxKey")):c===KG.Note?d=KG.get("serverHost")+"api_data/protected/notes?sandbox=%@".fmt(KG.get("activeSandboxKey")):c===KG.NoteComment?d=KG.get("serverHost")+"api_data/protected/note_comments?sandbox=%@".fmt(KG.get("activeSandboxKey")):c===KG.FeatureComment?d=KG.get("serverHost")+"api_data/protected/feature_comments?sandbox=%@".fmt(KG.get("activeSandboxKey")):c===KG.Bookmark?d=KG.get("serverHost")+"api_data/protected/bookmarks?sandbox=%@".fmt(KG.get("activeSandboxKey")):c===KG.Sandbox&&(d=KG.get("serverHost")+"api_sandbox/protected/sandboxes"),d?(this.ajaxSupport(a,b,"POST",d,JSON.stringify(a.readDataHash(b))),YES):NO},updateRecord:function(a,b,c){var d=a.recordTypeFor(b),e=a.idFor(b),f;return SC.none(e)||(d===KG.Feature?f=KG.get("serverHost")+"api_data/protected/features/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.Note?f=KG.get("serverHost")+"api_data/protected/notes/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.NoteComment?f=KG.get("serverHost")+"api_data/protected/note_comments/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.FeatureComment?f=KG.get("serverHost")+"api_data/protected/feature_comments/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.Bookmark&&(f=KG.get("serverHost")+"api_data/protected/bookmarks/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")))),f?(this.ajaxSupport(a,b,"PUT",f,JSON.stringify(a.readDataHash(b))),YES):NO},destroyRecord:function(a,b,c){var d=a.recordTypeFor(b),e=a.idFor(b),f;return SC.none(e)||(d===KG.Feature?f=KG.get("serverHost")+"api_data/protected/features/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.Note?f=KG.get("serverHost")+"api_data/protected/notes/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.NoteComment?f=KG.get("serverHost")+"api_data/protected/note_comments/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.FeatureComment?f=KG.get("serverHost")+"api_data/protected/feature_comments/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.Bookmark?f=KG.get("serverHost")+"api_data/protected/bookmarks/%@?sandbox=%@".fmt(e,KG.get("activeSandboxKey")):d===KG.Sandbox&&(f=KG.get("serverHost")+"api_sandbox/protected/sandboxes/%@".fmt(e))),f?(this.ajaxSupport(a,b,"DELETE",f),YES):NO},ajaxSupport:function(a,b,c,d,e){$.ajax({type:c,url:d,data:e,dataType:"json",contentType:"application/json; charset=utf-8",context:this,headers:KG.core_auth.createAjaxRequestHeaders(),async:YES,error:function(c,d,e){SC.Logger.error("Ajax error: HTTP error status code: "+c.status),a.dataSourceDidError(b,e),KG.statechart&&KG.statechart.sendAction("httpError",c.status)},success:function(d,e,f){console.log(c+" success");var g=d,h;c==="DELETE"?a.dataSourceDidDestroy(b):!SC.none(g)&&g.guid?a.dataSourceDidComplete(b,g,g.guid):a.dataSourceDidComplete(b)}})}}),KG.Record=SC.Record.extend({date_create:SC.Record.attr(Number),formattedDate:function(){var a=this.get("date_create");return a?KG.core_date.formatDate(a):""}.property("date_create")}),KG.Attribute=SC.Object.extend({feature:null,attrtype:null,label:function(){return this.getPath("attrtype.label")}.property().cacheable(),templateName:function(){var a=this.getPath("attrtype.type");return a+"-renderer"}.property(),value:function(a,b){var c=this.getPath("attrtype.attr_ref"),d=this.get("feature");return b!==undefined&&d.set(c,b),d.get(c)}.property(),imgBase64Value:function(){var a=this.get("value");if(SC.none(a))return"";var b="data:image/png;base64,";return b+a}.property("value"),css_class:function(){return this.getPath("attrtype.css_class")||"one-column"}.property(),min:function(){return this.getPath("attrtype.min")||0}.property(),max:function(){return this.getPath("attrtype.max")||2e9}.property(),step:function(){return this.getPath("attrtype.step")||1}.property(),enumValues:function(){var a=this.getPath("attrtype.enum_values"),b=[],c=this.get("value"),d,e=a.length,f=NO;for(d=0;d<e;d++)a[d].key===c&&(f=YES),b.push(a[d]);return f||b.insertAt(0,{key:c,label:""}),b}.property("attr_type").cacheable(),enumValuesCustom:function(){var a=this.getPath("attrtype.enum_values"),b=[],c,d=a.length;b.push({key:KG.otherKey,label:"_otherValue".loc()});for(c=0;c<d;c++)b.push(a[c]);return b}.property("attr_type").cacheable()}),KG.Attrtype=KG.Record.extend({label:SC.Record.attr(String),type:SC.Record.attr(String),attr_ref:SC.Record.attr(String),css_class:SC.Record.attr(String),render_order:SC.Record.attr(Number),featuretype:SC.Record.toOne("KG.Featuretype",{inverse:"attrtypes",isMaster:YES}),min:SC.Record.attr(Number),max:SC.Record.attr(Number),step:SC.Record.attr(Number),enum_values:SC.Record.attr(Array)}),KG.Bookmark=KG.Record.extend({label:SC.Record.attr(String),user_create:SC.Record.attr(Number),user_descriptor:SC.Record.attr(String),center:SC.Record.attr(Object),zoom:SC.Record.attr(Number),formattedDate:function(){var a=this.get("date_create");return a?KG.core_date.formatDateSimple(a):""}.property("date_create"),formattedDescription:function(){return"_bookmarkDescription".loc(this.get("user_descriptor"),this.get("formattedDate"))}.property("formattedDate","ownerDescriptor")}),KG.Bounds=SC.Object.extend({sw:null,ne:null,contains:function(a){var b=this.get("sw"),c=this.get("ne"),d=a.get("sw"),e=a.get("ne");return d||(d=e=a),d.get("lat")>=b.get("lat")&&e.get("lat")<=c.get("lat")&&d.get("lon")>=b.get("lon")&&e.get("lon")<=c.get("lon")},toString:function(){return"sw:%@ ne:%@".fmt(this.get("sw"),this.get("ne"))}}),KG.Comment=KG.Record.extend({comment:SC.Record.attr(String),author:SC.Record.attr(Number),author_descriptor:SC.Record.attr(String)}),KG.FeatureComment=KG.Comment.extend({feature:SC.Record.toOne("KG.Feature",{inverse:"comments",isMaster:YES})}),KG.Feature=KG.Record.extend({fid:SC.Record.attr(Number),ft_id:SC.Record.attr(Number),user_create:SC.Record.attr(Number),date_update:SC.Record.attr(Number),user_update:SC.Record.attr(Number),joins:SC.Record.toMany("KG.Feature",{inverse:"reverse_joins",isMaster:YES}),reverse_joins:SC.Record.toMany("KG.Feature",{inverse:"joins",isMaster:NO}),comments:SC.Record.toMany("KG.FeatureComment",{inverse:"feature",isMaster:NO}),geo:SC.Record.attr(Object),text1:SC.Record.attr(String),text2:SC.Record.attr(String),text3:SC.Record.attr(String),text4:SC.Record.attr(String),text5:SC.Record.attr(String),text6:SC.Record.attr(String),text7:SC.Record.attr(String),text8:SC.Record.attr(String),text9:SC.Record.attr(String),text10:SC.Record.attr(String),text11:SC.Record.attr(String),text12:SC.Record.attr(String),text13:SC.Record.attr(String),text14:SC.Record.attr(String),text15:SC.Record.attr(String),text16:SC.Record.attr(String),text17:SC.Record.attr(String),text18:SC.Record.attr(String),text19:SC.Record.attr(String),text20:SC.Record.attr(String),text21:SC.Record.attr(String),text22:SC.Record.attr(String),text23:SC.Record.attr(String),text24:SC.Record.attr(String),text25:SC.Record.attr(String),bool1:SC.Record.attr(Boolean),bool2:SC.Record.attr(Boolean),bool3:SC.Record.attr(Boolean),bool4:SC.Record.attr(Boolean),bool5:SC.Record.attr(Boolean),date1:SC.Record.attr(Number),date2:SC.Record.attr(Number),date3:SC.Record.attr(Number),num1:SC.Record.attr(Number),num2:SC.Record.attr(Number),num3:SC.Record.attr(Number),num4:SC.Record.attr(Number),num5:SC.Record.attr(Number),num6:SC.Record.attr(Number),num7:SC.Record.attr(Number),num8:SC.Record.attr(Number),num9:SC.Record.attr(Number),num10:SC.Record.attr(Number),decim1:SC.Record.attr(Number),decim2:SC.Record.attr(Number),decim3:SC.Record.attr(Number),decim4:SC.Record.attr(Number),decim5:SC.Record.attr(Number),decim6:SC.Record.attr(Number),decim7:SC.Record.attr(Number),decim8:SC.Record.attr(Number),decim9:SC.Record.attr(Number),decim10:SC.Record.attr(Number),img1:SC.Record.attr(String),img2:SC.Record.attr(String),featuretype:function(){var a=this.get("ft_id");if(a)return KG.store.find(KG.Featuretype,a)}.property("ft_id").cacheable(),_observerSet:NO,title:function(){var a=this.get("featuretype");if(a){var b=a.get("title_attribute");if(b){if(!this._observerSet){this._observerSet=!0;var c=this;this.addObserver(b,function(){c.notifyPropertyChange("title")})}return this.get(b)}}return"?"}.property("featuretype"),isSelectable:YES,isInspectorSelectable:YES,center:function(){var a,b=this.get("geo");return SC.none(b)||(a=b.centroid),SC.none(a)?NO:KG.LonLat.create({lon:a.x,lat:a.y})}.property("geo"),getClosestCoord:function(a){var b=this.get("geo");if(!SC.none(b)){var c=b.coords;if(!SC.none(c)&&c.length>0){if(!a)return c[0];var d=KG.LonLat.create({lon:a.x,lat:a.y}),e=c.length,f,g,h;for(f=0;f<e;f++){var i=KG.LonLat.create({lon:c[f].x,lat:c[f].y}),j=i.distance(d);if(!g||j<g)g=j,h=i}return h}}},getAttributes:function(){var a=[],b=this.get("featuretype");if(!SC.none(b)){var c=b.get("attrtypes");if(!SC.none(c)){var d=this;c.forEach(function(b){if(b.get("type")!=="geo"){var c=KG.Attribute.create({feature:d,attrtype:b});a.push(c)}})}}return a}}),KG.Featuretype=KG.Record.extend({label:SC.Record.attr(String),title_attribute:SC.Record.attr(String),attrtypes:SC.Record.toMany("KG.Attrtype",{inverse:"featuretype",isMaster:NO}),geometry_type:SC.Record.attr(String),getDefaultGeoFromPoint:function(a,b){var c=this.get("geometry_type");if(c){var d=c.toLowerCase();if(d==="point")return{coords:[{x:a,y:b}],centroid:{x:a,y:b},geo_type:"Point"};var e=.5;KG.core_leaflet&&(e=KG.core_leaflet.pixelsToWorld(100));if(d==="linestring"){var f={x:a,y:b},g={x:a+e,y:b};return{coords:[f,g],centroid:{x:a,y:b},geo_type:"LineString"}}}}}),KG.Layer=KG.Record.extend({label:SC.Record.attr(String),renderOrder:SC.Record.attr(Number),isSelectable:SC.Record.attr(Boolean),canRender:SC.Record.attr(Boolean),ft_id:SC.Record.attr(Number),name:SC.Record.attr(String),url:SC.Record.attr(String),visibility:SC.Record.attr(Boolean),buffer:SC.Record.attr(Number)}),KG.LonLat=SC.Object.extend({lon:null,lat:null,distance:function(a){var b=this.get("lon"),c=this.get("lat"),d=a.get("lon"),e=a.get("lat"),f=d-b,g=e-c,h=Math.sqrt(f*f+g*g);return h},distanceKm:function(a){var b=this.get("lon"),c=this.get("lat"),d=a.get("lon"),e=a.get("lat"),f=6371,g=this.toRad(e-c),h=this.toRad(d-b),c=this.toRad(c),e=this.toRad(e),i=Math.sin(g/2)*Math.sin(g/2)+Math.sin(h/2)*Math.sin(h/2)*Math.cos(c)*Math.cos(e),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),k=f*j;return k},toRad:function(a){return a*Math.PI/180}}),KG.NoteComment=KG.Comment.extend({note:SC.Record.toOne("KG.Note",{inverse:"comments",isMaster:YES})}),KG.NoteMarker=KG.Record.extend({lon:SC.Record.attr(Number),lat:SC.Record.attr(Number),tip:SC.Record.attr(String),features:SC.Record.toMany("KG.Note",{isMaster:YES}),featureCount:function(){return this.getPath("features.length")}.property("features.length"),title:function(){var a=this.get("featureCount"),b;return a>1?b="_Notes".loc(a):b="_Note".loc(),b}.property("featureCount"),tooltip:function(){var a=this.get("tip");if(a){if(a.charAt(0)==="_"){var b=this.get("featureCount");return a.loc(b)}return a}}.property("tip","featureCount")}),KG.Note=KG.Record.extend({title:SC.Record.attr(String),description:SC.Record.attr(String),author:SC.Record.attr(Number),author_descriptor:SC.Record.attr(String),date_update:SC.Record.attr(Number),coordinate:SC.Record.attr(Object),comments:SC.Record.toMany("KG.NoteComment",{inverse:"note",isMaster:NO}),isSelectable:YES,isInspectorSelectable:NO,center:function(){var a=this.get("coordinate");if(!SC.none(a))return KG.LonLat.create({lon:a.x,lat:a.y})}.property("coordinate"),authorFormatted:function(){var a=this.getPath("author_descriptor");return a?"_author".loc(a):""}.property("content.author_descriptor")}),KG.Sandbox=KG.Record.extend({name:SC.Record.attr(String),owner:SC.Record.attr(Number),ownerDescriptor:SC.Record.attr(String),lat:SC.Record.attr(Number),lon:SC.Record.attr(Number),zoom:SC.Record.attr(Number),formattedDescription:function(){return"_sandboxDescription".loc(this.get("ownerDescriptor"),this.get("formattedDate"))}.property("formattedDate","ownerDescriptor")}),KG.SearchCategory=KG.Record.extend({categoryLabel:SC.Record.attr(String),count:SC.Record.attr(Number),search:SC.Record.attr(String),title:function(){var a=this.get("categoryLabel");if(!SC.none(a))return a.charAt(0)==="_"?a.loc():a}.property("categoryLabel"),records:function(){return this.findRecords(0)}.property(),findRecords:function(a){var b=KG.SEARCH_RESULT_FEATURE_QUERY;return this.get("categoryLabel")==="_notes_"&&(b=KG.SEARCH_RESULT_NOTE_QUERY),b.start=a||0,b.category=this.get("id"),b.search=this.get("search"),b.blockRequestCb=this.blockReceivedCallback,b.blockRequestTarget=this,b.incrementProperty("version"),KG.store.find(b)},queryBlock:null,blockReceivedCallback:function(a,b){b===KG.SEARCH_RESULT_FEATURE_QUERY.get("version")&&this.set("queryBlock",Ember.Object.create({start:a.start,max:a.max,resultSize:a.resultSize}))}}),KG.store=SC.Store.create({commitRecordsAutomatically:NO}).from("KG.Store"),KG.SANDBOX_QUERY=SC.Query.local(KG.Sandbox,{orderBy:"date_create DESC"}),KG.LAYER_QUERY=SC.Query.local(KG.Layer),KG.BOOKMARK_QUERY=SC.Query.local(KG.Bookmark,{orderBy:"label"}),KG.FEATURETYPE_QUERY=SC.Query.local(KG.Featuretype,{orderBy:"label"}),KG.ATTRTYPE_QUERY=SC.Query.local(KG.Attrtype),KG.SEARCH_QUERY=SC.Query.local(KG.SearchCategory,{conditions:"count > 0 OR count = -1",orderBy:"categoryLabel"}),KG.INFO_QUERY=SC.Query.remote(KG.Feature),KG.NOTE_MARKER_QUERY=SC.Query.remote(KG.NoteMarker),KG.SEARCH_RESULT_NOTE_QUERY=SC.Query.remote(KG.Note,{conditions:"count > 0"}),KG.SEARCH_RESULT_FEATURE_QUERY=SC.Query.remote(KG.Feature,{conditions:"count > 0",version:1}),SC.RecordArray.reopen({_readyQueue:null,_errorQuery:null,onReady:function(a,b,c){if(this.get("status")&SC.Record.READY)b.call(a,this,c);else{var d=this._readyQueue;this._readyQueue||(d=[],this._readyQueue=d,this.addObserver("status",this,this._onReady));var e=this;d.push(function(){b.call(a,e,c)})}},_onReady:function(){if(this.get("status")&SC.Record.READY){var a=this._readyQueue,b,c;for(b=0,c=a.length;b<c;b++)a[b].call();this.removeObserver("status",this,this._onReady),this._readyQueue=null}},offReady:function(){this.removeObserver("status",this,this._onReady)},onError:function(a,b,c){if(this.get("status")&SC.Record.ERROR)b.call(a,this,c);else{var d=this._errorQueue;this._errorQueue||(d=[],this._errorQueue=d,this.addObserver("status",this,this._onError));var e=this;d.push(function(){b.call(a,e,c)})}},_onError:function(){if(this.get("status")&SC.Record.ERROR){var a=this._errorQueue,b,c;for(b=0,c=a.length;b<c;b++)a[b].call();this.removeObserver("status",this,this._onError),this._errorQueue=null}},offError:function(){this.removeObserver("status",this,this._onError)}}),SC.Record.reopen({_readyQueue:null,_errorQueue:null,_destroyQueue:null,onReady:function(a,b,c){if(this.get("status")&SC.Record.READY)b.call(a,this,c);else{var d=this._readyQueue;d||(d=[],this._readyQueue=d,this.addObserver("status",this,this._onReady));var e=this;d.push(function(){b.call(a,e,c)})}},_onReady:function(){if(this.get("status")&SC.Record.READY){var a=this._readyQueue,b,c;for(b=0,c=a.length;b<c;b++)a[b].call();this.removeObserver("status",this,this._onReady),this._readyQueue=null}},offReady:function(){this.removeObserver("status",this,this._onReady)},onError:function(a,b,c){if(this.get("status")&SC.Record.ERROR)b.call(a,this,c);else{var d=this._errorQueue;d||(d=[],this._errorQueue=d,this.addObserver("status",this,this._onError));var e=this;d.push(function(){b.call(a,e,c)})}},_onError:function(){if(this.get("status")&SC.Record.ERROR){var a=this._errorQueue,b,c;for(b=0,c=a.length;b<c;b++)a[b].call();this.removeObserver("status",this,this._onError),this._errorQueue=null}},offError:function(){this.removeObserver("status",this,this._onError)},onDestroyedClean:function(a,b,c){if(this.get("status")===SC.Record.DESTROYED_CLEAN)b.call(a,this,c);else{var d=this._destroyQueue;d||(d=[],this._destroyQueue=d,this.addObserver("status",this,this._onDestroyedClean));var e=this;d.push(function(){b.call(a,e,c)})}},_onDestroyedClean:function(){if(this.get("status")===SC.Record.DESTROYED_CLEAN){var a=this._destroyQueue,b,c;for(b=0,c=a.length;b<c;b++)a[b].call();this.removeObserver("status",this,this._onDestroyedClean),this._destroyQueue=null}},offDestroyedClean:function(){this.removeObserver("status",this,this._onDestroyedClean)}}),KG.localStorageLeafletCacheKey="leaflet-wms-cache-count",KG.MapLeaflet=SC.Object.extend({map:null,_popupInfo:null,_popupMarker:null,_icons:[],_added:NO,baseLayer:"Bing",addToDocument:function(a,b,c,d){if(this._added)return;this._added=YES,$.browser.safari&&navigator.platform.indexOf("Mac")==0&&(L.Popup.prototype._close=function(){if(this._opened){this._map.removeLayer(this);var a=$(".leaflet-popup-pane")[0];a.style.width=="1px"?a.style.width="0px":a.style.width="1px"}});var e;if(this.get("baseLayer")==="OSM"){var f="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",g="OSM";e=new L.TileLayer(f,{maxZoom:20,attribution:g})}else{var h="Anvn3DMhTFsggcirvNz1TNQrxCzksEg-b47gtD7AO1iOzZicEiF2mFZoleYMkX8z";e=new L.BingLayer(h)}d=d||"map";var i=new L.Map(d,{});a=a||-72,b=b||46,c=c||5,i.setView(new L.LatLng(b,a),c).addLayer(e),this.map=i,this.map.on("zoomend",this.onZoom,this),this.map.on("moveend",this.onMove,this),this.map.on("click",this.onClick,this),this.map.on("layeradd",this.onLayerAdd,this),this.map.on("layerremove",this.onLayerRemove,this),L.Browser.touch||this.map.on("mousemove",this.onMouseMove,this),this._popupInfo=new L.Popup({closeButton:!1}),this._popupMarker=new L.Popup({closeButton:!0,offset:new L.Point(0,-33)}),this._popupInfo._initLayout(),L.Browser.touch&&(L.DomEvent.addListener(this._popupInfo._wrapper,L.Draggable.START,KG.core_leaflet.stopPropagation),L.DomEvent.addListener(this._popupInfo._wrapper,L.Draggable.END,KG.core_leaflet.stopPropagation),L.DomEvent.addListener(this._popupInfo._wrapper,L.Draggable.MOVE,KG.core_leaflet.stopPropagation)),L.DomEvent.addListener(this._popupInfo._wrapper,"mousewheel",L.DomEvent.stopPropagation),this._popupMarker._initLayout(),L.Browser.touch&&(L.DomEvent.addListener(this._popupMarker._wrapper,L.Draggable.START,KG.core_leaflet.stopPropagation),L.DomEvent.addListener(this._popupMarker._wrapper,L.Draggable.END,KG.core_leaflet.stopPropagation),L.DomEvent.addListener(this._popupMarker._wrapper,L.Draggable.MOVE,KG.core_leaflet.stopPropagation)),L.DomEvent.addListener(this._popupMarker._wrapper,"mousewheel",KG.core_leaflet.stopPropagation),L.DomEvent.addListener(this.map._container,"mousedown",this._onMouseDown,this),L.DomEvent.addListener(this.map._container,"mouseup",this._onMouseUp,this),L.DomEvent.addListener(this.map._container,"click",this._onMouseClick,this)},_shiftDown:NO,_onMouseDown:function(a){if(!a.shiftKey||a.which!=1&&a.button!=1)return!1;this._shiftDown=YES},_onMouseUp:function(a){setTimeout(function(){KG.core_leaflet._shiftDown=NO},300)},_onMouseClick:function(a){this._shiftDown=NO},stopPropagation:function(a){a.stopPropagation&&a.stopPropagation()},onZoom:function(a){KG.statechart.sendAction("mapZoomedAction",this.getCenter(),this.getZoom())},onMove:function(a){KG.statechart.sendAction("mapMovedAction",this.getCenter(),this.getZoom())},onClick:function(a){if(this._shiftDown)return NO;KG.statechart.sendAction("clickOnMapAction",KG.LonLat.create({lon:a.latlng.lng,lat:a.latlng.lat}))},onMouseMove:function(a){KG.statechart.sendAction("mousePositionChanged",KG.LonLat.create({lon:a.latlng.lng,lat:a.latlng.lat}))},onLayerAdd:function(a){a.layer===this._popupInfo&&$(this._popupInfo._container).addClass("info-popup")},onLayerRemove:function(a){try{var b=KG.core_leaflet;b._popupMarker&&b._popupMarker===a.layer?(console.log("popup closed"),KG.statechart.sendAction("hideMarkerPopupAction",b),a.layer.off("click",a.layer.openPopup,a.layer)):b._popupInfo&&b._popupInfo===a.layer&&KG.statechart.sendAction("hideInfoPopupAction",b)}catch(a){}},pixelsToWorld:function(a){var b=this.getCenter(),c=this.getCenterOffsetPixels(a),d=c.lat-b.lat,e=c.lon-b.lon;return Math.sqrt(d*d+e*e)},getCenter:function(){var a=this.map.getCenter();return KG.LonLat.create({lon:a.lng,lat:a.lat})},getCenterOffsetPixels:function(a){var b=this.map.getSize().divideBy(2),c=this.map._getTopLeftPoint().add(b),d=c.add(new L.Point(a,a)),e=this.map.unproject(d);return KG.LonLat.create({lon:e.lng,lat:e.lat})},getZoom:function(){return this.map.getZoom()},getFatBounds:function(){return this._getBounds(this.pixelsToWorld(this.map.getSize().divideBy(6).x))},getBounds:function(){return this._getBounds(0)},getBoundsA:function(){var a=this.map.getBounds(),b=this.map.getCenter(),c=a._southWest,d=a._northEast,e=[];return a.contains(b)?e[0]=KG.Bounds.create({sw:KG.LonLat.create({lon:c.lng,lat:c.lat}),ne:KG.LonLat.create({lon:d.lng,lat:d.lat})}):(e[0]=KG.Bounds.create({sw:KG.LonLat.create({lon:-179.9999,lat:c.lat}),ne:KG.LonLat.create({lon:c.lng,lat:d.lat})}),e[1]=KG.Bounds.create({sw:KG.LonLat.create({lon:d.lng,lat:c.lat}),ne:KG.LonLat.create({lon:179.9999,lat:d.lat})})),e},_getBounds:function(a){var b=this.map.getBounds(),c=b._southWest,d=b._northEast,e={},f={};return e.lat=Math.max(c.lat-a,-90),e.lon=Math.max(c.lng-a,-179.9999),f.lat=Math.min(d.lat+a,90),f.lon=Math.min(d.lng+a,179.9999),KG.Bounds.create({sw:KG.LonLat.create({lon:e.lon,lat:e.lat}),ne:KG.LonLat.create({lon:f.lon,lat:f.lat})})},setCenter:function(a,b){return a?(b||(b=this.map.getZoom()),this.map.setView(new L.LatLng(a.get("lat"),a.get("lon")),b),YES):NO},addMarker:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o;d&&(e=d.title,f=d.animated,g=d.iconPath,h=d.draggable,i=d.popupContent,j=d.openPopup,k=d.clickTarget,l=d.clickCb,m=d.dragendTarget,n=d.dragendCb,o=d.injectGetNativePositionFunction);var p=g+f,q=this._icons[p];q||(q=new L.Icon(g),f&&(q.createIcon=function(){var a=this._createIcon("icon");return a.className=a.className+" "+"animated-marker",a}),this._icons[p]=q);var r=new L.LatLng(c,b),s=new L.Marker(r,{draggable:h,title:e,icon:q});this.map.addLayer(s),l&&s.on("click",function(){l.call(k,a,s._latlng.lng,s._latlng.lat)}),n&&s.on("dragend",function(){n.call(m,a,s._latlng.lng,s._latlng.lat)});if(!SC.none(a._native_marker)){var t=this.map,u=a._native_marker;setTimeout(function(){t.removeLayer(u)},250)}return SC.none(i)||(s.bindPopup(i),SC.none(j)||setTimeout(function(){s&&s._popup&&s._map&&s.openPopup()},f?1e3:1)),a._native_marker=s,o&&(a.getNativePosition=function(){return KG.LonLat.create({lon:s._latlng.lng,lat:s._latlng.lat})}),f&&setTimeout(function(){$(".animated-marker").addClass("animated-marker-ready")},50),a},reAddMarker:function(a){a._native_marker&&(this.map.removeLayer(a._native_marker),this.map.addLayer(a._native_marker))},removeMarker:function(a){a._native_marker&&(this.map.removeLayer(a._native_marker),a._native_marker=null)},enableDraggableMarker:function(a){if(a&&a._native_marker){var b=a._native_marker;b.options.draggable=!0,b.dragging&&b.dragging.enable()}},disableDraggableMarker:function(a){if(a&&a._native_marker){var b=a._native_marker;b.options.draggable=!1,b.dragging&&b.dragging.disable()}},addWMSLayer:function(a){var b=new L.TileLayer.WMS(a.get("url"),{layers:a.get("name"),transparent:YES,format:"image/png",tiled:YES,tilesorigin:"0,0",no_gwc:NO,kg_layer:a.get("id"),kg_sandbox:KG.get("activeSandboxKey"),auth_token:KG.core_auth.get("authenticationToken"),counter:this._counter++});a._native_layer=b,localStorage.setItem(KG.localStorageLeafletCacheKey,this._counter),this.map.addLayer(b)},removeLayer:function(a){a._native_layer&&this.map.removeLayer(a._native_layer)},_counter:localStorage.getItem(KG.localStorageLeafletCacheKey)||1,refreshWMSLayer:function(a){if(a._native_layer){var b=a._native_layer;this.addWMSLayer(a);var c=this;setTimeout(function(){c.map.removeLayer(b)},500)}},mapSizeDidChange:function(a){this.map.invalidateSize(),a&&this.map.setView(new L.LatLng(a.get("lat"),a.get("lon")),this.map.getZoom())},showPopupMarker:function(a,b){var c=this._popupMarker;this.updatePopupMarkerPosition(a.get("lon"),a.get("lat")),c.setContent(b),c._opened||this.map.openPopup(c),setTimeout(function(){c._update(),setTimeout(function(){c._update()},100)},1)},updatePopupMarkerPosition:function(a,b){var c=this._popupMarker;c.setLatLng(new L.LatLng(b,a))},closePopup:function(){this.map.closePopup()},showPopupInfo:function(a,b){var c=this._popupInfo;c.setLatLng(new L.LatLng(a.get("lat"),a.get("lon"))),c.setContent(b),this.map.openPopup(c),setTimeout(function(){c._update(),setTimeout(function(){c._update()},100)},1)},updatePopupInfo:function(){this._popupInfo&&(this._popupInfo._updateLayout(),this._popupInfo._updatePosition(),this._popupInfo._adjustPan())},addHighlight:function(a){if(!a)return NO;var b=a.coords,c=a.geo_type,d={color:"#0033ff",weight:5,opacity:.5,fillColor:null,fillOpacity:.2,clickable:!1},e=this.createLayerFromCoordinates(b,c,d);return this.map.addLayer(e),SC.Object.create({coords:b,geo_type:c,_native_hl:e})},removeHighlight:function(a){return a&&a._native_hl?(this.map.removeLayer(a._native_hl),YES):NO},createLayerFromCoordinates:function(a,b,c){var d;b?b=b.toLowerCase():b="point";if(b==="point"||b==="multipoint"){var e=new L.LatLng(a[0].y,a[0].x);c.radius=7,c.weight=2,c.fill=YES,d=new L.CircleMarker(e,c)}else if(b==="linestring"||b==="multilinestring"){var f=[];a.forEach(function(a){var b=new L.LatLng(a.y,a.x);f.push(b)}),d=new L.Polyline(f,c)}else if(b==="polygon"||b==="multipolygon"){var f=[];a.forEach(function(a){var b=new L.LatLng(a.y,a.x);f.push(b)}),d=new L.Polygon(f,c)}return d},_temp:null,_temp2:null,printBoundsA:function(){SC.none(this._temp)||this.map.removeLayer(this._temp),SC.none(this._temp2)||this.map.removeLayer(this._temp2),console.log(this.map.getBounds());var a=this.getBoundsA()[0],b=a.sw,c=a.ne,d=new L.LatLng(b.lat,b.lon),e=new L.LatLng(c.lat,b.lon),f=new L.LatLng(c.lat,c.lon),g=new L.LatLng(b.lat,c.lon),h=[d,e,f,g];return this._temp=new L.Polygon(h),this.map.addLayer(this._temp),a=this.getBoundsA()[1],a&&(b=a.sw,c=a.ne,d=new L.LatLng(b.lat,b.lon),e=new L.LatLng(c.lat,b.lon),f=new L.LatLng(c.lat,c.lon),g=new L.LatLng(b.lat,c.lon),h=[d,e,f,g],this._temp2=new L.Polygon(h,{color:"red"}),this.map.addLayer(this._temp2)),this.getBoundsA()},printBounds:function(){SC.none(this._temp)||this.map.removeLayer(this._temp);var a=this.getBounds(),b=a.sw,c=a.ne,d=new L.LatLng(b.lat,b.lon),e=new L.LatLng(c.lat,b.lon),f=new L.LatLng(c.lat,c.lon),g=new L.LatLng(b.lat,c.lon),h=[d,e,f,g];return this._temp=new L.Polygon(h),this.map.addLayer(this._temp),a},removeShadow:function(a){a._native_marker&&a._native_marker._shadow&&(a._native_marker._map._panes.shadowPane.removeChild(a._native_marker._shadow),a._native_marker._shadow=undefined)}}),L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],attribution:"Bing"},initialize:function(a,b){L.Util.setOptions(this,b),this._key=a,this._url=null,this.meta={},this._update_tile=this._update,this._update=function(){if(this._url==null)return;this._update_attribution(),this._update_tile()},this.loadMetadata()},tile2quad:function(a,b,c){var d="";for(var e=c;e>0;e--){var f=0,g=1<<e-1;(a&g)!=0&&(f+=1),(b&g)!=0&&(f+=2),d+=f}return d},getTileUrl:function(a,b){var c=this.options.subdomains,d=this.options.subdomains[(a.x+a.y)%c.length];return this._url.replace("{subdomain}",d).replace("{quadkey}",this.tile2quad(a.x,a.y,b)).replace("{culture}","")},loadMetadata:function(){var a=this,b="_bing_metadata";window[b]=function(c){a.meta=c,window[b]=undefined;var d=document.getElementById(b);d.parentNode.removeChild(d);if(c.errorDetails){alert("Got metadata"+c.errorDetails);return}a.initMetadata()};var c="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/Road?include=ImageryProviders&jsonp="+b+"&key="+this._key,d=document.createElement("script");d.type="text/javascript",d.src=c,d.id=b,document.getElementsByTagName("head")[0].appendChild(d)},initMetadata:function(){var a=this.meta.resourceSets[0].resources[0];this.options.subdomains=a.imageUrlSubdomains,this._url=a.imageUrl,this._providers=[];for(var b=0;b<a.imageryProviders.length;b++){var c=a.imageryProviders[b];for(var d=0;d<c.coverageAreas.length;d++){var e=c.coverageAreas[d],f={zoomMin:e.zoomMin,zoomMax:e.zoomMax,active:!1},g=new L.LatLngBounds(new L.LatLng(e.bbox[0]+.01,e.bbox[1]+.01),new L.LatLng(e.bbox[2]-.01,e.bbox[3]-.01));f.bounds=g,f.attrib=c.attribution,this._providers.push(f)}}this._update()},_update_attribution:function(){var a=this._map.getBounds(),b=this._map.getZoom();for(var c=0;c<this._providers.length;c++){var d=this._providers[c];b>d.zoomMax||b<d.zoomMin||!this._intersects(a,d.bounds)?(d.active&&this._map.attributionControl.removeAttribution(d.attrib),d.active=!1):(d.active||this._map.attributionControl.addAttribution(d.attrib),d.active=!0)}},_intersects:function(a,b){var c=a.getSouthWest(),d=a.getNorthEast(),e=b.getSouthWest(),f=b.getNorthEast();return e.lat<=d.lat&&e.lng<=d.lng&&c.lat<=f.lat&&c.lng<=f.lng}}),KG.core_leaflet=KG.MapLeaflet.create({}),KG.core_highlight=SC.Object.create({map:KG.core_leaflet,clearHighlight:function(a){a&&this.map.removeHighlight(a)},highlightFeature:function(a){if(!a)return NO;try{return this.map.addHighlight(a.get("geo"))}catch(b){return null}},clearHighlightMarker:function(a){a&&this.map.removeMarker(a)},addHighlightMarker:function(a){if(!a)return NO;try{var b={title:null,animated:NO,iconPath:"css/images/highlight.png",draggable:NO,dragendTarget:this,dragendCb:this.markerDragged,injectGetNativePositionFunction:YES},c=Ember.Object.create({lon:function(){return this.getNativePosition().get("lon")}.property(),lat:function(){return this.getNativePosition().get("lat")}.property()});return this.map.addMarker(c,a.get("lon"),a.get("lat"),b)}catch(d){return NO}},markerDragged:function(a,b,c){KG.statechart.sendAction("markerDragEnded",b,c)}});var fr={_logout:"Déconnection",_sandboxesListOne:"Votre projet:",_sandboxesList:"Vos %@ projets:",_sandboxesNothing:"Vous n'avez pas de projet.",_errorLoading:"Erreur lors du chargement des projets.",_welcomeUser:"Bienvenue %@","_wrong-membership":"Vous n'être pas membre de ce projet.",_sbDateFormat:"%@/%@/%@",_by:"Par",_createSandboxTitle:"Créer un nouveau projet",_add:"Ajouter",_cancelTooltip:"Annuler",_commitTooltip:"Sauvegarder",_sandboxName:"Le nom du projet",_nameAlreadyTaken:"Vous avez déjà un projet de ce nom.",_position:"Emplacement de départ",_requestError:"Erreur, le nom du projet semble invalide.",_serverError:"Erreur du serveur, veuillez réessayer plus tard.",_delete:"Supprimer",_sandboxDescription:"Par %@ à %@",_leave:"Quitter",_cancel:"Annuler"},en={_logout:"Logout",_sandboxesListOne:"Your projet:",_sandboxesList:"Your %@ projets:",_sandboxesNothing:"You don't have any project.",_errorLoading:"Cannot load the projects.",_welcomeUser:"Welcome %@","_wrong-membership":"You are not a member of this project.",_sbDateFormat:"%@/%@/%@",_by:"By",_createSandboxTitle:"Create a new sandbox",_add:"Add",_cancelTooltip:"Cancel",_commitTooltip:"Save",_sandboxName:"The Sandbox Name",_nameAlreadyTaken:"You already have a sandbox with that name",_position:"Start Position",_requestError:"Error, the sandbox's name might be invalid.",_serverError:"Server error, please try again later.",_delete:"Delete",_sandboxDescription:"By %@ at %@",_leave:"Leave",_cancel:"Cancel"};KG.lang==="fr"?jQuery.extend(Ember.STRINGS,fr):jQuery.extend(Ember.STRINGS,en),KG.core_home=SC.Object.create({createSandboxTitle:"_createSandboxTitle".loc(),map:KG.MapLeaflet.create({baseLayer:"OSM"}),connectedUserLabel:function(){var a=KG.core_auth.get("activeUser");return a?"_welcomeUser".loc(a.name):""}.property("KG.core_auth.activeUser"),loadSandboxList:function(){KG.sandboxesController.get("content")&&KG.sandboxesController.get("content").destroy(),KG.store.unloadRecords(KG.Sandbox),KG.sandboxesController.set("recordsReady",NO);var a;a=KG.store.find(KG.SANDBOX_QUERY),KG.sandboxesController.set("content",a),a.onReady(this,this._onListReady),a.onError(this,this._onListError)},_onListReady:function(a){KG.sandboxesController.set("recordsReady",YES),a.offError()},_onListError:function(a){KG.homePanelController.set(errorMessage,"_errorLoading".loc())}}),KG.sandboxesController=Ember.ArrayController.create({content:null,recordsReady:NO,title:"",recordsReadyChange:function(){var a;if(this.get("recordsReady")){var b=this.get("length");b>0?b===1?a="_sandboxesListOne".loc():a="_sandboxesList".loc(b):a="_sandboxesNothing".loc()}else a="";this.set("title",a)}.observes("recordsReady","content.length")}),KG.addSandboxController=Ember.Object.create({name:"",cancelCreateTooltip:"_cancelTooltip".loc(),commitCreateTooltip:"_commitTooltip".loc()}),KG.deleteController=Ember.ArrayController.create({content:[]}),KG.homePanelController=Ember.Object.create({listSandboxHidden:NO,listSandboxPushed:NO,addSandboxHidden:YES,addSandboxPushed:YES,deleteMode:NO,createSandboxButtonDisabled:NO,addTitle:"_createSandboxTitle".loc(),errorMessage:"",listTitle:function(){return KG.sandboxesController.get("title")}.property("KG.sandboxesController.title"),setListSandboxActive:function(){clearTimeout(this._timeout);var a=this;this.set("listSandboxHidden",NO),this.set("listSandboxPushed",NO),this.set("addSandboxPushed",YES),this._timeout=setTimeout(function(){a.set("addSandboxHidden",YES)},700)},setAddSandboxActive:function(){clearTimeout(this._timeout);var a=this;this.set("addSandboxHidden",NO),this.set("addSandboxPushed",NO),this.set("listSandboxPushed",YES),this._timeout=setTimeout(function(){a.set("listSandboxHidden",YES),KG.core_home.map.setCenter(KG.LonLat.create({lon:-72,lat:46}),6),KG.core_home.map.mapSizeDidChange()},700)}}),KG.AddSandboxView=Ember.View.extend({classNameBindings:["hidden","pushed"],hiddenBinding:"KG.homePanelController.addSandboxHidden",pushedBinding:"KG.homePanelController.addSandboxPushed"}),KG.DeleteCheckboxView=KG.Button.extend({classNameBindings:["KG.homePanelController.deleteMode:is-visible"],isChecked:NO,isOwner:function(){var a=this.getPath("itemView.content");return a&&KG.core_auth.get("activeUser")&&a.get("owner")===KG.core_auth.get("activeUser").id?YES:NO}.property("itemView.content"),deleteListDidChange:function(){var a=this.getPath("itemView.content");KG.deleteController.indexOf(a)>-1?this.set("isChecked",YES):this.set("isChecked",NO)}.observes("itemView.content","KG.deleteController.length")}),KG.SandboxListView=Ember.View.extend({classNameBindings:["hidden","pushed"],hiddenBinding:"KG.homePanelController.listSandboxHidden",pushedBinding:"KG.homePanelController.listSandboxPushed"}),KG.SandboxView=KG.Button.extend({triggerAction:function(){console.log("open!!"),KG.statechart.sendAction("openSandboxAction",this.getPath("itemView.content.guid"))}}),KG.TitleView=SC.View.extend({titleStringBinding:"KG.homePanelController.listTitle"}),Ember.TEMPLATES["sandbox-list"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e=a,f="titleString",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n"),e={},f="KG.sandboxesController",e.contentBinding=f,f="sandbox-list",e["class"]=f,f=d.collection||a.collection,l=m.program(4,u,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\n"),e=a,f="KG.Button",g={},h="create-sandbox-button",g.id=h,h="white-button",g["class"]=h,h="createSandboxAction",g.sc_action=h,h="KG.core_home.createSandboxTitle",g.titleBinding=h,h="KG.sandboxesController.recordsReady",g.isVisibleBinding=h,h=d.view||a.view,l=m.program(10,y,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),e=a,f="KG.Button",g={},h="delete-mode-button",g.id=h,h="white-button",g["class"]=h,h="toggleDeleteSandboxModeAction",g.sc_action=h,h="KG.core_home.deleteSandboxTitle",g.titleBinding=h,h="KG.sandboxesController.recordsReady",g.isVisibleBinding=h,h="KG.homePanelController.deleteMode",g.classBinding=h,h=d.view||a.view,l=m.program(12,z,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\n"),e=a,f="KG.Button",g={},h="delete-sandbox-button",g.id=h,h="red-button",g["class"]=h,h="deleteSandboxAction",g.sc_action=h,h="KG.homePanelController.deleteMode",g.classBinding=h,h=d.view||a.view,l=m.program(14,A,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.SandboxView",g={},h="div",g.tagName=h,h="sandbox-list-item common-list-button",g["class"]=h,h=d.view||a.view,l=m.program(5,v,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.DeleteCheckboxView",g={},h="sb-item-check check-delete-button",g["class"]=h,h="checkSandboxAction",g.sc_action=h,h="isChecked isOwner",g.classBinding=h,h=d.view||a.view,l=m.program(6,w,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t"),e={},f="span",e.tagName=f,f="sandbox-name",e["class"]=f,f=d.view||a.view,l=m.program(8,x,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t<div class="info-line">\n\t\t\t\t'),e=a,f="itemView.content.formattedDescription",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t</div>\n\t\t"),c}function w(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t<span>✓</span> "),e=a,f="_leave",g={},h="span",g.tagName=h,h=d.loc||a.loc,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"loc",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t"),c}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t"),e=a,f="itemView.content.name",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t"),c}function y(a,b){b.buffer.push("\n\t<div></div>\n")}function z(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t<div></div>\n\t"),e=a,f="_cancel",g={},h="span",g.tagName=h,h=d.loc||a.loc,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"loc",f,l):e=h,b.buffer.push(q(e)+"\n"),c}function A(a,b){var c="",e,f,g;return b.buffer.push("\n\t"),e=a,f="_delete",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"\n"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return h=c,i="KG.TitleView",j={},k="sandboxes-title",j.id=k,k="page-title",j["class"]=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h=d.view||c.view,l=m.program(3,t,f),l.hash={},l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=f,typeof h===n?h=h.call(c,l):h=r.call(c,h,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\t\t"),g}),Ember.TEMPLATES["add-sandbox"]=Handlebars.template(function(b,c,d,e,f){function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e=a,f="KG.homePanelController.addTitle",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"_triageMustache",f,j):e=h,b.buffer.push(o(e)+"\n"),c}function r(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t<div>\n\t\t"),e=a,f="KG.TextField",g={},h="_sandboxName",g.placeholder_not_loc=h,h="KG.addSandboxController.name",g.valueBinding=h,h=d.view||a.view,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"view",f,j):e=h,b.buffer.push(o(e)+"\t\n\t</div>\n\t"),e=a,f="_position",g={},h="field-label",g["class"]=h,h=d.loc||a.loc,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"loc",f,j):e=h,b.buffer.push(o(e)+'\n\t<div id="add-sandbox-map"></div>\n\t'),e=a,f="KG.Button",g={},h="white-button",g["class"]=h,h="cancelCreateAction",g.sc_action=h,h="KG.addSandboxController.cancelCreateTooltip",g.titleBinding=h,h="KG.homePanelController.createSandboxInProgress",g.disabledBinding=h,h=d.view||a.view,j=k.program(4,s,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e=a,f="KG.Button",g={},h="white-button",g["class"]=h,h="commitCreateAction",g.sc_action=h,h="KG.addSandboxController.commitCreateTooltip",g.titleBinding=h,h="KG.homePanelController.createSandboxInProgress",g.disabledBinding=h,h=d.view||a.view,j=k.program(6,t,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function s(a,b){b.buffer.push('\n\t\t<img src="css/images/cancel_30.png">\n\t')}function t(a,b){b.buffer.push('\n\t\t<img src="css/images/checkmark_30.png">\n\t')}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k=this,l="function",m=d.helperMissing,n=void 0,o=this.escapeExpression,p=d.blockHelperMissing;return h={},i="add-sandbox-title",h.id=i,i="page-title",h["class"]=i,i=d.view||c.view,j=k.program(1,q,f),j.hash=h,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=f,typeof i===l?h=i.call(c,j):h=p.call(c,i,j),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h={},i="inner-add-sandbox-panel",h.id=i,i=d.view||c.view,j=k.program(3,r,f),j.hash=h,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=f,typeof i===l?h=i.call(c,j):h=p.call(c,i,j),(h||h===0)&&f.buffer.push(h),g});var fr={_me:"Moi",_save:"Sauvegarde",_cancel:"Annuler",_close:"Fermer",_Map:"Carte",_Note:"Note",_Notes:"%@ Notes",_notes_:"Notes",_createNote:"Créer une note",_cancelCreateNote:"Annuler la création",_newNote:"Nouvelle note",_Delete:"Supprimer",_backHome:"Retour",_noteTitle:"Titre:",_noteDescription:"Description:",_noteConfirm:"Créer",_noteUpdate:"Mise à jour",_noteTitlePlaceholder:"Votre note",_moveNote:"Glisser la note où vous le voulez.",_author:"Par %@",_0comment:"Ajouter un commentaire",_1comment:"Un Commentaire",_comments:"%@ Commentaires",_0hideComment:"Cacher",_1hideComment:"Cacher le commentaire",_hideComments:"Cacher les %@ commentaires",_commentPlaceholder:"Écrire un commentaire...",_closeInspectorTitle:"Fermer l'inspecteur",_cancelInspectorTitle:"Annuler les changements",_saveInspectorTitle:"Sauvegarder les changements",_saveInspectorLabel:"Sauvegarde",_closeSearch:"Fermer la fenêtre de résultat",_search:"Recherche...",_searchResult:"%@ Résultats pour %@ dans %@",_unknown:"Élément",_searchGoogle:"Rechercher Google",_searchGeonames:"Rechercher Geonames",_searchOSM:"Rechercher OSM",_searchYahoo:"Rechercher Yahoo",_notificationTitle:"Notifications",_notificationClear:"Effacer",_notificationSendText:"Envoyer un message",_notificationSendButton:"Envoyer",_bookmarkTitle:"Signets",_bookmarkAdd:"Ajouter",_bookmarkEdit:"Modifier",_bookmarkDialogTitle:"Ajouter un signet",_bookmarkCloseDialogTitle:"Fermer la fenêtre d'ajout de signet",_textMessageTitle:" a envoyé un message à ",_sendOnEnterTooltip:"Envoyer le message en appuyant sur Retour",_failedToSendMessage:"Impossible d'envoyer le message.",_timeoutSendMessage:"Erreur lors de l'envoi du message.",_sendMessageSuccessful:"Message envoyé.",_otherValue:"Autre...",_paletteTitle:"Palette",_showPalette:"Afficher la Palette",_moveFeature:"Glisser le nouveau '%@' où vous le voulez.",_bookmarkDescription:"Par %@ à %@",_showMore:"Plus de Résultats"},en={_me:"Me",_save:"Save",_cancel:"Cancel",_close:"Close",_Map:"Map",_Note:"Note",_Notes:"%@ Notes",_notes_:"Notes",_createNote:"Create Note",_cancelCreateNote:"Cancel create note",_newNote:"New note",_Delete:"Delete",_backHome:"Return",_noteTitle:"Title:",_noteDescription:"Description:",_noteConfirm:"Create",_noteUpdate:"Update",_noteTitlePlaceholder:"Your note",_moveNote:"Drag the note where you want.",_author:"By %@",_0comment:"Add a comment",_1comment:"One comment",_comments:"%@ comments",_0hideComment:"Hide",_1hideComment:"Hide the comment",_hideComments:"Hide the %@ comments",_commentPlaceholder:"Write a comment...",_closeInspectorTitle:"Close the Inspector",_cancelInspectorTitle:"Cancel the Changes",_saveInspectorTitle:"Save the Changes",_saveInspectorLabel:"Save",_closeSearch:"Close the result window",_search:"Search...",_searchResult:"%@ Results for %@ in %@",_unknown:"Feature",_searchGoogle:"Search Google",_searchGeonames:"Search Geonames",_searchOSM:"Search OSM",_searchYahoo:"Search Yahoo",_notificationTitle:"Notifications",_notificationClear:"Clear",_notificationSendText:"Send a Message",_notificationSendButton:"Send",_bookmarkTitle:"Bookmarks",_bookmarkAdd:"Add",_bookmarkEdit:"Edit",_bookmarkDialogTitle:"Add a Bookmark",_bookmarkCloseDialogTitle:"Close the add bookmark dialog",_textMessageTitle:" send a text message at ",_sendOnEnterTooltip:"Send the message on Enter",_failedToSendMessage:"Cannot send the message.",_timeoutSendMessage:"Failed to send message.",_sendMessageSuccessful:"Message envoyé.",_otherValue:"Other...",_paletteTitle:"Palette",_showPalette:"Show the Palette",_moveFeature:"Drag the new '%@' where you want.",_bookmarkDescription:"By %@ at %@",_showMore:"More Results"};KG.lang==="fr"?jQuery.extend(Ember.STRINGS,fr):jQuery.extend(Ember.STRINGS,en),KG.core_sandbox=SC.Object.create({sandboxMeta:{},membership:null,isSandboxOwner:NO,sandboxLabel:"",mousePosition:null,mapAdded:NO,cleanUp:function(){this.set("sandboxMeta",{}),this.set("membership",null),this.set("isSandboxOwner",NO),this.set("sandboxLabel",""),this.set("mousePosition",null),KG.store.unloadRecords(KG.FeatureType),KG.store.unloadRecords(KG.AttrType),KG.store.unloadRecords(KG.Bookmark),KG.store.unloadRecords(KG.Feature),KG.core_layer.cleanUp(),KG.store.unloadRecords(KG.Layer),KG.core_note.removeAllMarkers(),KG.store.unloadRecords(KG.Note),KG.store.unloadRecords(KG.NoteMarker),this.setCenter(null,null),KG.activeUserController.set("activePopup",NO),this._clearRecordArray(KG.bookmarksController.get("content")),this._clearRecordArray(KG.layersController.get("content")),this._clearRecordArray(KG.paletteController.get("content")),this._clearRecordArray(KG.searchController.get("content"))},_clearRecordArray:function(a){!Ember.none(a)&&a.destroy&&a.destroy()},setCenter:function(a,b){a?window.location.hash="sb:%@;lon:%@;lat:%@;zoom:%@".fmt(KG.get("activeSandboxKey"),a.get("lon").toFixed(4),a.get("lat").toFixed(4),b):window.location.hash=""},authenticate:function(){var a=KG.core_auth.load(this,this.authenticateCallback);return a},authenticateCallback:function(a){a==="_success"?($.ajax({type:"POST",url:KG.get("serverHost")+"api_map/public/login?sandbox=%@".fmt(KG.get("activeSandboxKey")),dataType:"json",headers:KG.core_auth.createAjaxRequestHeaders(),contentType:"application/json; charset=utf-8",context:this,error:function(a,b,c){SC.Logger.error("Map login error: HTTP error status code: "+a.status)},success:function(a,b,c){console.log("Map login success."),KG.statechart.sendAction("mapLoginSucceeded",this)},async:YES}),KG.statechart.sendAction("authenticationSucceeded",this)):KG.statechart.sendAction("authenficationFailed",this)},membershipCheck:function(){$.ajax({type:"GET",url:KG.get("serverHost")+"api_data/protected/members/logged_member?sandbox=%@".fmt(KG.get("activeSandboxKey")),dataType:"json",contentType:"application/json; charset=utf-8",headers:KG.core_auth.createAjaxRequestHeaders(),context:this,error:function(a,b,c){SC.Logger.error("Membership error: HTTP error status code: "+a.status),KG.statechart.sendAction("membershipFailed",this)},success:function(a,b,c){console.log("SB Meta success."),this.set("membership",a),KG.statechart.sendAction("membershipSucceeded",this)},async:YES})},fetchSandboxMeta:function(){$.ajax({type:"GET",url:KG.get("serverHost")+"api_sandbox/protected/sandboxes/%@/meta".fmt(KG.get("activeSandboxKey")),dataType:"json",contentType:"application/json; charset=utf-8",headers:KG.core_auth.createAjaxRequestHeaders(),context:this,error:function(a,b,c){SC.Logger.error("SB Meta error: HTTP error status code: "+a.status),KG.statechart&&KG.statechart.sendAction("httpError",a.status)},success:function(a,b,c){console.log("SB Meta success."),this.set("sandboxMeta",a);var d=a.lat,e=a.lon,f=a.zoom,g=this.extractHashValues();g.lon||d&&e&&KG.core_leaflet.setCenter(KG.LonLat.create({lon:e,lat:d}),f)},async:YES})},metaDidChange:function(){console.log("Meta changed."),KG.core_sandbox.set("sandboxLabel",this.get("sandboxMeta").name),this.set("isSandboxOwner",KG.core_auth.get("activeUser").id===this.get("sandboxMeta").owner)}.observes("sandboxMeta"),extractHashValues:function(){var a=window.location.hash;if(a&&a.length>0){var b=a.split(";");if(b.length===4)return{lon:parseFloat(b[1].substring(4)),lat:parseFloat(b[2].substring(4)),zoom:parseInt(b[3].substring(5))}}return{}},addMap:function(){var a=this.extractHashValues();this.get("mapAdded")?a.lon&&a.lat&&KG.core_leaflet.setCenter(KG.LonLat.create({lon:a.lon,lat:a.lat}),a.zoom):(this.set("mapAdded",YES),KG.core_leaflet.addToDocument(a.lon,a.lat,a.zoom))},createNote:function(){KG.statechart.sendAction("createNoteAction")},latitudeLabel:function(){var a=this.get("mousePosition");return a?"Lat: %@".fmt(a.get("lat").toFixed(4)):"Lat: ?"}.property("mousePosition"),longitudeLabel:function(){var a=this.get("mousePosition");return a?"Lon: %@".fmt(a.get("lon").toFixed(4)):"Lon: ?"}.property("mousePosition"),autosize:function(a,b){b||(b={extraSpace:20});var c=$(a);c[0]?c.autoResize(b):setTimeout(function(){var c=$(a);c[0]&&c.autoResize(b)},300)},destroyAutosize:function(a){var b=$(a).data("AutoResizer");b&&b.destroy()},hasWriteAccess:function(){var a=this.get("membership");return Ember.none(a)?NO:a.access_type==="owner"||a.access_type==="write"}.property("membership")}),KG.activeUserController=Ember.Object.create({name:null,activePopup:NO,activeUserDidChange:function(){KG.core_auth.get("activeUser")?this.set("name",KG.core_auth.get("activeUser").name):this.set("name","")}.observes("KG.core_auth.activeUser")}),KG.UserButtonView=KG.Button.extend({activePopup:NO,activePopupBinding:"KG.activeUserController.activePopup",activePopupDidChange:function(){this.set("isActive",this.get("activePopup"))}.observes("activePopup"),isActiveDidChange:function(){this.get("activePopup")&&this.set("isActive",YES)}.observes("isActive"),triggerAction:function(){KG.statechart.sendAction("toggleUserOptionsPopupAction")}}),Ember.TEMPLATES["page-header"]=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e=a,f="KG.Button",g={},h="active-sandbox-button",g.id=h,h="div",g.tagName=h,h="header-button",g["class"]=h,h="yes",g.disabled=h,h=d.view||a.view,i=j.program(2,q,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e={},f="active-user-panel",e.templateName=f,f=d.view||a.view,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"view",i):e=f,b.buffer.push(n(e)+"\n\t"),e=a,f="KG.Button",g={},h="palette-button",g.id=h,h="div",g.tagName=h,h="header-button header-button-icon",g["class"]=h,h="showPaletteAction",g.sc_action=h,h=d.view||a.view,i=j.program(4,r,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e=a,f="KG.Button",g={},h="create-note-button",g.id=h,h="div",g.tagName=h,h="header-button header-button-icon",g["class"]=h,h="createNoteAction",g.sc_action=h,h=d.view||a.view,i=j.program(6,s,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e={},f="notification-panel",e.templateName=f,f=d.view||a.view,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"view",i):e=f,b.buffer.push(n(e)+"\n\t\n\t"),e=a,f="KG.Button",g={},h="search-button",g.id=h,h="div",g.tagName=h,h="toogleSearchPopopAction",g.sc_action=h,h="header-button header-button-icon",g["class"]=h,h="KG.searchController.activePopup",g.classBinding=h,h=d.view||a.view,i=j.program(8,t,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\n\t"),e={},f="bookmark-panel",e.templateName=f,f=d.view||a.view,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"view",i):e=f,b.buffer.push(n(e)+"\n"),c}function q(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t<div class="message-label"><span class="label-ellipsis">'),e=a,f="KG.core_sandbox.sandboxLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</span></div>\n\t"),c}function r(a,b){b.buffer.push('\n\t\t<img src="css/images/palette.png">\n\t')}function s(a,b){b.buffer.push('\n\t\t<img src="css/images/note.png">\n\t')}function t(a,b){b.buffer.push('\n\t\t\t<span class="button-image"><span>\n\t')}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="header",g.tagName=h,h="sandbox-header",g.id=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["active-user-panel"]=Handlebars.template(function(b,c,d,e,f){function r(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t<div class="message-label"><span class="label-ellipsis">'),e=a,f="KG.activeUserController.name",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"_triageMustache",f,k):e=h,b.buffer.push(p(e)+"</span></div>\n\t"),e={},f="super-active-user-popup",e.id=f,f="activePopup",e.isVisibleBinding=f,f=d.view||a.view,k=l.program(2,s,b),k.hash=e,k.contexts=[],k.fn=k,k.inverse=l.noop,k.data=b,typeof f===m?e=f.call(a,k):e=q.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function s(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t"),e={},f="active-user-popup",e.id=f,f=d.view||a.view,k=l.program(3,t,b),k.hash=e,k.contexts=[],k.fn=k,k.inverse=l.noop,k.data=b,typeof f===m?e=f.call(a,k):e=q.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\t\t\t\t\t\n\t\t\t\t\t"),e=a,f="KG.Button",g={},h="backHomeAction",g.sc_action=h,h=d.view||a.view,k=l.program(4,u,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t"),c}function u(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="_backHome",g=d.loc||a.loc,k={},k.hash={},k.contexts=[],k.contexts.push(e),k.data=b,typeof g===m?e=g.call(a,f,k):g===o?e=n.call(a,"loc",f,k):e=g,b.buffer.push(p(e)+"\n\t\t\t\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j,k,l=this,m="function",n=d.helperMissing,o=void 0,p=this.escapeExpression,q=d.blockHelperMissing;g=c,h="KG.UserButtonView",i={},j="active-user-button",i.id=j,j="div",i.tagName=j,j="header-button",i["class"]=j,j=d.view||c.view,k=l.program(1,r,f),k.hash=i,k.contexts=[],k.contexts.push(g),k.fn=k,k.inverse=l.noop,k.data=f,typeof j===m?g=j.call(c,h,k):g=q.call(c,j,h,k),g||g===0?f.buffer.push(g):f.buffer.push("")}),KG.core_search=SC.Object.create({plugins:[],searchAsked:NO,_view:null,createView:function(){if(!this._view){var a=this;setTimeout(function(){a._view=Ember.View.create({templateName:"search-panel"}),a._view.appendTo("#main-sandbox-view")},1e3)}},addPlugin:function(a){this.plugins.pushObject(a)},searchFeatures:function(){var a=KG.searchController.get("searchValue"),b=KG.searchController.get("content"),c=KG.store;b&&b.destroy&&(b.forEach(function(a){c.unloadRecord(KG.SearchCategory,a.get("id"),a.get("storeKey"))}),b.destroy()),console.log("search for:"+a),KG.SEARCH_QUERY.search=a;var d=c.find(KG.SEARCH_QUERY);KG.searchController.set("content",d),this.plugins.forEach(function(b){b.set("searchValue",a)}),this.set("searchAsked",YES)},clearSearchFeatures:function(){KG.searchController.set("searchValue","");var a=KG.searchController.get("content"),b=KG.store;a&&a.destroy&&(a.forEach(function(a){b.unloadRecord(KG.SearchCategory,a.get("id"),a.get("storeKey"))}),a.destroy()),KG.searchController.set("content",[]),this.set("searchAsked",NO)},showResults:function(){KG.searchResultsController.get("category")&&KG.searchResultsController.setPath("category.queryBlock",null);var a=KG.searchResultsController.get("content");a&&a.destroy&&a.destroy(),KG.searchResultsController.set("content",[]),KG.searchResultsController.set("listVisible",YES);var b=KG.searchResultsController.get("category");if(SC.none(b)){var c=KG.searchResultsController.get("plugin");KG.searchResultsController.set("content",null),SC.none(c)||c.loadRecords(null,function(a){KG.searchResultsController.set("content",a)})}else{var d=b.findRecords(KG.searchResultsController.get("nextBlockStart"));d.onReady&&d.onReady(this,this._addResults)}},showMoreResults:function(){var a=KG.searchResultsController.get("category");if(a){var b=a.findRecords(KG.searchResultsController.get("nextBlockStart"));b.onReady&&b.onReady(this,this._addResults)}},_addResults:function(a){var b=KG.searchResultsController.get("content");a.forEach(function(a){b.pushObject(a)}),KG.searchResultsController.set("content",b),a.destroy()},hideResults:function(){KG.searchResultsController.set("listVisible",NO),setTimeout(function(){var a=KG.searchResultsController.get("content");a&&a.destroy&&a.destroy(),KG.searchResultsController.set("category",null),KG.searchResultsController.set("content",[]),KG.core_search.clearSearchFeatures()},800)}}),KG.searchController=Ember.ArrayController.create({content:[],searchHistorySize:5,searchValue:null,activePopup:NO,hasResults:function(){return this.getPath("content.length")>0}.property("content.length")}),KG.searchResultsController=Ember.ArrayController.create({content:[],closeLabel:"_closeSearch".loc(),listVisible:NO,category:null,plugin:null,listTitle:function(){if(SC.none(this.get("content")))return"";var a=this.get("category");if(!SC.none(a))return"_searchResult".loc(this.getPath("content.length"),a.get("search"),a.get("title"));var b=this.get("plugin");if(!SC.none(b))return"_searchResult".loc(this.getPath("content.length"),b.get("searchValue"),b.get("pluginName"))}.property("content.length"),hasResults:function(){return this.getPath("content.length")>0}.property("content.length"),hasMoreResults:function(){var a=this.get("category");if(a){var b=this.getPath("category.queryBlock");if(b){var c=b.get("start")+b.get("resultSize");if(c<a.get("count")&&b.get("resultSize")>0)return YES}}return NO}.property("category.queryBlock"),nextBlockStart:function(){var a=this.getPath("category.queryBlock");return a?a.get("start")+a.get("resultSize"):0}.property("category.queryBlock")}),KG.SearchField=KG.TextField.extend({type:"search",insertNewline:function(){KG.statechart.sendAction("searchAction")},cancel:function(){this.set("value",""),this.$().blur()},valueDidChange:function(){this.get("value")===""&&KG.statechart.sendAction("clearSearchAction")}.observes("value")}),KG.RecordsButtonView=KG.Button.extend({recordsVisible:NO,tagName:"div",activeCategoryDidChange:function(){var a=this.get("content");a===KG.searchResultsController.get("category")?this.set("recordsVisible",YES):this.set("recordsVisible",NO)}.observes("KG.searchResultsController.category"),hasMoreResult:function(){return this.get("recordsVisible")?KG.searchResultsController.get("hasMoreResults"):NO}.property("recordsVisible","KG.searchResultsController.hasMoreResults"),records:function(){return this.get("recordsVisible")?KG.searchResultsController.get("content"):null}.property("recordsVisible","KG.searchResultsController.content")}),KG.PluginRecordsButtonView=KG.Button.extend({recordsVisible:NO,tagName:"div",activePluginDidChange:function(){var a=this.get("content");a===KG.searchResultsController.get("plugin")?this.set("recordsVisible",YES):this.set("recordsVisible",NO)}.observes("KG.searchResultsController.plugin"),records:function(){if(this.get("recordsVisible"))return KG.searchResultsController.get("content")}.property("recordsVisible","KG.searchResultsController.content")}),KG.core_google=SC.Object.create({title:"_searchGoogle".loc(),pluginName:"Google",searchValue:"",loadRecords:function(a,b){var c=this.get("searchValue");$.ajax({type:"GET",url:encodeURI("/maps/api/geocode/json?address=%@&sensor=true".fmt(c)),dataType:"json",contentType:"application/json; charset=utf-8",context:this,error:function(a,b,c){SC.Logger.error("Google error: HTTP error status code: "+a.status)},success:function(c,d,e){console.log("Google success.");var f=[];if(c&&c.results&&c.results.length>0){var g=c.results,h;for(h=0;h<g.length;h++){var i={x:g[h].geometry.location.lng,y:g[h].geometry.location.lat},j=KG.LonLat.create({lon:i.x,lat:i.y});f.pushObject(SC.Object.create({title:g[h].formatted_address,geo:{coords:[i],centroid:{x:i.x,y:i.y},geo_type:"Point"},center:j,hasCreateNote:YES}))}}b.call(a,f)},async:YES})}}),KG.core_search.addPlugin(KG.core_google),KG.core_geonames=SC.Object.create({title:"_searchGeonames".loc(),pluginName:"Geonames",searchValue:"",loadRecords:function(a,b){var c=this.get("searchValue");$.ajax({type:"GET",url:encodeURI("http://ws.geonames.org/searchJSON?q=%@&maxRows=10".fmt(c)),dataType:"json",context:this,error:function(a,b,c){SC.Logger.error("Geonames error: HTTP error status code: "+a.status)},success:function(c,d,e){console.log("Geonames success.");var f=[];if(c&&c.geonames&&c.geonames.length>0){var g=c.geonames,h;for(h=0;h<g.length;h++){var i={x:g[h].lng,y:g[h].lat},j=KG.LonLat.create({lon:i.x,lat:i.y});f.pushObject(SC.Object.create({title:"%@, %@".fmt(g[h].toponymName,g[h].countryName),geo:{coords:[i],centroid:{x:i.x,y:i.y},geo_type:"Point"},center:j,hasCreateNote:YES}))}}b.call(a,f)},async:YES})}}),KG.core_search.addPlugin(KG.core_geonames),KG.core_osm=SC.Object.create({title:"_searchOSM".loc(),pluginName:"OSM",searchValue:"",loadRecords:function(a,b){var c=this.get("searchValue");$.ajax({type:"GET",url:encodeURI("http://nominatim.openstreetmap.org/search?q=%@&format=json&limit=10".fmt(c)),dataType:"json",context:this,error:function(a,b,c){SC.Logger.error("OSM error: HTTP error status code: "+a.status)},success:function(c,d,e){console.log("OSM success.");var f=[];if(c&&c.length>0){var g=c,h;for(h=0;h<g.length;h++){var i={x:g[h].lon,y:g[h].lat},j=KG.LonLat.create({lon:i.x,lat:i.y});f.pushObject(SC.Object.create({title:"%@, %@".fmt(g[h].display_name),geo:{coords:[i],centroid:{x:i.x,y:i.y},geo_type:"Point"},center:j,hasCreateNote:YES}))}}b.call(a,f)},async:YES})}}),KG.core_search.addPlugin(KG.core_osm),KG.core_yahoo=SC.Object.create({title:"_searchYahoo".loc(),pluginName:"Yahoo",searchValue:"",appId:"7w0MZN32",loadRecords:function(a,b){var c=this.get("searchValue");$.ajax({type:"GET",url:encodeURI("http://where.yahooapis.com/geocode?q=%@&appid=%@&flags=J&count=10&locale=%@_CA".fmt(c,this.appId,KG.lang)),dataType:"json",context:this,error:function(a,b,c){SC.Logger.error("Yahoo error: HTTP error status code: "+a.status)},success:function(c,d,e){console.log("Yahoo success.");var f=[];if(c&&c.ResultSet&&c.ResultSet.Results){var g=c.ResultSet.Results,h;for(h=0;h<g.length;h++){var i={x:g[h].longitude,y:g[h].latitude},j=KG.LonLat.create({lon:i.x,lat:i.y}),k=["line1","line2","line3","line4"],l=[];k.forEach(function(a){var b=g[h][a];b&&b.length>0&&l.push(b)}),f.pushObject(SC.Object.create({title:l.join(","),geo:{coords:[i],centroid:{x:i.x,y:i.y},geo_type:"Point"},center:j,hasCreateNote:YES}))}}b.call(a,f)},async:YES})}}),KG.core_search.addPlugin(KG.core_yahoo),Ember.TEMPLATES["search-panel"]=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t"),e=a,f="KG.Button",g={},h="x-button search-close-button",g["class"]=h,h="toogleSearchPopopAction",g.sc_action=h,h=d.view||a.view,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"view",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t"),e={},f="search-popup",e.id=f,f=d.view||a.view,i=j.program(2,q,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t"),e=a,f="KG.SearchField",g={},h="KG.searchController.searchHistorySize",g.resultsBinding=h,h="_search",g.placeholder_not_loc=h,h="KG.searchController.searchValue",g.valueBinding=h,h=d.view||a.view,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"view",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t"),e={},f="KG.searchController",e.contentBinding=f,f="KG.searchController.hasResults",e.isVisibleBinding=f,f="search-cat-list",e["class"]=f,f="KG.RecordsButtonView",e.itemViewClass=f,f=d.collection||a.collection,i=j.program(3,r,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t"),e={},f="KG.core_search.plugins",e.contentBinding=f,f="KG.core_search.searchAsked",e.isVisibleBinding=f,f="search-cat-list",e["class"]=f,f="KG.PluginRecordsButtonView",e.itemViewClass=f,f=d.collection||a.collection,i=j.program(17,A,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t"),c}function r(a,b){var c="",e,f,g,h;return b.buffer.push("\t\t\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="search-cat-item common-list-button",g["class"]=h,h="div",g.tagName=h,h="selectSearchCategoryAction",g.sc_action=h,h="recordsVisible",g.recordsVisibleBinding=h,h="recordsVisible",g.classBinding=h,h=d.view||a.view,i=j.program(4,s,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t\t\t\t\t<div class="super-result-list">\n\t\t\t\t\t\t\t\t'),e={},f="records",e.contentBinding=f,f="search-result-list",e["class"]=f,f="recordsVisible",e.recordsVisibleBinding=f,f="recordsVisible",e.classBinding=f,f=d.collection||a.collection,i=j.program(9,v,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t\t\t\t\t\t<div class="more-panel">\n\t\t\t\t\t\t\t\t\t'),e=a,f="KG.Button",g={},h="white-button search-more-result",g["class"]=h,h="hasMoreResult",g.isVisibleBinding=h,h="showMoreResultsAction",g.sc_action=h,h=d.view||a.view,i=j.program(15,z,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t"),c}function s(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e={},f="cat-title-label label-ellipsis",e["class"]=f,f="itemView.content.title",e.titleBinding=f,f=d.view||a.view,i=j.program(5,t,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t"),e={},f="cat-size-label label-ellipsis capsule-label",e["class"]=f,f="span",e.tagName=f,f=d.view||a.view,i=j.program(7,u,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.count",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="search-record-item common-list-button",g["class"]=h,h="div",g.tagName=h,h="featureZoomAction",g.sc_action=h,h=d.view||a.view,i=j.program(10,w,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t"),c}function w(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t"),e={},f="label-ellipsis",e["class"]=f,f="itemView.content.title",e.titleBinding=f,f=d.view||a.view,i=j.program(11,x,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="itemView.content.isSelectable",g.isVisibleBinding=h,h="search-select",g["class"]=h,h="div",g.tagName=h,h="selectFeatureInspectorAction",g.sc_action=h,h=d.view||a.view,i=j.program(13,y,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),c}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t\t\t"),c}function y(a,b){b.buffer.push('\t\n\t\t\t\t\t\t\t\t\t\t\t<img src="css/images/right_arrow_24.png"/>\t\t\n\t\t\t\t\t\t\t\t\t\t\t')}function z(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t"),e=a,f="_showMore",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t\t"),c}function A(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="search-plugin-item common-list-button",g["class"]=h,h="div",g.tagName=h,h="selectSearchPluginAction",g.sc_action=h,h="recordsVisible",g.recordsVisibleBinding=h,h="recordsVisible",g.classBinding=h,h=d.view||a.view,i=j.program(18,B,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),e={},f="records",e.contentBinding=f,f="search-result-list",e["class"]=f,f="recordsVisible",e.recordsVisibleBinding=f,f="recordsVisible",e.classBinding=f,f=d.collection||a.collection,i=j.program(21,D,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t"),c}function B(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e={},f="plugin-title-label label-ellipsis",e["class"]=f,f="itemView.content.title",e.titleBinding=f,f=d.view||a.view,i=j.program(19,C,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),c}function C(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t"),c}function D(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="search-record-item common-list-button",g["class"]=h,h="div",g.tagName=h,h="featureZoomAction",g.sc_action=h,h=d.view||a.view,i=j.program(22,E,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),c}function E(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e={},f="label-ellipsis",e["class"]=f,f="itemView.content.title",e.titleBinding=f,f=d.view||a.view,i=j.program(23,F,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="itemView.content.hasCreateNote",g.isVisibleBinding=h,h="search-create-note",g["class"]=h,h="div",g.tagName=h,h="createNoteFromFeatureAction",g.sc_action=h,h=d.view||a.view,i=j.program(25,G,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t"),c}function F(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t\t\t\t\t\t"),c}function G(a,b){b.buffer.push('\t\n\t\t\t\t\t\t\t\t\t\t<img src="css/images/note_black.png"/>\t\t\n\t\t\t\t\t\t\t\t\t')}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="super-search-popup",g.id=h,h="KG.searchController.activePopup",g.classBinding=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),KG.core_inspector=SC.Object.create({_highlight:null,_view:null,_store:null,_commentsView:null,createView:function(){if(!this._view){var a=this;setTimeout(function(){a._view=Ember.View.create({templateName:"inspector"}),a._view.appendTo("#main-sandbox-view")},1e3)}},createFeature:function(a,b,c){this.commitModifications(),this._store=KG.store.chain();var d=this._store.createRecord(KG.Feature,{ft_id:a.get("id"),geo:a.getDefaultGeoFromPoint(b,c)});this.continueSelectFeature(d)},selectFeature:function(a){this.commitModifications(),this._store=KG.store.chain(),this.continueSelectFeature(a)},continueSelectFeature:function(a){this._commentsView&&this._commentsView.destroy(),this._commentsView=Ember.View.create({templateName:"feature-comments",classNames:["super-feature-comments"]}),this._commentsView.appendTo("#comment-super-panel"),KG.core_highlight.clearHighlight(this._highlight),this._highlight=KG.core_highlight.highlightFeature(a),a.get("status")!==SC.Record.READY_NEW&&(a=this._store.find(a)),KG.inspectorController.set("feature",a),KG.inspectorController.set("content",a.getAttributes())},removeHighlight:function(){SC.none(this._highlight)||(KG.core_highlight.clearHighlight(this._highlight),this._highlight=null)},commitModifications:function(){this._commentsView&&(this._commentsView.destroy(),this._commentsView=null);if(!SC.none(this._store)){this._store.commitChanges().destroy(),this._store=null;var a=KG.inspectorController.get("feature");KG.store.commitRecords(null,null,null,null,function(){setTimeout(function(){KG.core_layer.getMainWMSFor(a.get("featuretype")).forEach(function(a){KG.core_leaflet.refreshWMSLayer(a)})},1e3)})}},rollbackModifications:function(){this._commentsView&&(this._commentsView.destroy(),this._commentsView=null),SC.none(this._store)||(this._store.discardChanges(),this._store.destroy(),this._store=null)},fetchComments:function(a){var b=KG.inspectorController.get("feature");if(!SC.none(b)){var c=KG.store.find(b),d=function(){a||KG.featureCommentsController.set("isLoading",YES);var b=c.get("comments"),d={count:0,length:b.get("length"),records:[]};d.length>0?b.forEach(function(a){a.onReady(KG.core_inspector,KG.core_inspector.commentReady,d)}):(KG.featureCommentsController.set("isLoading",NO),KG.statechart.sendAction("featureCommentsReadyEvent"))};a?c.refresh(YES,d):c.onReady(null,d)}},commentReady:function(a,b){b.count++,b.records.pushObject(a),b.count===b.length&&(KG.statechart.sendAction("featureCommentsReadyEvent"),KG.featureCommentsController.set("isLoading",NO))},addComment:function(a){var b=KG.inspectorController.get("feature");if(b){var c=KG.store.createRecord(KG.FeatureComment,{comment:a,feature:b.get("id")});KG.store.commitRecords(null,null,[c.get("storeKey")]),c.onReady(null,function(){b.get("comments").get("editableStoreIds").pushObject(c.get("id")),KG.statechart.sendAction("featureCommentsReadyEvent")})}},deleteComment:function(a){var b=KG.inspectorController.get("feature");b.get("comments").get("editableStoreIds").removeObject(a.get("id")),a=KG.store.find(a),a.destroy(),KG.store.commitRecords(null,null,[a.get("storeKey")])},deleteFeature:function(){var a=KG.inspectorController.get("feature");a.destroy()}}),KG.inspectorController=Ember.ArrayController.create({content:[],feature:null,active:NO,title:function(){var a=this.get("feature");if(a)return a.get("title")}.property("feature.title"),isDirty:function(){var a=this.getPath("feature.status")&SC.Record.DIRTY;return a>0}.property("feature.status"),cancelTitle:"_cancelInspector".loc(),saveTitle:function(){if(this.get("isDirty"))return"_saveInspectorTitle".loc();"_closeInspectorTitle".loc()}.property("isDirty"),saveLabel:function(){return this.get("isDirty")?"_saveInspectorLabel".loc():"_close".loc()}.property("isDirty"),isReadOnly:function(){return!KG.core_sandbox.get("hasWriteAccess")}.property("KG.core_sandbox.hasWriteAccess"),isWriteable:function(){return!this.get("isReadOnly")}.property("isReadOnly")}),KG.CommentsController=Ember.ArrayController.extend({commentsPanelVisible:NO,showing:NO,isLoading:NO,comments:null,content:function(){return this.get("showing")&&!this.get("isLoading")?this.get("comments"):null}.property("showing","comments","isLoading"),contentSize:function(){return this.getPath("comments.length")}.property("comments","comments.length"),showButtonVisible:function(){return this.get("commentsPanelVisible")}.property("commentsPanelVisible"),commentsLabel:function(){var a=this.get("contentSize");return this.get("showing")?a===0||!a?"_0hideComment".loc():a===1?"_1hideComment".loc():"_hideComments".loc(a):a===0||!a?"_0comment".loc():a===1?"_1comment".loc():"_comments".loc(a)}.property("contentSize","showing")}),KG.featureCommentsController=KG.CommentsController.create({commentsBinding:Ember.Binding.oneWay("KG.inspectorController.feature.comments")}),KG.featureNewCommentController=SC.Object.create({content:null,showingDidChange:function(){KG.featureCommentsController.get("showing")||this.set("content",null)}.observes("KG.featureCommentsController.showing")}),KG.featureDeleteCommentController=SC.Object.create({content:null,showingDidChange:function(){KG.featureCommentsController.get("showing")||this.set("content",null)}.observes("KG.featureCommentsController.showing")}),KG.InspectorAttributeView=SC.View.extend({_renderer:null,destroy:function(){this._super(),SC.none(this._renderer)||(this._renderer.destroy(),this._renderer=null)},didInsertElement:function(){var a;SC.none(this._renderer)||this._renderer.destroy();var b=this.getPath("itemView.content.templateName");b&&SC.TEMPLATES[b]?a=SC.View.create({templateName:b,parentView:this}):a=SC.View.create({templateName:"label-renderer",parentView:this}),a.appendTo(this.get("element")),this._renderer=a}}),KG.DeleteFeatureCommentView=KG.Button.extend({isVisible:function(){var a=this.getPath("itemView.content");if(a===KG.featureDeleteCommentController.get("content")){var b=a.get("author");if(!b||b===KG.core_auth.get("activeUser").id||KG.core_sandbox.get("isSandboxOwner"))return YES}return NO}.property("itemView.content","KG.featureDeleteCommentController.content"),label:function(){return"_Delete".loc()}.property()}),Ember.TEMPLATES.inspector=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e={},f="inspector-title",e.id=f,f="header",e.tagName=f,f=d.view||a.view,i=j.program(2,q,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\t\n\t<div id="inspector-panel">\t\t\t\t\t\t\n\t\t'),e={},f="KG.inspectorController",e.contentBinding=f,f="inspector-attrs-list",e["class"]=f,f=d.collection||a.collection,i=j.program(7,t,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\t\n\t\t<div id="comment-super-panel">\n\t\t</div>\t\t\t\n\t\t'),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="delete-feature red-button",g["class"]=h,h="deleteFeatureInspectorAction",g.sc_action=h,h="KG.inspectorController.deleteTitle",g.titleBinding=h,h="KG.inspectorController.isWriteable",g.isVisibleBinding=h,h=d.view||a.view,i=j.program(9,u,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t</div>\t\t\t\t\n"),c}function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="ios-button ios-tb-left",g["class"]=h,h="KG.inspectorController.isDirty",g.isVisibleBinding=h,h="cancelInspectorAction",g.sc_action=h,h="KG.inspectorController.cancelTitle",g.titleBinding=h,h=d.view||a.view,i=j.program(3,r,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t<h1 class="label-ellipsis" '),e={},f="KG.inspectorController.title",e.title=f,f=d.bindAttr||a.bindAttr,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"bindAttr",i):e=f,b.buffer.push(n(e)+">"),e=a,f="KG.inspectorController.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</h1>\n\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="ios-button ios-tb-right",g["class"]=h,h="closeInspectorAction",g.sc_action=h,h="KG.inspectorController.saveTitle",g.titleBinding=h,h=d.view||a.view,i=j.program(5,s,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\n\t"),c}function r(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t"),e=a,f="_cancel",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t"),c}function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.inspectorController.saveLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.InspectorAttributeView",g={},h="inspector-list-item",g["class"]=h,h="itemView.content.css_class",g.classBinding=h,h=d.view||a.view,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"view",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}function u(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t"),e=a,f="_Delete",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="super-inspector",g.id=h,h="KG.inspectorController.active",g.classBinding=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["feature-comments"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t<a href="javascript:void(0)">\n\t\t'),e=a,f="KG.featureCommentsController.commentsLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t</a>\n"),c}function t(a,b){var c="",e,f;return b.buffer.push("\n\t"),e={},f="KG.featureCommentsController.content",e.contentBinding=f,f="comment-list",e["class"]=f,f=d.collection||a.collection,l=m.program(4,u,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\n"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="toggleDeleteFeatureCommentButtonAction",g.sc_action=h,h=d.view||a.view,l=m.program(5,v,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t<table style="width:100%">\n\t\t\t<tr>\n\t\t\t\t<td>\n\t\t\t\t\t'),e=a,f="KG.AuthorView",g={},h="comment-author",g["class"]=h,h=d.view||a.view,l=m.program(6,w,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t"),e={},f="comment-content",e["class"]=f,f=d.view||a.view,l=m.program(8,x,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t"),e={},f="comment-date",e["class"]=f,f=d.view||a.view,l=m.program(10,y,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t\t</td>\n\t\t\t\t<td style="text-align:right;vertical-align:middle">\n\t\t\t\t\t'),e=a,f="KG.DeleteFeatureCommentView",g={},h="comment-delete red-button",g["class"]=h,h="deleteFeatureCommentButtonAction",g.sc_action=h,h=d.view||a.view,l=m.program(12,z,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t"),c}function w(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="authorLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t"),c}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="itemView.content.comment",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function y(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="itemView.content.formattedDate",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function z(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="label",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function A(a,b){var c="",e,f;return b.buffer.push("\n\t<img "),e={},f="loadingImage",e.src=f,f=d.bindAttr||a.bindAttr,l={},l.hash=e,l.contexts=[],l.data=b,typeof f===n?e=f.call(a,l):f===p?e=o.call(a,"bindAttr",l):e=f,b.buffer.push(q(e)+' alt="Loading"/>\n'),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return h=c,i="KG.Button",j={},k="span",j.tagName=k,k="KG.featureCommentsController.showButtonVisible",j.isVisibleBinding=k,k="showFeatureCommentsAction",j.sc_action=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h={},i="feature-comments-container",h.id=i,i="KG.featureCommentsController.showing",h.classBinding=i,i=d.view||c.view,l=m.program(3,t,f),l.hash=h,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=f,typeof i===n?h=i.call(c,l):h=r.call(c,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h=c,i="KG.CommentAreaView",j={},k="feature-new-comment-area",j.id=k,k="new-comment-area",j["class"]=k,k="KG.featureCommentsController.showing",j.isVisibleBinding=k,k="addFeatureCommentAction",j.nl_sc_action=k,k="KG.featureNewCommentController.content",j.valueBinding=k,k="_commentPlaceholder",j.placeholder_not_loc=k,k=d.view||c.view,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"view",i,l):h=k,f.buffer.push(q(h)+"\n"),h=c,i="KG.LoadingImageView",j={},k="feature-comment-loading",j.id=k,k="comment-loading",j["class"]=k,k="KG.featureCommentsController.isLoading",j.isVisibleBinding=k,k=d.view||c.view,l=m.program(14,A,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),g}),Ember.TEMPLATES["bool-renderer"]=Handlebars.template(function(b,c,d,e,f){d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+"\n</span>\t\n"),h={},i="switch",h.templateName=i,i="inspector-attr-value",h["class"]=i,i="itemView.content.value",h.contentBinding=i,i="KG.inspectorController.isReadOnly",h.disabledBinding=i,i=d.view||c.view,l={},l.hash=h,l.contexts=[],l.data=f,typeof i===n?h=i.call(c,l):i===p?h=o.call(c,"view",l):h=i,f.buffer.push(q(h)),g}),Ember.TEMPLATES["catalog-renderer"]=Handlebars.template(function(b,c,d,e,f){d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n<div class="inspector-attr-value">\n\t'),h={},i="select",h.templateName=i,i="itemView.content.enumValues",h.contentBinding=i,i="itemView.content.value",h.valueBinding=i,i="KG.inspectorController.isReadOnly",h.disabledBinding=i,i=d.view||c.view,l={},l.hash=h,l.contexts=[],l.data=f,typeof i===n?h=i.call(c,l):i===p?h=o.call(c,"view",l):h=i,f.buffer.push(q(h)+"\n</div>"),g}),Ember.TEMPLATES["catalog-text-renderer"]=Handlebars.template(function(b,c,d,e,f){d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n<div class="inspector-attr-value">\n\t'),h={},i="select-input",h.templateName=i,i="itemView.content.enumValuesCustom",h.contentBinding=i,i="itemView.content.value",h.valueBinding=i,i="KG.inspectorController.isReadOnly",h.disabledBinding=i,i=d.view||c.view,l={},l.hash=h,l.contexts=[],l.data=f,typeof i===n?h=i.call(c,l):i===p?h=o.call(c,"view",l):h=i,f.buffer.push(q(h)+"\n</div>"),g}),Ember.TEMPLATES["img-renderer"]=Handlebars.template(function(b,c,d,e,f){d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n\n<div class="inspector-attr-value">\n\t<img '),h={},i="itemView.content.imgBase64Value",h.src=i,i=d.bindAttr||c.bindAttr,l={},l.hash=h,l.contexts=[],l.data=f,typeof i===n?h=i.call(c,l):i===p?h=o.call(c,"bindAttr",l):h=i,f.buffer.push(q(h)+"/>\n</div>"),g}),Ember.TEMPLATES["label-renderer"]=Handlebars.template(function(b,c,d,e,f){d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n\n<div class="inspector-attr-value">\n\t<span>\n\t\t'),h=c,i="itemView.content.value",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+"\n\t</span>\n</div>"),g}),Ember.TEMPLATES["num-range-renderer"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){b.buffer.push("\n\t")}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n<div class="inspector-attr-value">\n\t'),h=c,i="KG.NumericTextField",j={},k="itemView.content.value",j.valueBinding=k,k="range",j.type=k,k="itemView.content.min",j.minBinding=k,k="itemView.content.max",j.maxBinding=k,k="itemView.content.step",j.stepBinding=k,k="KG.inspectorController.isReadOnly",j.disabledBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n</div>"),g}),Ember.TEMPLATES["num-renderer"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){b.buffer.push("\n\t")}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n<div class="inspector-attr-value">\n\t'),h=c,i="KG.NumericTextField",j={},k="itemView.content.value",j.valueBinding=k,k="number",j.type=k,k="itemView.content.min",j.minBinding=k,k="itemView.content.max",j.maxBinding=k,k="itemView.content.step",j.stepBinding=k,k="KG.inspectorController.isReadOnly",j.disabledBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n</div>"),g}),Ember.TEMPLATES["text-renderer"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){b.buffer.push("\n\t")}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<span class="inspector-attr-name">\n\t'),h=c,i="itemView.content.label",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+'\n</span>\t\n<div class="inspector-attr-value">\n\t'),h=c,i="KG.TextField",j={},k="itemView.content.value",j.valueBinding=k,k="false",j.spellcheck=k,k="off",j.autocorrect=k,k="off",j.autocapitalize=k,k="KG.inspectorController.isReadOnly",j.disabledBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n</div>"),g}),KG.core_palette=Ember.Object.create({_view:null,_paletteMarker:null,createView:function(){if(!this._view){var a=this;setTimeout(function(){a._view=Ember.View.create({templateName:"palette"}),a._view.appendTo("#main-sandbox-view")},1e3)}},createFeature:function(a){this.clearCreateFeature();var b=KG.core_leaflet.getCenter(),c=Ember.Object.create({paletteItem:a});this._paletteMarker=c;var d={title:a.get("title"),animated:YES,iconPath:"css/images/palette_marker.png",draggable:YES,popupContent:"_moveFeature".loc(a.get("label")),openPopup:YES,dragendTarget:this,dragendCb:this.markerDragged,injectGetNativePositionFunction:YES};KG.core_leaflet.addMarker(c,b.get("lon"),b.get("lat"),d),KG.paletteController.set("isDirty",YES)},clearCreateFeature:function(){Ember.none(this._paletteMarker)||(KG.core_leaflet.removeMarker(this._paletteMarker),this._paletteMarker=null),KG.paletteController.set("isDirty",NO)},markerDragged:function(a,b,c){KG.statechart.sendAction("paletteMarkerDragEnded",{paletteItem:a.paletteItem,lon:b,lat:c})}}),KG.paletteController=Ember.ArrayController.create({content:null,active:NO,isDirty:NO,createLabel:"_showPalette".loc(),isAvailable:function(){return KG.core_sandbox.get("hasWriteAccess")}.property("KG.core_sandbox.hasWriteAccess")}),Ember.TEMPLATES.palette=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f;return b.buffer.push("\t\n\t"),e={},f="palette-title",e.id=f,f="header",e.tagName=f,f=d.view||a.view,i=j.program(2,q,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\t\n\t<div id="palette-panel">\n\t\t\t'),e={},f="KG.paletteController.content",e.contentBinding=f,f="palette-list",e["class"]=f,f=d.collection||a.collection,i=j.program(7,t,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t</div>\n"),c}function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="ios-button ios-tb-left",g["class"]=h,h="KG.paletteController.isDirty",g.isVisibleBinding=h,h="cancelPaletteAction",g.sc_action=h,h="KG.paletteController.cancelTitle",g.titleBinding=h,h=d.view||a.view,i=j.program(3,r,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t<h1 class="label-ellipsis" '),e={},f="KG.paletteController.title",e.title=f,f=d.bindAttr||a.bindAttr,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"bindAttr",i):e=f,b.buffer.push(n(e)+">"),e=a,f="_paletteTitle",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"</h1>\n\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="ios-button ios-tb-right",g["class"]=h,h="closePaletteAction",g.sc_action=h,h="KG.paletteController.closeTitle",g.titleBinding=h,h=d.view||a.view,i=j.program(5,s,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),c}function r(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t"),e=a,f="_cancel",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t"),c}function s(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t"),e=a,f="_close",g=d.loc||a.loc,i={},i.hash={},i.contexts=[],i.contexts.push(e),i.data=b,typeof g===k?e=g.call(a,f,i):g===m?e=l.call(a,"loc",f,i):e=g,b.buffer.push(n(e)+"\n\t\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t"),e=a,f="KG.Button",g={},h="div",g.tagName=h,h="white-button",g["class"]=h,h="selectPaletteItemAction",g.sc_action=h,h=d.view||a.view,i=j.program(8,u,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t"),e=a,f="itemView.content.label",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="super-palette",g.id=h,h="KG.paletteController.active",g.classBinding=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),KG.infoController=Ember.ArrayController.create({content:[],listVisible:NO,featureCount:function(){return this.getPath("content.length")}.property("content.length"),multipleFeatures:function(){return this.get("featureCount")>1}.property("featureCount"),firstFeature:function(){return this.getPath("content.firstObject")}.property("content","content.length"),allButFirst:function(){var a=this.get("content");if(a&&a.get("length")>0){var b=a.toArray();return b.splice(0,1),b}return[]}.property("content","content.length").cacheable()}),KG.core_info=SC.Object.create({limit_query:10,highlight:null,_finding:NO,_timeout:null,findFeaturesAt:function(a){if(this._finding){this._timeout&&clearTimeout(this._timeout);var b=this;return this._timeout=setTimeout(function(){var c=KG.infoController.getPath("content.status");if(!c||SC.Record.ERROR)b._finding=NO;b.findFeaturesAt(a)},1e3),NO}this._finding=YES;var c=KG.core_leaflet.pixelsToWorld(1),d=KG.core_layer.getLayersSelection(),e=d.map(function(a,b,c){return a.get("id")}).join(",");if(KG.infoController.get("content")&&KG.infoController.get("content").destroy){var f=KG.infoController.get("content");f.destroy(),console.log("info controller did destroy content")}if(e.length>0){KG.INFO_QUERY.lat=a.get("lat"),KG.INFO_QUERY.lon=a.get("lon"),KG.INFO_QUERY.one_pixel=c,KG.INFO_QUERY.limit_query=this.get("limit_query"),KG.INFO_QUERY.layers=e;var g=KG.store.find(KG.INFO_QUERY);KG.infoController.set("content",g),g.onReady(this,this.infoReady)}else console.log("No valid layer to do a F_INFO"),KG.infoController.set("content",[]);this.clearViewInfo()},infoReady:function(a){a.offReady(),a.get("length")>0&&KG.statechart.sendAction("featureInfoReady"),this._timeout&&(clearTimeout(this._timeout),this._timeout=null),this._finding=NO},showInfoPopup:function(){var a=KG.infoController.get("content");if(a.get("length")>0){var b=a.getPath("firstObject.center");if(b){this.clearViewInfo(),SC.none(this._div_info)&&(this._div_info=document.createElement("div"));var c=this._div_info;this._view_info=SC.View.create({templateName:"info-popup",classNames:["super-info-popup"]}),this._view_info.appendTo(c),setTimeout(function(){KG.core_leaflet.showPopupInfo(b,c)},1)}}},hideInfoPopup:function(){KG.core_leaflet.closePopup(),this.clearViewInfo()},expandPopupDidChange:function(){setTimeout(function(){KG.core_leaflet.updatePopupInfo()},1)}.observes("KG.infoController.listVisible"),clearViewInfo:function(){SC.none(this._view_info)||this._view_info.destroy()}}),KG.FeatureInfoPopupItemView=KG.Button.extend({classNames:"info-popup-item".w(),templateName:"info-item",content:null,tagName:"div",sc_action:"featureInfoMouseUpAction",manualMouseDown:YES,mouseEnter:function(a){var b=this.get("content");return KG.statechart.sendAction("featureInfoMouseEnterAction",b),NO},mouseLeave:function(a){var b=this.get("content");return KG.statechart.sendAction("featureInfoMouseLeaveAction",b),NO}}),KG.ExpandButtonView=SC.Button.extend({tagName:"div",expanded:NO,logo:function(){return this.get("expanded")?"css/images/down_arrow_32.png":"css/images/up_arrow_32.png"}.property("expanded"),mouseUp:function(a){return this.set("expanded",!this.get("expanded")),NO}}),Ember.TEMPLATES["info-item"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="parentView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t"),c}function t(a,b){b.buffer.push('\t\n\t\t<img src="css/images/right_arrow_32.png"/>\t\t\n\t')}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<div class="info-item-row">\n\t'),h={},i="label-ellipsis",h["class"]=i,i=d.view||c.view,l=m.program(1,s,f),l.hash=h,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=f,typeof i===n?h=i.call(c,l):h=r.call(c,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\t\t\t\n\t"),h=c,i="KG.Button",j={},k="yes",j.manualMouseDown=k,k="selectFeatureInspectorAction",j.sc_action=k,k="content",j.contentBinding=k,k="div",j.tagName=k,k=d.view||c.view,l=m.program(3,t,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n</div>"),g}),Ember.TEMPLATES["info-popup"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f;return b.buffer.push("\t\n\t<img "),e={},f="logo",e.src=f,f=d.bindAttr||a.bindAttr,l={},l.hash=e,l.contexts=[],l.data=b,typeof f===n?e=f.call(a,l):f===p?e=o.call(a,"bindAttr",l):e=f,b.buffer.push(q(e)+"/>\t\t\n"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return h={},i="KG.infoController.allButFirst",h.contentBinding=i,i="KG.infoController.listVisible",h.isVisibleBinding=i,i="popup-info-list",h["class"]=i,i="KG.FeatureInfoPopupItemView",h.itemViewClass=i,i=d.collection||c.collection,l={},l.hash=h,l.contexts=[],l.data=f,typeof i===n?h=i.call(c,l):i===p?h=o.call(c,"collection",l):h=i,f.buffer.push(q(h)+"\t\n"),h=c,i="KG.FeatureInfoPopupItemView",j={},k="KG.infoController.firstFeature",j.contentBinding=k,k="master-row",j["class"]=k,k=d.view||c.view,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"view",i,l):h=k,f.buffer.push(q(h)+"\n"),h=c,i="KG.ExpandButtonView",j={},k="div",j.tagName=k,k="popup-info-expand-button",j["class"]=k,k="KG.infoController.multipleFeatures",j.isVisibleBinding=k,k="KG.infoController.listVisible",j.expandedBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),g}),KG.core_note=SC.Object.create({_bounds:null,_zoom:null,_view_active_note:null,_new_note_marker:null,_view_multiple_notes:null,_store:null,featureTemplate:null,_removeOnCloseMarker:null,beginModifications:function(){this.rollbackModifications(),this._store=KG.store.chain();var a=KG.activeNoteController.get("content");!SC.none(a)&&a.get("status")!==SC.Record.READY_NEW&&KG.activeNoteController.set("content",this._store.find(a))},commitModifications:function(a){var b=KG.activeNoteController.get("content");b&&(b.get("status")!==SC.Record.READY_NEW&&(b=KG.store.find(b)),this._store.commitChanges().destroy(),this._store=null,KG.store.commitRecords(),a&&setTimeout(function(){b.onReady(null,a)},1))},rollbackModifications:function(){this._store&&(this._store.discardChanges(),this._store.destroy(),this._store=null)},postEdition:function(){this.rollbackModifications(),this._highlightMarker&&KG.core_leaflet.removeMarker(this._highlightMarker),this.cleanUpActiveNoteElements()},zoomActiveNote:function(){var a=KG.activeNoteController.get("content");if(a){var b=a.get("coordinate");b&&(KG.core_leaflet.closePopup(),KG.core_leaflet.setCenter(KG.LonLat.create({lon:b.x,lat:b.y}),14))}},locateNote:function(){this.cancelLocateNote();var a=KG.core_leaflet.getCenter(),b={title:"_newNote".loc(),animated:YES,iconPath:"css/images/new_marker.png",draggable:YES,popupContent:"_moveNote".loc(),openPopup:YES,dragendTarget:this,dragendCb:this.markerDragged,injectGetNativePositionFunction:YES},c=this.createTempMarker();return this._new_note_marker=KG.core_leaflet.addMarker(c,a.get("lon"),a.get("lat"),b),YES},createTempMarker:function(){var a=Ember.Object.create({lon:function(){return this.getNativePosition().get("lon")}.property(),lat:function(){return this.getNativePosition().get("lat")}.property()});return a},cancelLocateNote:function(){SC.none(this._new_note_marker)||(KG.core_leaflet.removeMarker(this._new_note_marker),this._new_note_marker=null)},createNote:function(){this.beginModifications();var a;if(!SC.none(this.get("featureTemplate"))){var b=this.get("featureTemplate"),c=b.get("center");if(!SC.none(c)&&c.get("lon")&&c.get("lat")){a=this._store.createRecord(KG.Note,{coordinate:{x:b.get("center").get("lon"),y:b.get("center").get("lat")},description:b.get("title")});var d=b.get("center").get("lon"),e=b.get("center").get("lat"),f={title:"_newNote".loc(),animated:YES,iconPath:"css/images/new_marker.png",draggable:YES,dragendTarget:this,dragendCb:this.markerDragged,injectGetNativePositionFunction:YES},g=this.createTempMarker();this._new_note_marker=KG.core_leaflet.addMarker(g,d,e,f)}}else this._new_note_marker&&(a=this._store.createRecord(KG.Note,{coordinate:{x:this._new_note_marker.get("lon"),y:this._new_note_marker.get("lat")}}));if(a){var g=this._new_note_marker;this.activateNote(a,{marker:g})}else KG.statechart.sendAction("cancelCreateNoteAction")},clearCreateNote:function(){SC.none(this._new_note_marker)||(KG.core_leaflet.removeMarker(this._new_note_marker),this._new_note_marker=null,this.set("featureTemplate",null)),this.cleanUpActiveNoteElements()},activateNote:function(a,b){return a?(a.get("status")===SC.Record.READY_NEW||b.isFresh?this.continueActivateNote(a,b.marker):a.refresh(YES,function(){KG.core_note.continueActivateNote(a,b.marker)}),YES):NO},continueActivateNote:function(a,b){this.cleanUpActiveNoteElements();var c=document.createElement("div");this._view_active_note=SC.View.create({templateName:"active-note-popup"}),this._view_active_note.appendTo(c),KG.activeNoteController.set("marker",b),KG.activeNoteController.set("content",a),KG.activeNoteController.canEdit()&&(console.log("note is draggable"),KG.core_leaflet.enableDraggableMarker(b)),setTimeout(function(){SC.none(b)||KG.core_leaflet.showPopupMarker(b,c)},1)},cleanUpActiveNoteElements:function(){SC.none(this._view_active_note)||(this._view_active_note.destroy(),this._view_active_note=null)},cleanUpMultipleNotesElements:function(){SC.none(this._view_multiple_notes)||(this._view_multiple_notes.destroy(),this._view_multiple_notes=null)},setHighlightMarker:function(a){this._highlightMarker=a},activateMultipleNotes:function(a,b){this.cleanUpMultipleNotesElements(),KG.notesPopupController.set("marker",b),KG.notesPopupController.set("content",a);var c=document.createElement("div");this._view_multiple_notes=SC.View.create({templateName:"multiple-notes-popup"}),this._view_multiple_notes.appendTo(c),setTimeout(function(){KG.core_leaflet.showPopupMarker(b,c)},1)},confirmCreateNote:function(){var a=KG.activeNoteController.get("content");a=KG.store.find(a),a.onReady(null,function(){KG.core_note.refreshMarkers(YES)})},deleteActiveNote:function(){var a=KG.activeNoteController.get("content");if(a){var b=KG.store.find(a);b.onDestroyedClean(null,function(){console.log("destroyed completed"),KG.core_note.refreshMarkers(YES)}),a.destroy()}},removeAllMarkers:function(){var a=KG.noteMarkersController.get("content");a&&(a.forEach(function(a){KG.core_leaflet.removeMarker(a);var b=a.get("store").recordTypeFor(a.get("storeKey"));KG.store.unloadRecord(b,a.get("id"))}),a.destroy())},refreshMarkers:function(a){var b=KG.core_leaflet.getBounds(),c=KG.core_leaflet.getZoom();if(a||SC.none(this._zoom)||this._zoom!=c||SC.none(this._bounds)||!this._bounds.contains(b)){console.log("Refresh markers, Force:"+a);var d=KG.core_leaflet.getFatBounds(),e=KG.core_leaflet.pixelsToWorld(20),f=[];if(KG.noteMarkersController.get("content")){var g=KG.noteMarkersController.get("content");f=g.toArray(),g.destroy()}KG.NOTE_MARKER_QUERY.fat_bounds=d,KG.NOTE_MARKER_QUERY.distance=e;var h=KG.store.find(KG.NOTE_MARKER_QUERY);return h.onReady(this,this.markersReady,{olds:f}),KG.noteMarkersController.set("content",h),this._bounds=d,this._zoom=c,YES}return NO},markersReady:function(a,b){a.offReady(),KG.notesPopupController.set("marker",null),b.olds.forEach(function(b){if(a.indexOf(b)!==-1)KG.core_leaflet.removeShadow(b);else{KG.core_leaflet.removeMarker(b);var c=b.get("store").recordTypeFor(b.get("storeKey"));KG.store.unloadRecord(c,b.get("id"))}});var c,d=a.get("length");for(c=0;c<d;c++){var e=KG.noteMarkersController.objectAt(c);if(e){var f=undefined;e.get("featureCount")>1&&(f="css/images/group_marker.png");var g={title:e.get("tooltip"),animated:NO,iconPath:f,draggable:NO,clickTarget:this,clickCb:this.markerClicked,dragendTarget:this,dragendCb:this.markerDragged};KG.core_leaflet.addMarker(e,e.get("lon"),e.get("lat"),g)}}this._highlightMarker&&KG.core_leaflet.reAddMarker(this._highlightMarker)},markerClicked:function(a){KG.statechart.sendAction("clickMarkerAction",a)},markerDragged:function(a,b,c){KG.statechart.sendAction("markerDragEnded",b,c)},continueMarkerClicked:function(a){if(SC.none(a))return NO;var b=a.get("features"),c=b.get("length"),d={count:0,length:c,marker:a};for(i=0;i<c;i++){var e=b.objectAt(i);d.isFresh=e.get("status")&SC.Record.BUSY,e.get("status")===SC.Record.ERROR?e.refresh(YES,function(){KG.core_note.noteReady(e,d)}):e.onReady(this,this.noteReady,d)}},noteReady:function(a,b){b.count++,b.count===b.length&&(b.count===1?KG.statechart.sendAction("noteSelectedAction",a,b):KG.statechart.sendAction("multipleNotesSelectedAction",b.marker.get("features"),b.marker))},fetchComments:function(a){var b=KG.activeNoteController.get("content");if(!SC.none(b)){var c=KG.store.find(b),d=function(){a||KG.noteCommentsController.set("isLoading",YES);var b=c.get("comments"),d={count:0,length:b.get("length"),records:[]};d.length>0?(console.log("comments count:"+d.length),b.forEach(function(a){a.onReady(KG.core_note,KG.core_note.commentReady,d)})):(console.log("NO comments"),KG.noteCommentsController.set("isLoading",NO),KG.statechart.sendAction("noteCommentsReadyEvent"))};a?c.refresh(YES,d):c.onReady(null,d)}},commentReady:function(a,b){b.count++,b.records.pushObject(a),b.count===b.length&&(KG.statechart.sendAction("noteCommentsReadyEvent"),KG.noteCommentsController.set("isLoading",NO))},addCommentToActiveNote:function(a){var b=KG.activeNoteController.get("content");if(b){var c=KG.store.createRecord(KG.NoteComment,{comment:a,note:b.get("id")});KG.store.commitRecords(null,null,[c.get("storeKey")]),c.onReady(null,function(){b.get("comments").get("editableStoreIds").pushObject(c.get("id")),KG.statechart.sendAction("noteCommentsReadyEvent")})}},deleteComment:function(a){var b=KG.activeNoteController.get("content");b.get("comments").get("editableStoreIds").removeObject(a.get("id")),a.destroy(),KG.store.commitRecords(null,null,[a.get("storeKey")])},updatePosition:function(a,b){KG.activeNoteController.get("content").set("coordinate",{x:a,y:b}),KG.core_leaflet.updatePopupMarkerPosition(a,b)}}),KG.noteMarkersController=Ember.ArrayController.create({content:null}),KG.notesPopupController=Ember.ArrayController.create({content:[],marker:null,popupTitle:function(){var a=this.get("marker");return a?a.get("title"):""}.property("marker")}),KG.activeNoteController=SC.Object.create({content:null,marker:null,comments:function(){return this.getPath("content.comments")}.property("content.comments"),createLabel:"_createNote".loc(),titleLabel:function(){return"_noteTitle".loc()}.property(),descriptionLabel:function(){return"_noteDescription".loc()}.property(),isOldRecord:function(){return this.getPath("content.status")===SC.Record.READY_NEW?NO:YES}.property("content.status"),confirmLabel:function(){return this.get("isOldRecord")?"_noteUpdate".loc():"_noteConfirm".loc()}.property("isOldRecord"),deleteLabel:function(){return"_Delete".loc()}.property("content.status"),titleValue:function(a,b){b!=undefined&&this.get("content").set("title",b);var c=this.getPath("content.title");return c||(c=""),c}.property("content.title"),isDisabled:function(){return this.getPath("content.status")&SC.Record.BUSY?YES:!this.canEdit()}.property("content.status","content.author"),canEdit:function(){var a=this.getPath("content.author");return!a||a===KG.core_auth.get("activeUser").id?YES:NO},isUpdateVisible:function(){return!this.get("isDisabled")}.property("isDisabled"),isDeleteVisible:function(){var a=this.getPath("content.author");return this.getPath("content.status")!==SC.Record.READY_NEW&&(!a||a===KG.core_auth.get("activeUser").id||KG.core_sandbox.get("isSandboxOwner"))?YES:NO}.property("content.status","content.author","KG.core_sandbox.isSandboxOwner")}),KG.noteCommentsController=KG.CommentsController.create({commentsBinding:"KG.activeNoteController.comments"}),KG.noteNewCommentController=SC.Object.create({content:null,showingDidChange:function(){KG.noteCommentsController.get("showing")||this.set("content",null)}.observes("KG.noteCommentsController.showing")}),KG.noteDeleteCommentController=SC.Object.create({content:null,showingDidChange:function(){KG.noteCommentsController.get("showing")||this.set("content",null)}.observes("KG.noteCommentsController.showing")}),KG.NotePopupItemView=SC.Button.extend({classNames:"popup-note-item".w(),tagName:"div",mouseUp:function(a){return this._super(a),KG.statechart.sendAction("noteSelectedAction",this.getPath("itemView.content"),{marker:KG.notesPopupController.get("marker")}),NO}}),KG.CommentAreaView=KG.TextArea.extend({insertNewline:function(a){KG.statechart.sendAction(this.get("nl_sc_action"));var b=this;setTimeout(function(){var a=b.$().data("AutoResizer");a&&a.check()},205)},cancel:function(){this.set("value",""),this.$().blur()}}),KG.AuthorView=SC.View.extend({authorLabel:function(){var a=this.getPath("itemView.content");if(SC.none(a))return"";if(a.get("author")===KG.core_auth.activeUser.id)return"_me".loc();var b=a.get("author_descriptor");return b?b:"?"}.property("itemView.content")}),KG.DeleteNoteCommentView=KG.Button.extend({isVisible:function(){var a=this.getPath("itemView.content");if(a===KG.noteDeleteCommentController.get("content")){var b=a.get("author");if(!b||b===KG.core_auth.get("activeUser").id||KG.core_sandbox.get("isSandboxOwner"))return YES}return NO}.property("itemView.content","KG.noteDeleteCommentController.content"),label:function(){return"_Delete".loc()}.property()}),Ember.TEMPLATES["active-note-popup"]=Handlebars.template(function(b,c,d,e,f){function p(a,b){var c="",e,f,g,h;return b.buffer.push("\t\n\t"),e=a,f="KG.Button",g={},h="yes",g.manualMouseDown=h,h="note-zoom-button",g["class"]=h,h="KG.activeNoteController.isOldRecord",g.isVisibleBinding=h,h="div",g.tagName=h,h="zoomNoteAction",g.sc_action=h,h=d.view||a.view,i=j.program(2,q,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\n\t"),e={},f="note-date-label",e["class"]=f,f=d.view||a.view,i=j.program(4,r,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\n\t<span>"),e=a,f="KG.activeNoteController.titleLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</span>\n\t"),e=a,f="KG.TextField",g={},h="KG.activeNoteController.titleValue",g.valueBinding=h,h="KG.activeNoteController.isDisabled",g.disabledBinding=h,h="text",g.type=h,h="_noteTitlePlaceholder",g.placeholder_not_loc=h,h=d.view||a.view,i=j.program(6,s,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t<span>"),e=a,f="KG.activeNoteController.descriptionLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"</span>\n\t"),e=a,f="KG.TextArea",g={},h="note-description-area",g.id=h,h="KG.activeNoteController.isDisabled",g.disabledBinding=h,h="KG.activeNoteController*content.description",g.valueBinding=h,h=d.view||a.view,i=j.program(8,t,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e={},f="active-note-popup-bottom",e["class"]=f,f=d.view||a.view,i=j.program(10,u,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),e={},f="note-comments",e.templateName=f,f=d.view||a.view,i={},i.hash=e,i.contexts=[],i.data=b,typeof f===k?e=f.call(a,i):f===m?e=l.call(a,"view",i):e=f,b.buffer.push(n(e)+"\n"),c}function q(a,b){b.buffer.push('\n\t\t<a href="javascript:void(0)">zoom</a>\n\t')}function r(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.activeNoteController.content.formattedDate",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t"),c}function s(a,b){b.buffer.push("\n\t")}function t(a,b){b.buffer.push("\n\t")}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.Button",g={},h="yes",g.manualMouseDown=h,h="KG.activeNoteController.isUpdateVisible",g.isVisibleBinding=h,h="white-button",g["class"]=h,h="confirmNoteAction",g.sc_action=h,h=d.view||a.view,i=j.program(11,v,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\n\t\t"),e=a,f="KG.Button",g={},h="yes",g.manualMouseDown=h,h="KG.activeNoteController.isDeleteVisible",g.isVisibleBinding=h,h="red-button",g["class"]=h,h="deleteNoteAction",g.sc_action=h,h=d.view||a.view,i=j.program(13,w,b),i.hash=g,i.contexts=[],i.contexts.push(e),i.fn=i,i.inverse=j.noop,i.data=b,typeof h===k?e=h.call(a,f,i):e=o.call(a,h,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t"),e={},f="note-author-label",e["class"]=f,f=d.view||a.view,i=j.program(15,x,b),i.hash=e,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=b,typeof f===k?e=f.call(a,i):e=o.call(a,f,i),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.activeNoteController.confirmLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}function w(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.activeNoteController.deleteLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="KG.activeNoteController.content.authorFormatted",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,i={},i.hash=g,i.contexts=[],i.contexts.push(e),i.data=b,typeof h===k?e=h.call(a,f,i):h===m?e=l.call(a,"_triageMustache",f,i):e=h,b.buffer.push(n(e)+"\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g,h,i,j=this,k="function",l=d.helperMissing,m=void 0,n=this.escapeExpression,o=d.blockHelperMissing;g={},h="active-note-popup",g["class"]=h,h=d.view||c.view,i=j.program(1,p,f),i.hash=g,i.contexts=[],i.fn=i,i.inverse=j.noop,i.data=f,typeof h===k?g=h.call(c,i):g=o.call(c,h,i),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["note-comments"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t<a href="javascript:void(0)">\n\t\t'),e=a,f="KG.noteCommentsController.commentsLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t</a>\n"),c}function t(a,b){var c="",e,f;return b.buffer.push("\n\t"),e={},f="KG.noteCommentsController.content",e.contentBinding=f,f="comment-list",e["class"]=f,f=d.collection||a.collection,l=m.program(4,u,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\n"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.Button",g={},h="yes",g.manualMouseDown=h,h="div",g.tagName=h,h="toggleDeleteNoteCommentButtonAction",g.sc_action=h,h=d.view||a.view,l=m.program(5,v,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t<table style="width:100%">\n\t\t\t<tr>\n\t\t\t\t<td>\n\t\t\t\t\t'),e=a,f="KG.AuthorView",g={},h="comment-author",g["class"]=h,h=d.view||a.view,l=m.program(6,w,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t"),e={},f="comment-content",e["class"]=f,f=d.view||a.view,l=m.program(8,x,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t"),e={},f="comment-date",e["class"]=f,f=d.view||a.view,l=m.program(10,y,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t\t\t</td>\n\t\t\t\t<td style="text-align:right;vertical-align:middle">\n\t\t\t\t\t'),e=a,f="KG.DeleteNoteCommentView",g={},h="yes",g.manualMouseDown=h,h="comment-delete red-button",g["class"]=h,h="deleteNoteCommentButtonAction",g.sc_action=h,h=d.view||a.view,l=m.program(12,z,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t"),c}function w(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="authorLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t"),c}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="itemView.content.comment",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function y(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="itemView.content.formattedDate",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function z(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t"),e=a,f="label",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t"),c}function A(a,b){var c="",e,f;return b.buffer.push("\n\t<img "),e={},f="loadingImage",e.src=f,f=d.bindAttr||a.bindAttr,l={},l.hash=e,l.contexts=[],l.data=b,typeof f===n?e=f.call(a,l):f===p?e=o.call(a,"bindAttr",l):e=f,b.buffer.push(q(e)+' alt="Loading"/>\n'),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return h=c,i="KG.Button",j={},k="yes",j.manualMouseDown=k,k="span",j.tagName=k,k="KG.noteCommentsController.showButtonVisible",j.isVisibleBinding=k,k="showNoteCommentsAction",j.sc_action=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h={},i="note-comments-container",h.id=i,i="KG.noteCommentsController.showing",h.classBinding=i,i=d.view||c.view,l=m.program(3,t,f),l.hash=h,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=f,typeof i===n?h=i.call(c,l):h=r.call(c,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h=c,i="KG.CommentAreaView",j={},k="note-new-comment-area",j.id=k,k="new-comment-area",j["class"]=k,k="KG.noteCommentsController.showing",j.isVisibleBinding=k,k="KG.noteNewCommentController.content",j.valueBinding=k,k="_commentPlaceholder",j.placeholder_not_loc=k,k="addNoteCommentAction",j.nl_sc_action=k,k=d.view||c.view,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"view",i,l):h=k,f.buffer.push(q(h)+"\n"),h=c,i="KG.LoadingImageView",j={},k="note-comment-loading",j.id=k,k="comment-loading",j["class"]=k,k="KG.noteCommentsController.isLoading",j.isVisibleBinding=k,k=d.view||c.view,l=m.program(14,A,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),g}),Ember.TEMPLATES["multiple-notes-popup"]=Handlebars.template(function(b,c,d,e,f){function q(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t"),e=a,f="KG.notesPopupController.popupTitle",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"_triageMustache",f,j):e=h,b.buffer.push(o(e)+"\n"),c}function r(a,b){var c="",e,f,g,h;return b.buffer.push("\t\t\t\n\t"),e=a,f="KG.NotePopupItemView",g={},h="multiple-notes-item common-list-button",g["class"]=h,h=d.view||a.view,j=k.program(4,s,b),j.hash=g,j.contexts=[],j.contexts.push(e),j.fn=j,j.inverse=k.noop,j.data=b,typeof h===l?e=h.call(a,f,j):e=p.call(a,h,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function s(a,b){var c="",e,f;return b.buffer.push('\n\t\t<table class="multiple-notes-table">\n\t\t<td>\n\t\t'),e={},f="multiple-notes-item-title",e["class"]=f,f=d.view||a.view,j=k.program(5,t,b),j.hash=e,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=b,typeof f===l?e=f.call(a,j):e=p.call(a,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t</td>\n\t\t<td>\n\t\t"),e={},f="note-author-label",e["class"]=f,f=d.view||a.view,j=k.program(7,u,b),j.hash=e,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=b,typeof f===l?e=f.call(a,j):e=p.call(a,f,j),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t</td>\n\t\t</table>\n\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="itemView.content.title",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"_triageMustache",f,j):e=h,b.buffer.push(o(e)+"\n\t\t"),c}function u(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="itemView.content.authorFormatted",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,j={},j.hash=g,j.contexts=[],j.contexts.push(e),j.data=b,typeof h===l?e=h.call(a,f,j):h===n?e=m.call(a,"_triageMustache",f,j):e=h,b.buffer.push(o(e)+"\n\t\t"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k=this,l="function",m=d.helperMissing,n=void 0,o=this.escapeExpression,p=d.blockHelperMissing;return h={},i="multiple-notes-title",h["class"]=i,i=d.view||c.view,j=k.program(1,q,f),j.hash=h,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=f,typeof i===l?h=i.call(c,j):h=p.call(c,i,j),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n"),h={},i="KG.notesPopupController",h.contentBinding=i,i="ul",h.tagName=i,i="multiple-notes-list no-style-list",h["class"]=i,i=d.collection||c.collection,j=k.program(3,r,f),j.hash=h,j.contexts=[],j.fn=j,j.inverse=k.noop,j.data=f,typeof i===l?h=i.call(c,j):h=p.call(c,i,j),(h||h===0)&&f.buffer.push(h),g}),KG.core_layer=SC.Object.create({loadLayers:function(){var a=KG.store.find(KG.LAYER_QUERY);KG.layersController.set("content",a),a.onReady(this,this._layersReady)},_layersReady:function(a){var b=a;b.filterProperty("visibility",YES).filterProperty("canRender",YES).forEach(function(a){KG.core_leaflet.addWMSLayer(a)})},cleanUp:function(){var a=KG.layersController.get("content");a&&a.forEach(function(a){KG.core_leaflet.removeLayer(a)})},getLayersSelection:function(){var a=KG.layersController.get("content");if(!SC.none(a)&&a.get("length")>0){var b=a.filterProperty("visibility",YES).filterProperty("isSelectable",YES);return b}return[]},getMainWMSFor:function(a){var b=KG.layersController.get("content");return!SC.none(b)&&b.get("length")>0&&b.filterProperty("visibility",YES).filterProperty("ft_id",a.get("id")).get("length")>0?b.filterProperty("name",KG.get("activeSandboxKey")):[]}}),KG.layersController=Ember.ArrayController.create({content:null}),KG.core_notification=SC.Object.create({connectedEndpoint:null,callbackAdded:NO,postCallbackAdded:NO,listen:function(){var a=KG.get("activeSandboxKey"),b=KG.get("serverHost")+"api_notification/general?sandbox=%@".fmt(a);this.stopListen(),$.atmosphere.subscribe(b,this.callbackAdded?null:this.atmosphereCallback,$.atmosphere.request={transport:"streaming",headers:KG.core_auth.createAjaxRequestHeaders()}),this.callbackAdded=YES,this.connectedEndpoint=$.atmosphere.response,this.timerId=setTimeout(function(){KG.core_notification.listen()},288e5)},stopListen:function(){$.atmosphere.close(),this.timerId&&(clearTimeout(this.timerId),this.timerId=null)},atmosphereCallback:function(a){$.atmosphere.log("info",["response.state: "+a.state]),$.atmosphere.log("info",["response.transport: "+a.transport]),$.atmosphere.log("info",["response.status: "+a.status]),detectedTransport=a.transport;if(a.transport!="polling"&&a.state!="connected"&&a.state!="closed"&&a.state!="messagePublished"){$.atmosphere.log("info",["response.responseBody: "+a.responseBody]);if(a.status==200){var b=a.responseBody;if(!b||b.charAt(0)!=="{")console.log("Message ignored - Must be JSON format");else try{var c=JSON.parse(b),d=KG.Message.create(c);if(d.get("author")!==KG.core_auth.get("activeUser").user)if(d.get("type")==="text")KG.notificationsController.insertAt(0,d);else if(d.get("type")==="note")KG.core_note.refreshMarkers(YES);else if(d.get("type")==="note_comment"){var e=KG.activeNoteController.get("content");!SC.none(e)&&e.get("id")===d.getPath("content.note_id")&&KG.core_note.fetchComments(YES)}else d.get("type")==="bookmark"&&(d.getPath("content.modif_type")==="delete"&&KG.store.unloadRecord(KG.Bookmark,d.getPath("content.id")),KG.statechart.sendAction("refreshBookmarkAction"));else KG.statechart.sendAction("notificationSent",d)}catch(f){console.log("NOTIFICATION: "+f)}}}},postMessage:function(a){if(!this.connectedEndpoint)return NO;var b=KG.get("activeSandboxKey"),c=KG.get("serverHost")+"api_notification/general?sandbox=%@".fmt(b);return this.connectedEndpoint.push(c,null,$.atmosphere.request={data:JSON.stringify(a.toDataHash()),headers:KG.core_auth.createAjaxRequestHeaders()}),YES}}),KG.Message=SC.Object.extend({author:null,user_descriptor:null,type:null,content:null,dateMillis:null,formattedContent:function(){var a=this.getPath("content.text");return a?a.replace(/\n/g,"<br>"):a}.property("content"),toDataHash:function(){return{author:this.author,user_descriptor:this.user_descriptor,type:this.type,content:this.content,dateMillis:this.dateMillis}},formattedDate:function(){var a=this.get("dateMillis");return a?KG.core_date.formatDate(a):""}.property("dateMillis"),isEqual:function(a){if(a.toDataHash){var b=this.toDataHash(),c=a.toDataHash();return JSON.stringify(b)===JSON.stringify(c)}return NO}}),KG.notificationsController=Ember.ArrayController.create({content:[],activePopup:NO,hasNotification:function(){return this.get("length")>0}.property("length")}),KG.sendNotificationController=SC.Object.create({showing:NO,content:"",sendOnEnterValue:YES,feedbackMessage:"",pendingNotification:null,notificationLabel:function(){return"_notificationSendText".loc()}.property(),sendLabel:function(){return"_notificationSendButton".loc()}.property(),sendOnEnterTooltip:function(){return"_sendOnEnterTooltip".loc()}.property(),hasNotificationPending:function(){return!SC.none(this.get("pendingNotification"))}.property("pendingNotification")}),KG.NotificationView=SC.View.extend({authorValue:function(){return this.getPath("contentView.content.user_descriptor")}.property("content"),authorMailTo:function(){return"mailto:%@".fmt(this.getPath("contentView.content.author"))}.property("content"),titleValue:function(){return"_textMessageTitle".loc()}.property("content"),dateValue:function(){return this.getPath("contentView.content.formattedDate")}.property("content"),messageValue:function(){return this.getPath("contentView.content.formattedContent")}.property("content")}),KG.TextNotificationAreaView=KG.TextArea.extend({insertNewline:function(a){KG.sendNotificationController.get("sendOnEnterValue")&&KG.statechart.sendAction("sendNotificationAction")}}),Ember.TEMPLATES["notification-panel"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f;return b.buffer.push("\n\t\t"),e={},f="capsule-label",e["class"]=f,f="KG.notificationsController.hasNotification",e.isVisibleBinding=f,f=d.view||a.view,l=m.program(2,t,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push('\n\t\t<span class="button-image"><span>\n\t\t'),e={},f="super-notification-popup",e.id=f,f="KG.notificationsController.activePopup",e.isVisibleBinding=f,f=d.view||a.view,l=m.program(4,u,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t"),e=a,f="parentView.notificationCount",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t"),c}function u(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t\t"),e={},f="notification-popup",e.id=f,f=d.view||a.view,l=m.program(5,v,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t"),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t"),e={},f="notification-label",e.id=f,f=d.view||a.view,l=m.program(6,w,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="notification-send-button",g.id=h,h="span",g.tagName=h,h="white-button unselectable",g["class"]=h,h="KG.notificationsController.hasNotification",g.classBinding=h,h="sendTextNotificationAction",g.sc_action=h,h=d.view||a.view,l=m.program(8,x,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="notification-clear-button",g.id=h,h="span",g.tagName=h,h="red-button unselectable",g["class"]=h,h="KG.notificationsController.hasNotification",g.isVisibleBinding=h,h="clearNotificationAction",g.sc_action=h,h=d.view||a.view,l=m.program(10,y,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\t\t\t\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t"),e={},f="notification-collection",e.id=f,f="KG.notificationsController.content",e.contentBinding=f,f=d.collection||a.collection,l=m.program(12,z,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t"),c}function w(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="_notificationTitle",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"\n\t\t\t\t\t\t\t"),c}function x(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="_notificationSendText",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"\n\t\t\t\t\t\t\t"),c}function y(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="_notificationClear",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"\n\t\t\t\t\t\t\t"),c}function z(a,b){var c="",e,f,g,h;return b.buffer.push("\t\t\t\t\t\n\t\t\t\t\t\t\t\t"),e=a,f="KG.NotificationView",g={},h="notification-item",g["class"]=h,h=d.view||a.view,l=m.program(13,A,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t"),c}function A(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e={},f="notification-item-title",e["class"]=f,f=d.view||a.view,l=m.program(14,B,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e={},f="notification-item-message",e["class"]=f,f=d.view||a.view,l=m.program(16,C,b),l.hash=e,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=b,typeof f===n?e=f.call(a,l):e=r.call(a,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t"),c}function B(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t<a "),e={},f="parentView.authorMailTo",e.href=f,f=d.bindAttr||a.bindAttr,l={},l.hash=e,l.contexts=[],l.data=b,typeof f===n?e=f.call(a,l):f===p?e=o.call(a,"bindAttr",l):e=f,b.buffer.push(q(e)+"> "),e=a,f="parentView.authorValue",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</a>"),e=a,f="parentView.titleValue",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)),e=a,f="parentView.dateValue",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t\t\t\t\t\t\t\t\t"),c}function C(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t\t<!-- triple brakets to unescape HTML -->\n\t\t\t\t\t\t\t\t\t\t"),e=a,f="parentView.messageValue",g=d._triageMustache||a._triageMustache,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"_triageMustache",f,l):e=g,(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return h=c,i="KG.Button",j={},k="notification-button",j.id=k,k="div",j.tagName=k,k="toggleNotificationPopupAction",j.sc_action=k,k="header-button header-button-icon",j["class"]=k,k="KG.notificationsController.activePopup",j.classBinding=k,k="KG.notificationsController.length",j.notificationCountBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\t\t\t\n"),g}),KG.core_bookmark=SC.Object.create({loadBookmarks:function(){var a=KG.store.find(KG.BOOKMARK_QUERY);KG.bookmarksController.set("content",a),a.onReady(this,this._bmReady)},refreshBookmarks:function(){KG.bookmarksController.get("content").refresh()},_bmReady:function(a){},gotoBookmark:function(a){if(a){var b=a.get("center"),c=a.get("zoom");if(b){var d=KG.LonLat.create({lon:b.x,lat:b.y});KG.core_leaflet.setCenter(d,c)}}},deleteSelectedBookmarks:function(){var a=KG.bookmarksController.get("deleteList");if(a&&a.get("length")>0){var b=[];a.forEach(function(a){var c=a.get("storeKey");b.push(c),a.destroy()}),KG.store.commitRecords(null,null,b)}},addBookmark:function(a,b,c){var d={x:b.get("lon"),y:b.get("lat")},e=KG.store.createRecord(KG.Bookmark,{label:a,center:d,zoom:c});KG.store.commitRecords(null,null,[e.get("storeKey")])}}),KG.bookmarksController=Ember.ArrayController.create({content:[],activePopup:NO,editMode:NO,deleteList:[]}),KG.addBookmarkController=SC.Object.create({showing:NO,content:"",addBookmarkLabel:function(){return"_bookmarkDialogTitle".loc()}.property(),closeTitle:function(){return"_bookmarkCloseDialogTitle".loc()}.property(),addLabel:function(){return"_bookmarkAdd".loc()}.property()}),KG.BookmarkButtonView=KG.Button.extend({bmPath:"css/images/bookmark.png",bmActivePath:"css/images/bookmark.png",activatedBinding:"KG.bookmarksController.activePopup",bookmarkImg:function(){return this.get("activated")?this.get("bmActivePath"):this.get("bmPath")}.property("activated")}),KG.EditBookmarkButtonView=KG.Button.extend({postAction:function(){this.set("isActive",KG.bookmarksController.get("editMode"))},editModeDidChange:function(){this.postAction()}.observes("KG.bookmarksController.editMode")}),KG.BookmarkItemView=KG.Button.extend({classNames:["bookmark-item","common-list-button"],tagName:"div"}),KG.BookmarkDeleteButtonView=KG.Button.extend({classNameBindings:["isAvailable:is-visible"],isAvailable:function(){var a=this.getPath("itemView.content");if(a&&KG.bookmarksController.get("editMode")){var b=a.get("user_create");if(!b||b===KG.core_auth.get("activeUser").id||KG.core_sandbox.get("isSandboxOwner"))return YES}return NO}.property("itemView.content","KG.bookmarksController.editMode"),isChecked:NO,deleteListDidChange:function(){var a=this.getPath("itemView.content");KG.bookmarksController.get("deleteList").indexOf(a)>-1?this.set("isChecked",YES):this.set("isChecked",NO)}.observes("itemView.content","KG.bookmarksController.deleteList.length")}),Ember.TEMPLATES["bookmark-panel"]=Handlebars.template(function(b,c,d,e,f){function r(a,b){var c="",e,f;return b.buffer.push('\n\t\t<span class="button-image"><span>\t\n\t\t'),e={},f="super-bookmark-popup",e.id=f,f="KG.bookmarksController.activePopup",e.isVisibleBinding=f,f=d.view||a.view,k=l.program(2,s,b),k.hash=e,k.contexts=[],k.fn=k,k.inverse=l.noop,k.data=b,typeof f===m?e=f.call(a,k):e=q.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n"),c}function s(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t"),e={},f="bookmark-popup",e.id=f,f="KG.bookmarksController.activePopup",e.isVisibleBinding=f,f=d.view||a.view,k=l.program(3,t,b),k.hash=e,k.contexts=[],k.fn=k,k.inverse=l.noop,k.data=b,typeof f===m?e=f.call(a,k):e=q.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t"),c}function t(a,b){var c="",e,f,g,h;return b.buffer.push('\t\t\t\t\t\t\n\t\t\t\t\t\t<div id="bookmark-top-bar">\n\t\t\t\t\t\t\t'),e=a,f="_bookmarkTitle",g={},h="bookmark-label",g.id=h,h="div",g.tagName=h,h=d.loc||a.loc,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"loc",f,k):e=h,b.buffer.push(p(e)+"\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="bookmark-add-button",g.id=h,h="div",g.tagName=h,h="white-button unselectable",g["class"]=h,h="addBookmarkAction",g.sc_action=h,h=d.view||a.view,k=l.program(4,u,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="bookmark-delete-button",g.id=h,h="div",g.tagName=h,h="red-button unselectable",g["class"]=h,h="deleteBookmarkAction",g.sc_action=h,h="KG.bookmarksController.editMode",g.classBinding=h,h=d.view||a.view,k=l.program(6,v,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t"),e=a,f="KG.EditBookmarkButtonView",g={},h="bookmark-edit-button",g.id=h,h="div",g.tagName=h,h="white-button unselectable",g["class"]=h,h="editBookmarkAction",g.sc_action=h,h=d.view||a.view,k=l.program(8,w,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push('\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div id="bookmark-collection">\n\t\t\t\t\t\t'),e={},f="bookmark-list",e.id=f,f="KG.bookmarksController.content",e.contentBinding=f,f="KG.BookmarkItemView",e.itemViewClass=f,f="KG.bookmarksController.editMode",e.classBinding=f,f=d.collection||a.collection,k=l.program(10,x,b),k.hash=e,k.contexts=[],k.fn=k,k.inverse=l.noop,k.data=b,typeof f===m?e=f.call(a,k):e=q.call(a,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t</div>\n\t\t\t\t\t"),c}function u(a,b){b.buffer.push("\n\t\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t")}function v(a,b){var c="",e,f,g;return b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="_delete",g=d.loc||a.loc,k={},k.hash={},k.contexts=[],k.contexts.push(e),k.data=b,typeof g===m?e=g.call(a,f,k):g===o?e=n.call(a,"loc",f,k):e=g,b.buffer.push(p(e)+"\n\t\t\t\t\t\t\t"),c}function w(a,b){b.buffer.push("\n\t\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t\t")}function x(a,b){var c="",e,f,g,h;return b.buffer.push("\t\n\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="bookmark-item-label",g["class"]=h,h="div",g.tagName=h,h="selectBookmarkAction",g.sc_action=h,h=d.view||a.view,k=l.program(11,y,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t"),e=a,f="KG.Button",g={},h="bookmark-item-author",g["class"]=h,h="span",g.tagName=h,h="selectBookmarkAction",g.sc_action=h,h=d.view||a.view,k=l.program(13,z,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t\t"),e=a,f="KG.BookmarkDeleteButtonView",g={},h="bookmark-delete check-delete-button unselectable",g["class"]=h,h="isChecked",g.classBinding=h,h="checkBookmarkAction",g.sc_action=h,h=d.view||a.view,k=l.program(15,A,b),k.hash=g,k.contexts=[],k.contexts.push(e),k.fn=k,k.inverse=l.noop,k.data=b,typeof h===m?e=h.call(a,f,k):e=q.call(a,h,f,k),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t"),c}function y(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.label",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"_triageMustache",f,k):e=h,b.buffer.push(p(e)+"\n\t\t\t\t\t\t\t\t"),c}function z(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t\t\t"),e=a,f="itemView.content.formattedDescription",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,k={},k.hash=g,k.contexts=[],k.contexts.push(e),k.data=b,typeof h===m?e=h.call(a,f,k):h===o?e=n.call(a,"_triageMustache",f,k):e=h,b.buffer.push(p(e)+"\n\t\t\t\t\t\t\t\t"),c}function A(a,b){b.buffer.push("\n\t\t\t\t\t\t\t\t\t<span>✓</span>\n\t\t\t\t\t\t\t\t")}d=d||Ember.Handlebars.helpers;var g,h,i,j,k,l=this,m="function",n=d.helperMissing,o=void 0,p=this.escapeExpression,q=d.blockHelperMissing;g=c,h="KG.Button",i={},j="bookmark-button",i.id=j,j="div",i.tagName=j,j="toggleBookmarkPopupAction",i.sc_action=j,j="header-button header-button-icon",i["class"]=j,j="KG.bookmarksController.activePopup",i.classBinding=j,j=d.view||c.view,k=l.program(1,r,f),k.hash=i,k.contexts=[],k.contexts.push(g),k.fn=k,k.inverse=l.noop,k.data=f,typeof j===m?g=j.call(c,h,k):g=q.call(c,j,h,k),g||g===0?f.buffer.push(g):f.buffer.push("")}),Ember.TEMPLATES["add-bookmark"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t"),e=a,f="KG.addBookmarkController.addLabel",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"\n\t"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<div id="add-bookmark-panel">\n\t'),h=c,i="KG.addBookmarkController.addBookmarkLabel",j={},k="true",j.escaped=k,k=d._triageMustache||c._triageMustache,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"_triageMustache",i,l):h=k,f.buffer.push(q(h)+"\n\t"),h=c,i="KG.Button",j={},k="x-button bookmark-close-button",j["class"]=k,k="closeAddBookmarkAction",j.sc_action=k,k="KG.addBookmarkController.closeTitle",j.titleBinding=k,k=d.view||c.view,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"view",i,l):h=k,f.buffer.push(q(h)+"\n\t"),h=c,i="KG.TextField",j={},k="KG.addBookmarkController.content",j.valueBinding=k,k="addBookmarkAction",j.nl_sc_action=k,k=d.view||c.view,l={},l.hash=j,l.contexts=[],l.contexts.push(h),l.data=f,typeof k===n?h=k.call(c,i,l):k===p?h=o.call(c,"view",i,l):h=k,f.buffer.push(q(h)+"\n\t"),h=c,i="KG.Button",j={},k="white-button add-bookmark-button",j["class"]=k,k="addBookmarkAction",j.sc_action=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\t\t\n</div>"),g})