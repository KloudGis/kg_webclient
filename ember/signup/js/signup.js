/*
 Copyright (c) 2010-2011, XYZ Civitas
 Kloudgis.
 http://kloudgis.com
*/
KG=Ember.Application.create({lang:"fr",serverHost:"/"}),Handlebars.registerHelper("loc",function(a,b){var c=a.loc();if(b.hash.id){var d=b.hash.tagName||"span";return new Handlebars.SafeString("<"+d+' id="'+b.hash.id+'">'+c+"</"+d+">")}if(b.hash.class){var d=b.hash.tagName||"span";return new Handlebars.SafeString("<"+d+' class="'+b.hash.class+'">'+c+"</"+d+">")}if(b.hash.tagName){var d=b.hash.tagName;return new Handlebars.SafeString("<"+d+">"+c+"</"+d+">")}return c});var fr={_signupTitle:"Kloudgis - Compte",_Empty:"Le champ est obligatoire.",_signupKloudgis:"Créer un compte Kloudgis",_serverError:"Erreur du serveur",_nullTokenError:"Erreur lors de l'authentification.",_pwdMinLength:"Doit contenir au minimum 6 caractères.",_email:"Courriel",_pwd:"Mot de passe",_name:"Nom complet",_company:"Compagnie",_location:"Emplacement",_createAccount:"Créer",_InUse:"Ce courriel est déjà utilisé.",_invalid:"Le courriel est invalide.",_correctErrorFirst:"Veuillez corriger les erreurs pour continuer."},en={_signupTitle:"Kloudgis - Account",_Empty:"This field is required.",_signupKloudgis:"Signup to Kloudgis",_serverError:"Server error.",_nullTokenError:"Authentification error.",_pwdMinLength:"Must contained atleast 6 characters.",_email:"Email",_pwd:"Password",_name:"Full Name",_company:"Company",_location:"Location",_createAccount:"Create",_InUse:"This email is already taken.",_invalid:"This email is not valid.",_correctErrorFirst:"Please fix the error to continue."};KG.lang==="fr"?SC.STRINGS=fr:SC.STRINGS=en,SC.run.schedule("render",null,function(){console.log("localize page"),document.title="_signupTitle".loc(),$("#kloud-welcome").text("_signupKloudgis".loc()),$("#email-label").text("_email".loc()),$("#pwd-label").text("_pwd".loc()),$("#name-label").text("_name".loc()),$("#company-label").text("_company".loc()),$("#location-label").text("_location".loc()),$("#create-button").text("_createAccount".loc())});var get=SC.get;KG.Button=SC.Button.extend({attributeBindings:["type","disabled","title"],triggerAction:function(){this._super();var a=get(this,"sc_action");a&&KG.statechart&&(KG.statechart.sendAction(a,this.get("content")||this.getPath("itemView.content")),this.postAction&&this.postAction())},manualMouseDown:NO,_mouseDownListener:null,_element:null,didInsertElement:function(){if(this.get("manualMouseDown")){this._element=this.get("element");var a=this;this._mouseDownListener=function(b){return a.mouseDown(b)},this._clickListener=function(b){return a.click(b)},this._element.addEventListener("mousedown",this._mouseDownListener,!1),this._element.addEventListener("click",this._clickListener,!1)}},destroy:function(){if(get(this,"isDestroyed"))return;this.get("manualMouseDown")&&this._element&&(this._element.removeEventListener("mousedown",this._mouseDownListener,!1),this._element.removeEventListener("click",this._clickListener,!1),this._element=null),this._super()}}),KG.ForwardTextField=SC.TextField.extend({attributeBindings:["type","placeholder","value","autocapitalize","autocorrect"],focusOut:function(a){return this._super(a),!0},change:function(a){return this._super(a),!0},keyUp:function(a){return this._super(a),!0}}),KG.LoadingImageView=SC.View.extend({classNames:"loading-image".w(),loadingImage:"resources/images/loading.gif"}),KG.SignupField=SC.View.extend({classNames:"signup-field".w(),focus:NO,focusIn:function(a){return this.set("focus",YES),KG.statechart.sendAction("focusInEvent",this,a),YES},focusOut:function(a){return this.set("focus",NO),KG.statechart.sendAction("focusOutEvent",this,a),NO},keyDown:function(a){return YES},keyUp:function(a){return a.keyCode==13&&KG.statechart.sendAction("newLineEvent",this,a),NO}}),Ember.TEMPLATES["signup-page"]=Handlebars.template(function(b,c,d,e,f){function s(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t\t\t\t\t<label id="email-label" for="user-textfield">'),e=a,f="_email",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"</label>\n\t\t\t\t\t\t\t"),e=a,f="KG.ForwardTextField",g={},h="user-textfield",g.id=h,h="KG.userFieldController.value",g.valueBinding=h,h="email",g.type=h,h="_UserHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h="true",g.autofocus=h,h=d.view||a.view,l=m.program(2,t,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="KG.userFieldController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\t\t\t\t\t\t\n\t\t\t\t\t\t\t"),e=a,f="KG.LoadingImageView",g={},h="KG.userFieldController.isBusy",g.isVisibleBinding=h,h=d.view||a.view,l=m.program(4,u,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t"),c}function t(a,b){b.buffer.push("\n\t\t\t\t\t\t\t")}function u(a,b){var c="",e,f;return b.buffer.push("\n\t\t\t\t\t\t\t\t<img "),e={},f="loadingImage",e.src=f,f=d.bindAttr||a.bindAttr,l={},l.hash=e,l.contexts=[],l.data=b,typeof f===n?e=f.call(a,l):f===p?e=o.call(a,"bindAttr",l):e=f,b.buffer.push(q(e)+' alt="Loading"/>\n\t\t\t\t\t\t\t'),c}function v(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t\t\t\t\t<label id="pwd-label" for="pwd-textfield">'),e=a,f="_pwd",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"</label>\n\t\t\t\t\t\t\t"),e=a,f="KG.ForwardTextField",g={},h="pwd-textfield",g.id=h,h="KG.pwdFieldController.value",g.valueBinding=h,h="password",g.type=h,h="_PwdHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h=d.view||a.view,l=m.program(7,w,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="KG.pwdFieldController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\t\t\t\t\t\t\n\t\t\t\t\t\t"),c}function w(a,b){b.buffer.push("\n\t\t\t\t\t\t\t")}function x(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t\t\t\t\t<label id="name-label" for="name-textfield">'),e=a,f="_name",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"</label>\n\t\t\t\t\t\t\t"),e=a,f="KG.ForwardTextField",g={},h="name-textfield",g.id=h,h="KG.nameFieldController.value",g.valueBinding=h,h="text",g.type=h,h="_NameHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h=d.view||a.view,l=m.program(10,y,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="KG.nameFieldController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\t\t\t\t\t\n\t\t\t\t\t\t"),c}function y(a,b){b.buffer.push("\n\t\t\t\t\t\t\t")}function z(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t\t\t\t\t<label id="company-label" for="company-textfield">'),e=a,f="_company",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"</label>\n\t\t\t\t\t\t\t"),e=a,f="KG.ForwardTextField",g={},h="company-textfield",g.id=h,h="KG.companyFieldController.value",g.valueBinding=h,h="text",g.type=h,h="_CompanyHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h=d.view||a.view,l=m.program(13,A,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="KG.companyFieldController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\t\t\t\t\n\t\t\t\t\t\t"),c}function A(a,b){b.buffer.push("\n\t\t\t\t\t\t\t")}function B(a,b){var c="",e,f,g,h;return b.buffer.push('\n\t\t\t\t\t\t\t<label id="location-label" for="location-textfield">'),e=a,f="_location",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"</label>\n\t\t\t\t\t\t\t"),e=a,f="KG.ForwardTextField",g={},h="location-textfield",g.id=h,h="KG.locationFieldController.value",g.valueBinding=h,h="text",g.type=h,h="_LocationHint",g.placeholder_not_loc=h,h="false",g.spellcheck=h,h="off",g.autocorrect=h,h="off",g.autocapitalize=h,h=d.view||a.view,l=m.program(16,C,b),l.hash=g,l.contexts=[],l.contexts.push(e),l.fn=l,l.inverse=m.noop,l.data=b,typeof h===n?e=h.call(a,f,l):e=r.call(a,h,f,l),(e||e===0)&&b.buffer.push(e),b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="KG.locationFieldController.errorMessage",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\t\t\t\t\t\t\n\t\t\t\t\t\t"),c}function C(a,b){b.buffer.push("\n\t\t\t\t\t\t\t")}function D(a,b){var c="",e,f,g;return b.buffer.push("\n                            "),e=a,f="_createAccount",g=d.loc||a.loc,l={},l.hash={},l.contexts=[],l.contexts.push(e),l.data=b,typeof g===n?e=g.call(a,f,l):g===p?e=o.call(a,"loc",f,l):e=g,b.buffer.push(q(e)+"\t\t\t\t\t\t\n\t\t\t\t\t\t"),c}function E(a,b){var c="",e,f,g,h;return b.buffer.push("\n\t\t\t\t\t\t\t<span>"),e=a,f="message",g={},h="true",g.escaped=h,h=d._triageMustache||a._triageMustache,l={},l.hash=g,l.contexts=[],l.contexts.push(e),l.data=b,typeof h===n?e=h.call(a,f,l):h===p?e=o.call(a,"_triageMustache",f,l):e=h,b.buffer.push(q(e)+"</span>\n\t\t\t\t\t\t"),c}d=d||Ember.Handlebars.helpers;var g="",h,i,j,k,l,m=this,n="function",o=d.helperMissing,p=void 0,q=this.escapeExpression,r=d.blockHelperMissing;return f.buffer.push('<a  id="kloud-logo" href="/kloudgis">\n\t\t\t<img src="css/images/kloudgis_black_128.png" alt="Kloudgis"/>\n\t\t</a>\n\t\t<span id="kloud-welcome">'),h=c,i="_signupTitle",j=d.loc||c.loc,l={},l.hash={},l.contexts=[],l.contexts.push(h),l.data=f,typeof j===n?h=j.call(c,i,l):j===p?h=o.call(c,"loc",i,l):h=j,f.buffer.push(q(h)+'\t</span>\n\t\t<div class="signup-pane">\n\t\t\t<table>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.SignupField",j={},k="user-field",j.id=k,k="focus hasError",j.classBinding=k,k="KG.userFieldController.hasError",j.hasErrorBinding=k,k=d.view||c.view,l=m.program(1,s,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\t\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.SignupField",j={},k="pwd-field",j.id=k,k="focus hasError",j.classBinding=k,k="KG.pwdFieldController.hasError",j.hasErrorBinding=k,k=d.view||c.view,l=m.program(6,v,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\t\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.SignupField",j={},k="name-field",j.id=k,k="focus hasError",j.classBinding=k,k="KG.nameFieldController.hasError",j.hasErrorBinding=k,k=d.view||c.view,l=m.program(9,x,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\t\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.SignupField",j={},k="company-field",j.id=k,k="focus hasError",j.classBinding=k,k="KG.companyFieldController.hasError",j.hasErrorBinding=k,k=d.view||c.view,l=m.program(12,z,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\t\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.SignupField",j={},k="location-field",j.id=k,k="focus hasError",j.classBinding=k,k="KG.locationFieldController.hasError",j.hasErrorBinding=k,k=d.view||c.view,l=m.program(15,B,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\t\n\t\t\t\t\t</td>\n\t\t\t</tr>\t\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h=c,i="KG.Button",j={},k="createAccountAction",j.sc_action=k,k="create-button",j.id=k,k=d.view||c.view,l=m.program(18,D,f),l.hash=j,l.contexts=[],l.contexts.push(h),l.fn=l,l.inverse=m.noop,l.data=f,typeof k===n?h=k.call(c,i,l):h=r.call(c,k,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push('\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t<tr class="section">\n\t\t\t\t\t<td>\n\t\t\t\t\t\t'),h={},i="KG.core_signup.globalError",h.messageBinding=i,i="global-error",h.id=i,i=d.view||c.view,l=m.program(20,E,f),l.hash=h,l.contexts=[],l.fn=l,l.inverse=m.noop,l.data=f,typeof i===n?h=i.call(c,l):h=r.call(c,i,l),(h||h===0)&&f.buffer.push(h),f.buffer.push("\n\t\t\t\t\t</td>\n\t\t\t</tr>\n\t\t\t</table>\n\t\t</div>"),g}),KG.core_signup=SC.Object.create({globalError:"",createAccount:function(){this.validateAllExceptUser(),this.validateUser(this,this.createUserCallback())},createUserCallback:function(){var a=KG.fields.findProperty("isValid",NO);if(!a){this.set("globalError","");var b={user:KG.userFieldController.get("value"),pwd:SHA256(KG.pwdFieldController.get("value")),name:KG.nameFieldController.get("value"),company:KG.companyFieldController.get("value"),location:KG.locationFieldController.get("value")};$.ajax({type:"POST",url:KG.get("serverHost")+"api_auth/public/register",data:JSON.stringify(b),dataType:"json",contentType:"application/json; charset=utf-8",context:this,error:function(){this.set("globalError","_serverError".loc())},success:function(a){console.log(a),a.content=="_success"?window.location.href="/kloudgis?user="+KG.userFieldController.get("value"):this.set("globalError",a.content.loc())},async:YES})}else this.set("globalError","_correctErrorFirst".loc())},validateUser:function(a,b){KG.userFieldController.validate(a,b)},validateAllExceptUser:function(){for(i=1;i<KG.fields.length;i++)KG.fields[i].validate()}}),KG.FieldController=SC.Object.extend({value:undefined,hasError:NO,isBusy:NO,errorMessage:"",validate:function(){this.setError()},setError:function(a){SC.none(a)?(this.set("hasError",NO),this.set("errorMessage","")):(this.set("hasError",YES),this.set("errorMessage",a))},isValid:function(){return!this.get("hasError")&&!this.get("isBusy")}.property("hasError","isBusy")}),KG.userFieldController=KG.FieldController.create({validate:function(a,b){if(jQuery("#user-textfield")[0].validationMessage!="")this.setError("_invalid".loc()),b&&this.cb.call(this.cb_target);else{var c=this.get("value");this.set("isBusy",YES);var d=KG.get("serverHost")+"api_auth/public/register/test_email",e={callbackTarget:a,callbackFunction:b,field:this,doCallback:function(){this.field.set("isBusy",NO),SC.none(this.callbackFunction)||this.callbackFunction.call(this.callbackTarget)}};$.ajax({type:"POST",url:d,data:c,dataType:"json",contentType:"application/json; charset=utf-8",context:e,error:this.ajaxError,success:this.ajaxSuccess,async:YES})}},ajaxError:function(){this.field.setError("_serverError".loc()),this.doCallback()},ajaxSuccess:function(a){a.content==="Accepted"?this.field.setError():this.field.setError(a.content.loc()),this.doCallback()}}),KG.pwdFieldController=KG.FieldController.create({validate:function(){var a=this.get("value");SC.none(a)?this.setError("_Empty".loc()):a.length<6?this.setError("_pwdMinLength".loc()):this.setError()}}),KG.nameFieldController=KG.FieldController.create(),KG.companyFieldController=KG.FieldController.create(),KG.locationFieldController=KG.FieldController.create(),KG.fields=[KG.userFieldController,KG.pwdFieldController,KG.nameFieldController,KG.companyFieldController,KG.locationFieldController],$(document).ready(function(){KG.statechart.initStatechart()}),SC.mixin(KG,{statechart:SC.Statechart.create({trace:NO,rootState:SC.State.extend({initialSubstate:"startupState",startupState:SC.State.extend({enterState:function(){console.log("enter signup")}}),userFieldFocusState:SC.State.extend({enterState:function(){console.log("enter user field")},focusOutEvent:function(){this._validate()},newLineEvent:function(){console.log("newline"),this._validate()},_validate:function(){KG.core_signup.validateUser()}}),otherFieldFocusState:SC.State.extend({enterState:function(){console.log("enter other field")},focusOutEvent:function(){KG.core_signup.validateAllExceptUser()},newLineEvent:function(){KG.core_signup.validateAllExceptUser()}}),createAccountAction:function(){KG.core_signup.createAccount()},focusInEvent:function(a,b){var c=a.get("elementId");console.log("focus in "+c),c==="user-field"?this.gotoState("userFieldFocusState"):this.gotoState("otherFieldFocusState")}})})})